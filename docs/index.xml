<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>Julius&#39;s Blog</title>
<link>https://jbogomolovas2.github.io/Julius-s-Blog/</link>
<atom:link href="https://jbogomolovas2.github.io/Julius-s-Blog/index.xml" rel="self" type="application/rss+xml"/>
<description>Data Analytics, Biology, and R Programming</description>
<image>
<url>https://jbogomolovas2.github.io/Julius-s-Blog/profile.jpg</url>
<title>Julius&#39;s Blog</title>
<link>https://jbogomolovas2.github.io/Julius-s-Blog/</link>
</image>
<generator>quarto-1.7.32</generator>
<lastBuildDate>Mon, 23 Jun 2025 07:00:00 GMT</lastBuildDate>
<item>
  <title>Swimming speed Analysis With Generalized Additive Models</title>
  <dc:creator>Julius Bogomolovas</dc:creator>
  <link>https://jbogomolovas2.github.io/Julius-s-Blog/posts/post-with-code/</link>
  <description><![CDATA[ 





<p>As a swimmer seeking to enhance performance, tracking workout data can offer valuable insights into progress over time. Analysis options for swimming compared to running in Garmin are instead week. I enjoy swimming and data analysis. In this analysis, I’ll explore several years of swimming data extracted from Garmin FIT files to figure out if I am getting faster.&nbsp;</p>
<section id="data-extraction-from-fit-files" class="level2">
<h2 class="anchored" data-anchor-id="data-extraction-from-fit-files">Data Extraction from FIT Files</h2>
<p>First, I’ll extract swimming data from all available FIT files. The <code>FITfileR</code> <span class="citation" data-cites="FITfileR">(Smith 2025)</span> package allows us to read Garmin workout files and identify pool swimming sessions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(FITfileR)</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)</span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(purrr)</span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(utils)</span>
<span id="cb1-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)</span>
<span id="cb1-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(hexbin)</span>
<span id="cb1-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(viridis)</span>
<span id="cb1-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(gratia)</span>
<span id="cb1-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(mgcv)</span>
<span id="cb1-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyr)</span>
<span id="cb1-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(performance)</span>
<span id="cb1-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(lubridate)</span></code></pre></div>
</div>
<section id="identifying-pool-swimming-sessions" class="level3">
<h3 class="anchored" data-anchor-id="identifying-pool-swimming-sessions">Identifying Pool Swimming Sessions</h3>
<p>So, one can ask Garmin to download all the files. Swim session or activity files are stored in .fit format and located in the DI_CONNECT folder, specifically in the subfolder DI-Connect-Uploaded-Files. File names are rather cryptical, so I first look for files that have “lap_swimming” attribute within.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Scan directory for all .fit files</span></span>
<span id="cb2-2">all_files <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list.files</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/Users/jb/Documents/BW_analysis/Swim"</span>,</span>
<span id="cb2-3">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pattern    =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">.fit$"</span>,</span>
<span id="cb2-4">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">full.names =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb2-5"></span>
<span id="cb2-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check each file to identify pool swimming sessions</span></span>
<span id="cb2-7">n  <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(all_files)</span>
<span id="cb2-8">ok <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">logical</span>(n)</span>
<span id="cb2-9">pb <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">txtProgressBar</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">min =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">max =</span> n, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">style =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span>
<span id="cb2-10"></span>
<span id="cb2-11"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> (i <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_along</span>(all_files)) {</span>
<span id="cb2-12">  path <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> all_files[i]</span>
<span id="cb2-13">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Safely check if file contains pool swimming data</span></span>
<span id="cb2-14">  ok[i] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">possibly</span>(<span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(p) {</span>
<span id="cb2-15">    sp <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">getMessagesByType</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readFitFile</span>(p), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sport"</span>)</span>
<span id="cb2-16">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">isTRUE</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">any</span>(sp<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>sport <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"swimming"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> sp<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>sub_sport <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lap_swimming"</span>,</span>
<span id="cb2-17">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.rm =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>))</span>
<span id="cb2-18">  }, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">otherwise =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)(path)</span>
<span id="cb2-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setTxtProgressBar</span>(pb, i)</span>
<span id="cb2-20">}</span>
<span id="cb2-21"></span>
<span id="cb2-22"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">close</span>(pb)</span>
<span id="cb2-23"></span>
<span id="cb2-24">pool_lap_fits <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> all_files[ok]</span>
<span id="cb2-25"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Found"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(pool_lap_fits), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pool-lap swim files</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
</div>
</section>
<section id="extracting-session-information" class="level3">
<h3 class="anchored" data-anchor-id="extracting-session-information">Extracting Session Information</h3>
<p>Now, by examining several <code>lap_swimming</code> attributes containing files, I found that pool length in meters and activity data are stored in <code>session</code>, and <code>length</code> contains the workout information.&nbsp;</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">sessions <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map_dfr</span>(pool_lap_fits, <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(f) {</span>
<span id="cb3-2">  sess <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tryCatch</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">getMessagesByType</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readFitFile</span>(f), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"session"</span>),</span>
<span id="cb3-3">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">error =</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(e) <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>)</span>
<span id="cb3-4">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.null</span>(sess)) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>)</span>
<span id="cb3-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(</span>
<span id="cb3-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">file          =</span> f,</span>
<span id="cb3-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">session_date  =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.Date</span>(sess<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>start_time),</span>
<span id="cb3-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pool_length   =</span> sess<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>pool_length</span>
<span id="cb3-9">  )</span>
<span id="cb3-10">}) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(session_date) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">session_number =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">row_number</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>()</span>
<span id="cb3-14"></span>
<span id="cb3-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Extract individual length (lap) data</span></span>
<span id="cb3-16">raw_laps <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map_dfr</span>(pool_lap_fits, <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(f) {</span>
<span id="cb3-17">  lengths <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tryCatch</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">getMessagesByType</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readFitFile</span>(f), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"length"</span>),</span>
<span id="cb3-18">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">error =</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(e) <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>)</span>
<span id="cb3-19">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.null</span>(lengths)) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>)</span>
<span id="cb3-20">  lengths <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">file =</span> f)</span>
<span id="cb3-21">})</span></code></pre></div>
</div>
</section>
</section>
<section id="data-processing-and-set-detection" class="level2">
<h2 class="anchored" data-anchor-id="data-processing-and-set-detection">Data Processing and Set Detection</h2>
<p>Swimming workouts typically consist of multiple sets with rest periods between each set. I’ll identify these sets and calculate the relative positions of each lap within the workout and set itself:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#Identify sets based on idle periods</span></span>
<span id="cb4-2">laps_with_sets <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> raw_laps <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb4-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(file) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb4-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb4-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lap_index          =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">row_number</span>(),</span>
<span id="cb4-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">total_laps         =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>(),</span>
<span id="cb4-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pos_within_workout =</span> lap_index <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> total_laps,</span>
<span id="cb4-8">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># New set starts after each idle period</span></span>
<span id="cb4-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">set_id             =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cumsum</span>(length_type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"idle"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb4-10">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb4-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>()</span>
<span id="cb4-12"></span>
<span id="cb4-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Process active laps only and calculate set-specific metrics</span></span>
<span id="cb4-14">final_tbl <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> laps_with_sets <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb4-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(length_type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"active"</span>, swim_stroke <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"drill"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb4-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(file, set_id) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb4-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb4-18">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lap_in_set     =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">row_number</span>(),</span>
<span id="cb4-19">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">set_size       =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>(),</span>
<span id="cb4-20">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pos_within_set =</span> lap_in_set <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> set_size</span>
<span id="cb4-21">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb4-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb4-23">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(sessions, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"file"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb4-24">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(</span>
<span id="cb4-25">    session_date,</span>
<span id="cb4-26">    session_number,</span>
<span id="cb4-27">    pool_length,</span>
<span id="cb4-28">    total_elapsed_time,</span>
<span id="cb4-29">    set_id,</span>
<span id="cb4-30">    lap_index,</span>
<span id="cb4-31">    lap_in_set,</span>
<span id="cb4-32">    pos_within_workout,</span>
<span id="cb4-33">    pos_within_set,</span>
<span id="cb4-34">    swim_stroke</span>
<span id="cb4-35">  )</span>
<span id="cb4-36"></span>
<span id="cb4-37"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save processed data</span></span>
<span id="cb4-38"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write.csv</span>(final_tbl, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"all_swim_laps.csv"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">row.names =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)</span></code></pre></div>
</div>
<p>You can load it directly in <code>R</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">final_tbl <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read.csv</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://jbogomolovas2.github.io/julius-blog/posts/post-with-code/all_swim_laps.csv"</span>)</span></code></pre></div>
</div>
<p>I’ll identify gaps in training and analyze data from July 2020 onward to have a nice, recent, and consistent training segment to analyze.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Identify training gaps</span></span>
<span id="cb6-2">sessions_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> final_tbl <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb6-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">distinct</span>(session_date) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb6-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(session_date)</span>
<span id="cb6-5"></span>
<span id="cb6-6">gaps_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sessions_df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb6-7">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1) make sure session_date is a Date</span></span>
<span id="cb6-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">session_date =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.Date</span>(session_date)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb6-9">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 2) grab the “previous” date</span></span>
<span id="cb6-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prev_date =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lag</span>(session_date)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb6-11">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 3) compute gap in days</span></span>
<span id="cb6-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">gap_days =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">difftime</span>(session_date, prev_date, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">units =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"days"</span>))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb6-13">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 4) drop the first row (where lag was NA)</span></span>
<span id="cb6-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(gap_days))</span>
<span id="cb6-15"></span>
<span id="cb6-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Show top 5 largest training gaps</span></span>
<span id="cb6-17">top5_gaps <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> gaps_df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb6-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">desc</span>(gap_days)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb6-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">slice</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb6-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(</span>
<span id="cb6-21">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">end_date   =</span> session_date,</span>
<span id="cb6-22">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">start_date =</span> prev_date</span>
<span id="cb6-23">  )</span>
<span id="cb6-24"></span>
<span id="cb6-25"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(top5_gaps)</span></code></pre></div>
</div>
<p>Let’s perform some data cleaning: select a segment, calculate swim speeds, remove super-fast laps (I wish they were real!), and create a simple time variable.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">final_tbl_2020 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> final_tbl <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb7-2">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1) ensure session_date is Date</span></span>
<span id="cb7-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">session_date =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.Date</span>(session_date)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb7-4">  </span>
<span id="cb7-5">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 2) filter from July 7, 2020 onward</span></span>
<span id="cb7-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(session_date <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ymd</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2020-07-07"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb7-7">  </span>
<span id="cb7-8">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 3) compute speed and factor columns</span></span>
<span id="cb7-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb7-10">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">speed       =</span> pool_length <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> total_elapsed_time,</span>
<span id="cb7-11">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">swim_stroke =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(swim_stroke),</span>
<span id="cb7-12">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">session_id  =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(session_date)   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># or combine with session_number if you need uniqueness</span></span>
<span id="cb7-13">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb7-14">  </span>
<span id="cb7-15">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 4) remove unrealistically fast laps</span></span>
<span id="cb7-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(speed <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb7-17">  </span>
<span id="cb7-18">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 5) sort and compute days since first session</span></span>
<span id="cb7-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(session_date) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb7-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb7-21">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">days_since_start =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.integer</span>(</span>
<span id="cb7-22">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">difftime</span>(session_date,</span>
<span id="cb7-23">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(session_date),</span>
<span id="cb7-24">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">units =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"days"</span>)</span>
<span id="cb7-25">    )</span>
<span id="cb7-26">  )</span></code></pre></div>
</div>
</section>
<section id="visualizing-speed-distributions" class="level2">
<h2 class="anchored" data-anchor-id="visualizing-speed-distributions">Visualizing Speed Distributions</h2>
<p>Let’s examine how swimming speed varies over time for different strokes. As I have a bunch of laps, let’s plot them as densities.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1">p_contour <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> final_tbl_2020, </span>
<span id="cb8-3">             <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> session_date, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> speed),</span>
<span id="cb8-4">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey50"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_density_2d</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> final_tbl_2020, </span>
<span id="cb8-6">                  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> session_date, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> speed),</span>
<span id="cb8-7">                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"darkblue"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bins =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> swim_stroke, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scales =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free_y"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Session Date"</span>,</span>
<span id="cb8-10">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Speed (m/s)"</span>,</span>
<span id="cb8-11">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Swimming Speed Over Time by Stroke Type"</span>,</span>
<span id="cb8-12">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Density contours showing speed distribution"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>,</span>
<span id="cb8-15">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.grid.minor =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(),</span>
<span id="cb8-16">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">strip.text =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>))</span>
<span id="cb8-17"></span>
<span id="cb8-18"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(p_contour)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://jbogomolovas2.github.io/Julius-s-Blog/posts/post-with-code/index_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="statistical-modeling-with-gams" class="level2">
<h2 class="anchored" data-anchor-id="statistical-modeling-with-gams">Statistical Modeling with GAMs</h2>
<p>I have something that is more or less monomodal. Therefore, my average swim speed would be a good indicator of my progress. However, in workouts, I do different sets, such as sprints, cooldowns, etc. Which vary in intensity, length, and position within the workout. I hypothesize that these factors significantly affect “average” swim speed and need to be accounted for. I don’t expect them to be linearly related, so I enter the magical world of Generalized Additive Models (GAMs). I will be using <code>mgcv</code> <span class="citation" data-cites="mgcv">(Wood 2011)</span>&nbsp;for fitting, <code>gratia</code> <span class="citation" data-cites="gratia">(Simpson 2024)</span>&nbsp;for visualization, and <code>performance</code>&nbsp;<span class="citation" data-cites="performance">(Lüdecke et al. 2021)</span>&nbsp;for model assessment. I will start with a simple&nbsp;speed ~ time&nbsp;model and try to add covariates to get a better fit, closer to “average” swim speed.&nbsp;As I am working with a rather large dataset, I will use&nbsp;the <code>bam</code>&nbsp;function and a few corresponding tweaks:&nbsp;<code>discrete = TRUE</code>&nbsp;and&nbsp;<code>method = "fREML"</code>&nbsp;which enables faster computation for extensive datasets. By examining the swimming speed distribution, I clearly see some tails, so I will use the scaled t-distribution&nbsp;<code>family = scat()</code>.&nbsp;</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Model 1: Simple time trend by stroke</span></span>
<span id="cb9-2">simple <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bam</span>(</span>
<span id="cb9-3">    speed <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> swim_stroke <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> pool_length <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb9-4">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">s</span>(days_since_start, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> swim_stroke, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bs =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gp"</span>),</span>
<span id="cb9-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data     =</span> final_tbl_2020,</span>
<span id="cb9-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">discrete =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,</span>
<span id="cb9-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family   =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scat</span>(),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Scaled t-distribution for robustness</span></span>
<span id="cb9-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method   =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fREML"</span></span>
<span id="cb9-9">)</span>
<span id="cb9-10"></span>
<span id="cb9-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Model 2: Add position effects (fatigue within workout/set)</span></span>
<span id="cb9-12">set_location <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bam</span>(</span>
<span id="cb9-13">    speed <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> swim_stroke <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> pool_length <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb9-14">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">s</span>(days_since_start, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> swim_stroke, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bs =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gp"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb9-15">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">s</span>(pos_within_workout, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> swim_stroke) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-16">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">s</span>(pos_within_set, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> swim_stroke),</span>
<span id="cb9-17">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data     =</span> final_tbl_2020,</span>
<span id="cb9-18">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">discrete =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,</span>
<span id="cb9-19">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family   =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scat</span>(),</span>
<span id="cb9-20">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method   =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fREML"</span></span>
<span id="cb9-21">)</span>
<span id="cb9-22"></span>
<span id="cb9-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Model 3: Add session random effects</span></span>
<span id="cb9-24">set_location_re <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bam</span>(</span>
<span id="cb9-25">    speed <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> swim_stroke <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> pool_length <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb9-26">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">s</span>(days_since_start, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> swim_stroke, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bs =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gp"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-27">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">s</span>(pos_within_workout, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> swim_stroke) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-28">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">s</span>(pos_within_set, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> swim_stroke) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-29">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">s</span>(session_id, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bs =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"re"</span>),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Random effect for sessions</span></span>
<span id="cb9-30">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data     =</span> final_tbl_2020,</span>
<span id="cb9-31">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">discrete =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,</span>
<span id="cb9-32">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family   =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scat</span>(),</span>
<span id="cb9-33">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method   =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fREML"</span></span>
<span id="cb9-34">)</span>
<span id="cb9-35"></span>
<span id="cb9-36"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compare model performance</span></span>
<span id="cb9-37">model_comparison <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">compare_performance</span>(simple, set_location, set_location_re)</span>
<span id="cb9-38"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(model_comparison)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># Comparison of Model Performance Indices

Name            | Model |    AIC (weights) |   AICc (weights)
-------------------------------------------------------------
simple          |   bam | -60982.5 (&lt;.001) | -60982.4 (&lt;.001)
set_location    |   bam | -78903.1 (&lt;.001) | -78902.5 (&lt;.001)
set_location_re |   bam | -81777.9 (&gt;.999) | -81765.5 (&gt;.999)

Name            |    BIC (weights) |    R2 |  RMSE | Sigma
----------------------------------------------------------
simple          | -60631.1 (&lt;.001) | 0.204 | 0.123 | 1.000
set_location    | -78017.1 (&gt;.999) | 0.449 | 0.101 | 1.000
set_location_re | -77560.3 (&lt;.001) | 0.475 | 0.099 | 1.000</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1">model_summary<span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(set_location_re)</span>
<span id="cb11-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(model_summary)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Family: Scaled t(3.729,0.064) 
Link function: identity 

Formula:
speed ~ swim_stroke + pool_length + s(days_since_start, by = swim_stroke, 
    bs = "gp") + s(pos_within_workout, by = swim_stroke) + s(pos_within_set, 
    by = swim_stroke) + s(session_id, bs = "re")

Parametric coefficients:
                          Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)              0.8914292  0.0049522  180.01   &lt;2e-16 ***
swim_strokebreaststroke  0.0613416  0.0052787   11.62   &lt;2e-16 ***
swim_strokebutterfly     0.2525302  0.0047424   53.25   &lt;2e-16 ***
swim_strokefreestyle     0.2141422  0.0031635   67.69   &lt;2e-16 ***
pool_length             -0.0017971  0.0001487  -12.09   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Approximate significance of smooth terms:
                                                  edf  Ref.df        F  p-value
s(days_since_start):swim_strokebackstroke       6.088   6.963    7.448  &lt; 2e-16
s(days_since_start):swim_strokebreaststroke     5.747   6.583    4.031 0.000274
s(days_since_start):swim_strokebutterfly        7.962   8.641    7.520  &lt; 2e-16
s(days_since_start):swim_strokefreestyle        8.047   8.390    7.933  &lt; 2e-16
s(pos_within_workout):swim_strokebackstroke     2.495   3.100    4.059 0.006375
s(pos_within_workout):swim_strokebreaststroke   7.311   8.292   20.984  &lt; 2e-16
s(pos_within_workout):swim_strokebutterfly      6.725   7.816   12.175  &lt; 2e-16
s(pos_within_workout):swim_strokefreestyle      8.375   8.888  312.136  &lt; 2e-16
s(pos_within_set):swim_strokebackstroke         8.232   8.778  163.531  &lt; 2e-16
s(pos_within_set):swim_strokebreaststroke       8.347   8.804  514.321  &lt; 2e-16
s(pos_within_set):swim_strokebutterfly          8.474   8.888  500.872  &lt; 2e-16
s(pos_within_set):swim_strokefreestyle          8.838   8.990 1051.382  &lt; 2e-16
s(session_id)                                 390.899 449.000    8.486  &lt; 2e-16
                                                 
s(days_since_start):swim_strokebackstroke     ***
s(days_since_start):swim_strokebreaststroke   ***
s(days_since_start):swim_strokebutterfly      ***
s(days_since_start):swim_strokefreestyle      ***
s(pos_within_workout):swim_strokebackstroke   ** 
s(pos_within_workout):swim_strokebreaststroke ***
s(pos_within_workout):swim_strokebutterfly    ***
s(pos_within_workout):swim_strokefreestyle    ***
s(pos_within_set):swim_strokebackstroke       ***
s(pos_within_set):swim_strokebreaststroke     ***
s(pos_within_set):swim_strokebutterfly        ***
s(pos_within_set):swim_strokefreestyle        ***
s(session_id)                                 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

R-sq.(adj) =  0.475   Deviance explained = 42.7%
fREML =  65732  Scale est. = 1         n = 39572</code></pre>
</div>
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">appraise</span>(set_location_re)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://jbogomolovas2.github.io/Julius-s-Blog/posts/post-with-code/index_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Based on model comparison, the most complex one seems to be doing the best.&nbsp; Some sanity check: indeed, backstroke is my slowest stroke, whereas butterfly is the fastest, and swimming in a 50 m pool vs.&nbsp;a 25-yard pool slows me a bit. In terms of fixed effects, the model effectively captured them.&nbsp; Smooth terms revealed significant nonlinear trends over time for all strokes, even when accounted for lap temporal position and session as a random factor. So let’s have a look.&nbsp;</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1">gratia<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">draw</span>(set_location_re,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">select=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span> )</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://jbogomolovas2.github.io/Julius-s-Blog/posts/post-with-code/index_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>I am getting faster with my strokes, but I am plateauing with my freestyle. Let’s create predictions from our best model and overlay them on the actual data:&nbsp;</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create prediction dataset</span></span>
<span id="cb15-2">pred_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">expand.grid</span>(</span>
<span id="cb15-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">days_since_start =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(final_tbl_2020<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>days_since_start), </span>
<span id="cb15-4">                        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(final_tbl_2020<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>days_since_start), </span>
<span id="cb15-5">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length.out =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>),</span>
<span id="cb15-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">swim_stroke =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">levels</span>(final_tbl_2020<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>swim_stroke),</span>
<span id="cb15-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">stringsAsFactors =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span></span>
<span id="cb15-8">)</span>
<span id="cb15-9"></span>
<span id="cb15-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set other variables to median/reference values</span></span>
<span id="cb15-11">pred_data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>pool_length <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(final_tbl_2020<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>pool_length) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#most of my workouts are in 25 yards</span></span>
<span id="cb15-12">pred_data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>pos_within_workout <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median</span>(final_tbl_2020<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>pos_within_workout)</span>
<span id="cb15-13">pred_data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>pos_within_set <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median</span>(final_tbl_2020<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>pos_within_set)</span>
<span id="cb15-14">pred_data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>session_id <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">levels</span>(final_tbl_2020<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>session_id)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb15-15"></span>
<span id="cb15-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Generate predictions (excluding random effects)</span></span>
<span id="cb15-17">predictions <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(set_location_re, </span>
<span id="cb15-18">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> pred_data, </span>
<span id="cb15-19">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">exclude =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"s(session_id)"</span>,</span>
<span id="cb15-20">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">se.fit =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb15-21"></span>
<span id="cb15-22">pred_data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> predictions<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>fit</span>
<span id="cb15-23">pred_data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>se <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> predictions<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>se.fit</span>
<span id="cb15-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Validation plot</span></span>
<span id="cb15-25">p_validation <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-26">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Scatter with very low alpha for context</span></span>
<span id="cb15-27">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> final_tbl_2020, </span>
<span id="cb15-28">             <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> days_since_start, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> speed),</span>
<span id="cb15-29">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey50"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-30">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 2D density contour lines</span></span>
<span id="cb15-31">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_density_2d</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> final_tbl_2020, </span>
<span id="cb15-32">                  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> days_since_start, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> speed),</span>
<span id="cb15-33">                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"darkblue"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bins =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-34">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Model smooth lines only - no CI</span></span>
<span id="cb15-35">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> pred_data,</span>
<span id="cb15-36">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> days_since_start, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> fit),</span>
<span id="cb15-37">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-38">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Facet by stroke type</span></span>
<span id="cb15-39">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> swim_stroke, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scales =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free_y"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-40">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Labels and theme</span></span>
<span id="cb15-41">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Days Since Start"</span>,</span>
<span id="cb15-42">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Speed (m/s)"</span>,</span>
<span id="cb15-43">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Swimming Speed Over Time by Stroke Type"</span>,</span>
<span id="cb15-44">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Density contours with GAM smooth curves"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-45">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-46">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>,</span>
<span id="cb15-47">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.grid.minor =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(),</span>
<span id="cb15-48">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">strip.text =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>))</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.
ℹ Please use `linewidth` instead.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(p_validation)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://jbogomolovas2.github.io/Julius-s-Blog/posts/post-with-code/index_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Although structured test sets would be ideal for tracking progress, even this messy lap-level data can already provide some insights. Overall, the model indicates that my backstroke, breaststroke, and butterfly are improving (which I have noticed myself), while freestyle still lags behind. Extending the analysis to quartiles or deciles of lap speeds should provide a more comprehensive picture of training progress and pacing strategies.</p>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0">
<div id="ref-performance" class="csl-entry">
Lüdecke, Daniel, Mattan S. Ben-Shachar, Indrajeet Patil, Philip Waggoner, and Dominique Makowski. 2021. <span>“<span></span>Performance<span></span>: An <span></span>r<span></span> Package for Assessment, Comparison and Testing of Statistical Models”</span> 6: 3139. <a href="https://doi.org/10.21105/joss.03139">https://doi.org/10.21105/joss.03139</a>.
</div>
<div id="ref-gratia" class="csl-entry">
Simpson, Gavin L. 2024. <span>“<span></span>Gratia<span></span>: Graceful <span></span>Ggplot<span></span>-Based Graphics and Other Functions for <span></span>GAM<span></span>s Fitted Using <span></span>Mgcv<span></span>.”</span> <a href="https://gavinsimpson.github.io/gratia/">https://gavinsimpson.github.io/gratia/</a>.
</div>
<div id="ref-FITfileR" class="csl-entry">
Smith, Mike. 2025. <span>“FITfileR: Read FIT Files Using Only Native r Code.”</span> <a href="https://github.com/grimbough/FITfileR.git">https://github.com/grimbough/FITfileR.git</a>.
</div>
<div id="ref-mgcv" class="csl-entry">
Wood, S. N. 2011. <span>“Fast Stable Restricted Maximum Likelihood and Marginal Likelihood Estimation of Semiparametric Generalized Linear Models”</span> 73. <a href="https://doi.org/10.1111/j.1467-9868.2010.00749.x">https://doi.org/10.1111/j.1467-9868.2010.00749.x</a>.
</div>
</div></section></div> ]]></description>
  <category>R</category>
  <category>GAM</category>
  <category>Sports Analytics</category>
  <category>Data Visualization</category>
  <guid>https://jbogomolovas2.github.io/Julius-s-Blog/posts/post-with-code/</guid>
  <pubDate>Mon, 23 Jun 2025 07:00:00 GMT</pubDate>
  <media:content url="https://jbogomolovas2.github.io/Julius-s-Blog/posts/post-with-code/image.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Welcome To My Blog</title>
  <dc:creator>Julius Bogomolovas</dc:creator>
  <link>https://jbogomolovas2.github.io/Julius-s-Blog/posts/welcome/</link>
  <description><![CDATA[ 





<p>Hello and welcome! I’m&nbsp;<strong>Julijus  Bogomolovas</strong>, a molecular cardiology researcher at UC San Diego who spends most days studying molecular signaling that keeps our hearts beating — but I unwind by pointing those same analytical instincts at whatever catches my curiosity, from swimming training to cherry blossom prediction.</p>
<p> Think of this space as my digital lab notebook crossed with a Sunday afternoon hobby shed: you’ll find expanded write-ups of data analysis from my professional work, side quests where I teach myself new statistical&nbsp;tricks,&nbsp;and plenty of “vanity” explorations that look fun. </p>
<p>I’m self‑taught in much of the data‑science tooling you’ll see here, so expect the occasional misstep, frank reflections on what I learned, and code and data you’re free to borrow or improve.</p>
<p> If you’re into biostatistics, all things cardiac, R notebooks that&nbsp;actually&nbsp;run, or enjoy watching a scientist learn in public, pull up a chair and join the conversation.</p>



 ]]></description>
  <category>news</category>
  <guid>https://jbogomolovas2.github.io/Julius-s-Blog/posts/welcome/</guid>
  <pubDate>Fri, 20 Jun 2025 07:00:00 GMT</pubDate>
  <media:content url="https://jbogomolovas2.github.io/Julius-s-Blog/posts/welcome/thumbnail.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Cherry Bloom Prediction</title>
  <dc:creator>Julijus Bogomolovas</dc:creator>
  <link>https://jbogomolovas2.github.io/Julius-s-Blog/posts/cherry_post/</link>
  <description><![CDATA[ 





<p>Lets load all required packages.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load all required packages</span></span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(nasapower)</span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(grateful)</span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span>
<span id="cb1-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(lubridate)</span>
<span id="cb1-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)</span>
<span id="cb1-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(data.table)</span>
<span id="cb1-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(missForest)</span>
<span id="cb1-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(spls)</span>
<span id="cb1-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(stringr)</span>
<span id="cb1-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(mvgam)</span>
<span id="cb1-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tibble)</span></code></pre></div>
</div>
<section id="cherry-blossom-day-prediction" class="level2">
<h2 class="anchored" data-anchor-id="cherry-blossom-day-prediction">Cherry Blossom day prediction</h2>
<p>So earlier this year I participated in <a href="https://competition.statistics.gmu.edu/"><strong>International Cherry Blossom Prediction Competition</strong></a><strong>,</strong> which invites you to predict this years bloom date of cherry trees in 5 different locations based on provided historical bloom dates provided and any data you dig out. Now that cherry trees bloomed long time ago, I am sharing my entry. As good ideas come after, I enhanced last modelling step by introducing State-space framework into GAM model, allowing to deal with observation poor time series in several of locations.</p>
<section id="weather-data-import" class="level3">
<h3 class="anchored" data-anchor-id="weather-data-import">1. Weather Data Import</h3>
<p>Let’s start by uploading historical weather data for studied locations. I found that NASA POWER project provides best continuous weather records using <code>nasapower</code> <span class="citation" data-cites="nasapower">(Sparks 2018)</span> package. Original records from nearby stations are riddled with missing data. So we download: Tmax, Tmin, Tmean and Precipitation from 1981-01-01 (earliest date available) until the most recent.</p>
<p>Here’s how we fetch the data for Kyoto as an example:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Retrieve weather data using nasapower for Kyoto</span></span>
<span id="cb2-2">Kyoto_temp <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_power</span>(</span>
<span id="cb2-3">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">community =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ag"</span>,</span>
<span id="cb2-4">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lonlat =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">135.6761</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">35.0120</span>),</span>
<span id="cb2-5">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pars =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"T2M"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"T2M_MAX"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"T2M_MIN"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"PRECTOTCORR"</span>),</span>
<span id="cb2-6">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1981-01-01"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2025-02-15"</span>),</span>
<span id="cb2-7">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">temporal_api =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"daily"</span></span>
<span id="cb2-8">)</span></code></pre></div>
</div>
<p>We repeat this process for all five cherry blossom locations: Kyoto (Japan), Liestal-Weideli (Switzerland), Washington DC (USA), Vancouver (Canada), and New York City (USA).</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Full code for all locations
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Retrieve weather data for remaining locations</span></span>
<span id="cb3-2">Swiss_temp <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_power</span>(</span>
<span id="cb3-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">community =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ag"</span>,</span>
<span id="cb3-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lonlat =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">7.730519</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">47.4814</span>),</span>
<span id="cb3-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pars =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"T2M"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"T2M_MAX"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"T2M_MIN"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"PRECTOTCORR"</span>),</span>
<span id="cb3-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1981-01-01"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2025-02-15"</span>),</span>
<span id="cb3-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">temporal_api =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"daily"</span></span>
<span id="cb3-8">)</span>
<span id="cb3-9"></span>
<span id="cb3-10">Washington_temp <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_power</span>(</span>
<span id="cb3-11">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">community =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ag"</span>,</span>
<span id="cb3-12">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lonlat =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">77.0386</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">38.8853</span>),</span>
<span id="cb3-13">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pars =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"T2M"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"T2M_MAX"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"T2M_MIN"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"PRECTOTCORR"</span>),</span>
<span id="cb3-14">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1981-01-01"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2025-02-15"</span>),</span>
<span id="cb3-15">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">temporal_api =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"daily"</span></span>
<span id="cb3-16">)</span>
<span id="cb3-17"></span>
<span id="cb3-18">Vancouver_temp <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_power</span>(</span>
<span id="cb3-19">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">community =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ag"</span>,</span>
<span id="cb3-20">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lonlat =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">123.1636</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">49.2237</span>),</span>
<span id="cb3-21">   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pars =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"T2M"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"T2M_MAX"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"T2M_MIN"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"PRECTOTCORR"</span>),</span>
<span id="cb3-22">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1981-01-01"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2025-02-15"</span>),</span>
<span id="cb3-23">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">temporal_api =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"daily"</span></span>
<span id="cb3-24">)</span>
<span id="cb3-25"></span>
<span id="cb3-26">NY_temp <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_power</span>(</span>
<span id="cb3-27">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">community =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ag"</span>,</span>
<span id="cb3-28">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lonlat =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">73.99809</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">40.73040</span>),</span>
<span id="cb3-29">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pars =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"T2M"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"T2M_MAX"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"T2M_MIN"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"PRECTOTCORR"</span>),</span>
<span id="cb3-30">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dates =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1981-01-01"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2025-02-15"</span>),</span>
<span id="cb3-31">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">temporal_api =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"daily"</span></span>
<span id="cb3-32">)</span></code></pre></div>
</div>
</div>
</div>
</div>
</section>
<section id="calculating-daily-weather-anomalies" class="level3">
<h3 class="anchored" data-anchor-id="calculating-daily-weather-anomalies">2. Calculating Daily Weather Anomalies</h3>
<p>Now let’s create daily anomalies. We assume that if weather conditions were identical, cherry blossoms would occur on the same day every year. By computing daily anomalies, we partially normalize our variables across different locations.</p>
<p>First, we define a function to calculate these anomalies:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Function to calculate daily climate anomalies</span></span>
<span id="cb4-2">calculate_climate_anomalies <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(data, </span>
<span id="cb4-3">                                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">baseline_start =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1981</span>, </span>
<span id="cb4-4">                                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">baseline_end =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2024</span>, </span>
<span id="cb4-5">                                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">vars =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"T2M"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"T2M_MAX"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"T2M_MIN"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"PRECTOTCORR"</span>)) {</span>
<span id="cb4-6">  </span>
<span id="cb4-7">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Validate input variables</span></span>
<span id="cb4-8">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all</span>(vars <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(data))) {</span>
<span id="cb4-9">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stop</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Not all specified variables are present in the dataset."</span>)</span>
<span id="cb4-10">  }</span>
<span id="cb4-11">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"YEAR"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"DOY"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(data))) {</span>
<span id="cb4-12">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stop</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Dataset must include 'YEAR' and 'DOY' columns."</span>)</span>
<span id="cb4-13">  }</span>
<span id="cb4-14">  </span>
<span id="cb4-15">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create baseline subset</span></span>
<span id="cb4-16">  baseline_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> data[data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>YEAR <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> baseline_start <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>YEAR <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> baseline_end, ]</span>
<span id="cb4-17">  </span>
<span id="cb4-18">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate daily climatology (mean for each day-of-year)</span></span>
<span id="cb4-19">  climatology <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aggregate</span>(baseline_data[vars], </span>
<span id="cb4-20">                           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">DOY =</span> baseline_data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>DOY), </span>
<span id="cb4-21">                           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">FUN =</span> mean, </span>
<span id="cb4-22">                           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.rm =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb4-23">  </span>
<span id="cb4-24">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Merge climatology with original data and compute anomalies</span></span>
<span id="cb4-25">  result <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">merge</span>(data, climatology, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"DOY"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">suffixes =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_mean"</span>))</span>
<span id="cb4-26">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> (var <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> vars) {</span>
<span id="cb4-27">    mean_col <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(var, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_mean"</span>)</span>
<span id="cb4-28">    anom_col <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(var, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_anomaly"</span>)</span>
<span id="cb4-29">    result[[anom_col]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> result[[var]] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> result[[mean_col]]</span>
<span id="cb4-30">  }</span>
<span id="cb4-31">  </span>
<span id="cb4-32">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Attach attributes and sort by date</span></span>
<span id="cb4-33">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(result, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"baseline_period"</span>) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(baseline_start, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"-"</span>, baseline_end)</span>
<span id="cb4-34">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(result, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"variables"</span>) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> vars</span>
<span id="cb4-35">  result <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> result[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">order</span>(result<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>YYYYMMDD), ]</span>
<span id="cb4-36">  </span>
<span id="cb4-37">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(result)</span>
<span id="cb4-38">}</span></code></pre></div>
</div>
<p>We then apply this function to each location’s weather data. Here’s an example for New York:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate anomalies for New York</span></span>
<span id="cb5-2">NY_temp_anomalies <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">calculate_climate_anomalies</span>(NY_temp)</span>
<span id="cb5-3">NY_temp_anomalies<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>location <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"New York, USA"</span></span></code></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Processing all locations
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate anomalies for remaining locations</span></span>
<span id="cb6-2">Vancouver_temp_anomalies <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">calculate_climate_anomalies</span>(Vancouver_temp)</span>
<span id="cb6-3">Swiss_temp_anomalies <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">calculate_climate_anomalies</span>(Swiss_temp)</span>
<span id="cb6-4">Washington_temp_anomalies <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">calculate_climate_anomalies</span>(Washington_temp)</span>
<span id="cb6-5">Kyoto_temp_anomalies <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">calculate_climate_anomalies</span>(Kyoto_temp)</span>
<span id="cb6-6"></span>
<span id="cb6-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Append location identifiers</span></span>
<span id="cb6-8">Vancouver_temp_anomalies<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>location <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Vancouver, Canada"</span></span>
<span id="cb6-9">Swiss_temp_anomalies<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>location <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Liestal-Weideli, Switzerland"</span></span>
<span id="cb6-10">Washington_temp_anomalies<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>location <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Washington DC, USA"</span></span>
<span id="cb6-11">Kyoto_temp_anomalies<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>location <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Kyoto, Japan"</span></span></code></pre></div>
</div>
</div>
</div>
</div>
<p>Finally, we combine all the anomaly data into a single dataset:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Combine all anomaly data</span></span>
<span id="cb7-2">combined_anomalies <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbind</span>(</span>
<span id="cb7-3">  NY_temp_anomalies,</span>
<span id="cb7-4">  Vancouver_temp_anomalies,</span>
<span id="cb7-5">  Swiss_temp_anomalies,</span>
<span id="cb7-6">  Washington_temp_anomalies,</span>
<span id="cb7-7">  Kyoto_temp_anomalies</span>
<span id="cb7-8">)</span>
<span id="cb7-9">combined_anomalies <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> combined_anomalies[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">order</span>(combined_anomalies<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>location, combined_anomalies<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>YYYYMMDD), ]</span></code></pre></div>
</div>
</section>
<section id="importing-and-processing-cherry-blossom-data" class="level3">
<h3 class="anchored" data-anchor-id="importing-and-processing-cherry-blossom-data">3. Importing and Processing Cherry Blossom Data</h3>
<p>Next, we import and combine the cherry blossom data. We filter for records from 1981 onward to ensure the dates match our weather data range:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Import cherry blossom data and filter for records from 1981 onward</span></span>
<span id="cb8-2">Vancouver <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_csv</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/vancouver.csv"</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">show_col_types =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)</span>
<span id="cb8-3">Washington <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_csv</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/washingtondc.csv"</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">show_col_types =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)</span>
<span id="cb8-4">Kyoto <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_csv</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/kyoto.csv"</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">show_col_types =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)</span>
<span id="cb8-5">Swiss <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_csv</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/liestal.csv"</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">show_col_types =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)</span>
<span id="cb8-6">Nyc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_csv</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/nyc.csv"</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">show_col_types =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)</span>
<span id="cb8-7"></span>
<span id="cb8-8">combined_blossom_dates <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbind</span>(Vancouver, Washington, Kyoto, Swiss, Nyc)</span>
<span id="cb8-9">combined_blossom_dates <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> combined_blossom_dates[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">order</span>(combined_blossom_dates<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>location, combined_blossom_dates<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>year), ]</span>
<span id="cb8-10">combined_blossom_dates <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> combined_blossom_dates[combined_blossom_dates<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>year <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1981</span>, ]</span></code></pre></div>
</div>
</section>
<section id="augmenting-new-york-blossom-data" class="level3">
<h3 class="anchored" data-anchor-id="augmenting-new-york-blossom-data">4. Augmenting New York Blossom Data</h3>
<p>The primary dataset contains only one record for New York. To augment it, I retrieve data from the USA National Phenology Network. Based on recommendations, I filter for the specific location and species, then select records with more than 74% blossom (excluding the 50–74% category, which does not match our original data). For each year, I select the earliest record:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Read USA-NPN individual phenometrics data</span></span>
<span id="cb9-2">USA_NPN_status_intensity <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_csv</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'data/USA-NPN_status_intensity_observations_data.csv'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">show_col_types =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)</span>
<span id="cb9-3"></span>
<span id="cb9-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert to data frame and prepare Intensity_Value as factor</span></span>
<span id="cb9-5">USA_status <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(USA_NPN_status_intensity)</span>
<span id="cb9-6">USA_status<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Intensity_Value <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.factor</span>(USA_status<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Intensity_Value)</span>
<span id="cb9-7"></span>
<span id="cb9-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Filter out records with intensity values that do not match our criteria</span></span>
<span id="cb9-9">USA_status_filtered <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> USA_status[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>(USA_status<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Intensity_Value <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> </span>
<span id="cb9-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"-9999"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Little"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"25-49%"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"5-24%"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Less than 5%"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"More than 10"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"50-74%"</span>)), ]</span>
<span id="cb9-11"></span>
<span id="cb9-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert dates and extract Year and Day of Year</span></span>
<span id="cb9-13">USA_status_filtered<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Date <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mdy</span>(USA_status_filtered<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Observation_Date)</span>
<span id="cb9-14">USA_status_filtered<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Year <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">year</span>(USA_status_filtered<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Date)</span>
<span id="cb9-15">USA_status_filtered<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Day_of_Year <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">yday</span>(USA_status_filtered<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Date)</span></code></pre></div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Visualization and detailed summary
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a scatter plot to visualize Day of Year vs. Year, colored by Intensity_Value</span></span>
<span id="cb10-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(USA_status_filtered, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> Year, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> Day_of_Year, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> Intensity_Value)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_brewer</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">palette =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Set1"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Day of Year vs Year for USA-NPN Data"</span>,</span>
<span id="cb10-6">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Year"</span>,</span>
<span id="cb10-7">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Day of Year"</span>,</span>
<span id="cb10-8">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Intensity Value"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>()</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://jbogomolovas2.github.io/Julius-s-Blog/posts/cherry_post/index_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Summarize the filtered data by year</span></span>
<span id="cb11-2">year_summary_NY_individual <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> USA_status_filtered <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb11-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(Year) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb11-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(</span>
<span id="cb11-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Min =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(Day_of_Year, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.rm =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>),</span>
<span id="cb11-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Q1 =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quantile</span>(Day_of_Year, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.rm =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>),</span>
<span id="cb11-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Median =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median</span>(Day_of_Year, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.rm =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>),</span>
<span id="cb11-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Mean =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(Day_of_Year, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.rm =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>),</span>
<span id="cb11-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Q3 =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quantile</span>(Day_of_Year, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.rm =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>),</span>
<span id="cb11-10">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Max =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(Day_of_Year, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.rm =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>),</span>
<span id="cb11-11">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Count =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>()</span>
<span id="cb11-12">  )</span>
<span id="cb11-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(year_summary_NY_individual)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 13 × 8
    Year   Min    Q1 Median  Mean    Q3   Max Count
   &lt;int&gt; &lt;int&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; &lt;int&gt;
 1  2012    89  89      89    89    89     89     2
 2  2013   104 110     142   137.  150    170     9
 3  2014    98 108.    141   132.  156    160    11
 4  2015   101 138     148   141.  153    156    24
 5  2016   110 128.    135   134   143.   153     6
 6  2017    87 110     138   128.  143    146     9
 7  2018    79  99     101   103.  107    140    66
 8  2019    96 101     106.  115.  124.   151    24
 9  2020    78  90.5   100   107.  117.   243    32
10  2021    86  99     106   111.  116    148    41
11  2022    97 110.    122.  122.  136.   154    10
12  2023    92 104     130.  130.  139.   255    18
13  2024    88  94     106   110.  124    147    11</code></pre>
</div>
</div>
</div>
</div>
</div>
<p>Now we create augmented New York data using the earliest bloom date for each year:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create new NY data frame from the yearly summary (excluding 2024)</span></span>
<span id="cb13-2">ny_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb13-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">location =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"newyorkcity"</span>,</span>
<span id="cb13-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lat =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">40.73040</span>,</span>
<span id="cb13-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">long =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">73.99809</span>,</span>
<span id="cb13-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alt =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8.5</span>,</span>
<span id="cb13-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">year =</span> year_summary_NY_individual<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Year[year_summary_NY_individual<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Year <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2024</span>],</span>
<span id="cb13-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bloom_date =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>,</span>
<span id="cb13-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bloom_doy =</span> year_summary_NY_individual<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Min[year_summary_NY_individual<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Year <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2024</span>]</span>
<span id="cb13-10">)</span>
<span id="cb13-11"></span>
<span id="cb13-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert day-of-year to actual dates</span></span>
<span id="cb13-13">ny_data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>bloom_date <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.Date</span>(ny_data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>bloom_doy <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">origin =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(ny_data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>year, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"-01-01"</span>))</span>
<span id="cb13-14"></span>
<span id="cb13-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Merge with existing combined blossom dates</span></span>
<span id="cb13-16">combined_blossom_dates <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbind</span>(combined_blossom_dates, ny_data)</span>
<span id="cb13-17">combined_blossom_dates <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> combined_blossom_dates[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">order</span>(combined_blossom_dates<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>location, combined_blossom_dates<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>year), ]</span></code></pre></div>
</div>
</section>
<section id="analyzing-blossom-data" class="level3">
<h3 class="anchored" data-anchor-id="analyzing-blossom-data">5. Analyzing Blossom Data</h3>
<p>For effective modeling, we need a timeframe that aligns with the natural cherry blossom cycle rather than arbitrary calendar years. Let’s analyze our blossom date distribution to identify the optimal starting point for our “cherry year.”</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Summarize blossom dates by location</span></span>
<span id="cb14-2">blossom_summary <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> combined_blossom_dates <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb14-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(location) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb14-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise</span>(</span>
<span id="cb14-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Min =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(bloom_doy),</span>
<span id="cb14-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Q1 =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quantile</span>(bloom_doy, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>),</span>
<span id="cb14-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Median =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median</span>(bloom_doy),</span>
<span id="cb14-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Q3 =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quantile</span>(bloom_doy, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>),</span>
<span id="cb14-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Max =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(bloom_doy),</span>
<span id="cb14-10">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Range =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(bloom_doy) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(bloom_doy)</span>
<span id="cb14-11">  )</span>
<span id="cb14-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(blossom_summary)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 7
  location       Min    Q1 Median    Q3   Max Range
  &lt;chr&gt;        &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1 kyoto           84  93       95    99   109    25
2 liestal         75  87       93   101   121    46
3 newyorkcity     78  87       92    98   110    32
4 vancouver       83  84.5     86    91    96    13
5 washingtondc    74  86       91    95   101    27</code></pre>
</div>
</div>
<p>The maximum third quartile (Q3) at day 100 represents when 75% of historical blooms have occurred in late–bloomer location—effectively marking the end of the bloom season across locations. While we could theoretically calculate predictors from one recorded bloom date to the next, this creates a circular dependency: to predict next year’s bloom date, we’d need to know it already to determine when to stop accumulating our weather predictors. By using day 100 as our universal cutoff, we establish a “cherry year” that runs from April 10 to April 9, nicely matching historical bloom cycles.</p>
</section>
<section id="building-rolling-sum-predictors" class="level3">
<h3 class="anchored" data-anchor-id="building-rolling-sum-predictors">6. Building Rolling Sum Predictors</h3>
<p>In this section, we create predictors that capture the cumulative effect of weather anomalies over a 30-day period, which we hypothesize will influence the timing of cherry blossom.</p>
<p>First, we convert to data.table and compute 30-day rolling sums for each anomaly type. Here’s an example for temperature anomalies:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert to data.table for efficient rolling calculations</span></span>
<span id="cb16-2">combined_anomalies <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.table</span>(combined_anomalies)</span>
<span id="cb16-3"></span>
<span id="cb16-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Example: Calculate 30-day rolling sums for average temperature anomalies</span></span>
<span id="cb16-5">combined_anomalies[, temp_ave_pos_rollsum <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">frollsum</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(T2M_anomaly <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, T2M_anomaly, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>), </span>
<span id="cb16-6">                                                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">align =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"right"</span>), by <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> location]</span>
<span id="cb16-7">combined_anomalies[, temp_ave_neg_rollsum <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">frollsum</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(T2M_anomaly <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, T2M_anomaly, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>), </span>
<span id="cb16-8">                                                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">align =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"right"</span>), by <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> location]</span></code></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Complete rolling sum calculations for all variables
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Maximum temperature rolling sums</span></span>
<span id="cb17-2">combined_anomalies[, temp_max_pos_rollsum <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">frollsum</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(T2M_MAX_anomaly <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, T2M_MAX_anomaly, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>), </span>
<span id="cb17-3">                                                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">align =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"right"</span>), by <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> location]</span>
<span id="cb17-4">combined_anomalies[, temp_max_neg_rollsum <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">frollsum</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(T2M_MAX_anomaly <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, T2M_MAX_anomaly, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>), </span>
<span id="cb17-5">                                                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">align =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"right"</span>), by <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> location]</span>
<span id="cb17-6"></span>
<span id="cb17-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Minimum temperature rolling sums</span></span>
<span id="cb17-8">combined_anomalies[, temp_min_pos_rollsum <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">frollsum</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(T2M_MIN_anomaly <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, T2M_MIN_anomaly, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>), </span>
<span id="cb17-9">                                                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">align =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"right"</span>), by <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> location]</span>
<span id="cb17-10">combined_anomalies[, temp_min_neg_rollsum <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">frollsum</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(T2M_MIN_anomaly <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, T2M_MIN_anomaly, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>), </span>
<span id="cb17-11">                                                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">align =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"right"</span>), by <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> location]</span>
<span id="cb17-12"></span>
<span id="cb17-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Precipitation rolling sums</span></span>
<span id="cb17-14">combined_anomalies[, prcp_pos_rollsum <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">frollsum</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(PRECTOTCORR_anomaly <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, PRECTOTCORR_anomaly, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>), </span>
<span id="cb17-15">                                                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">align =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"right"</span>), by <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> location]</span>
<span id="cb17-16">combined_anomalies[, prcp_neg_rollsum <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">frollsum</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(PRECTOTCORR_anomaly <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, PRECTOTCORR_anomaly, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>), </span>
<span id="cb17-17">                                                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">align =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"right"</span>), by <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> location]</span></code></pre></div>
</div>
</div>
</div>
</div>
<p>Next, we create a “cherry year” that aligns with the bloom cycle. Based on our analysis, we start each cherry year on April 10 (day 100):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a numeric day-of-year and adjust to form a 'cherry_year'</span></span>
<span id="cb18-2">combined_anomalies[, doy <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">format</span>(YYYYMMDD, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"%j"</span>))]</span>
<span id="cb18-3">combined_anomalies[, cherry_year <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(doy <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">year</span>(YYYYMMDD) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">year</span>(YYYYMMDD))]</span>
<span id="cb18-4">combined_anomalies[, day_number <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(doy <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, doy <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">99</span>, doy <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">366</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">99</span>))]</span></code></pre></div>
</div>
<p>Finally, we create a streamlined dataset containing only the rolling sum predictors:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1">small_anomaly_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> combined_anomalies <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb19-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(DOY, LON, LAT, YEAR, MM, DD, T2M, T2M_MAX, T2M_MIN, PRECTOTCORR,</span>
<span id="cb19-3">            T2M_mean, T2M_MAX_mean, T2M_MIN_mean, PRECTOTCORR_mean,</span>
<span id="cb19-4">            T2M_anomaly, T2M_MAX_anomaly, T2M_MIN_anomaly, PRECTOTCORR_anomaly))</span></code></pre></div>
</div>
<p>This process creates eight rolling sum predictors (positive and negative anomalies for average/max/min temperature and precipitation) that capture the cumulative weather effects leading up to each potential bloom date.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load the pre-processed data since we skipped the processing steps</span></span>
<span id="cb20-2">final_wide <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read.csv</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/final_wide.csv"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">row.names =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span></code></pre></div>
</div>
</section>
<section id="reshaping-imputation-and-merging-wide-format-data" class="level3">
<h3 class="anchored" data-anchor-id="reshaping-imputation-and-merging-wide-format-data">7. Reshaping, Imputation, and Merging Wide-Format Data</h3>
<p>We now convert our rolling sum predictors into a wide-format structure for modeling. This creates a matrix where each row represents a cherry year and location, with columns for each day’s rolling sum values.</p>
<p>Here’s the process for one predictor (positive temperature anomaly rolling sum):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Reshape data to wide format</span></span>
<span id="cb21-2">wide_temp_ave_pos <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dcast</span>(small_anomaly_df[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(temp_ave_pos_rollsum)], </span>
<span id="cb21-3">                           cherry_year <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> location <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> day_number, </span>
<span id="cb21-4">                           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value.var =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"temp_ave_pos_rollsum"</span>)</span>
<span id="cb21-5"></span>
<span id="cb21-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Rename columns to be more descriptive</span></span>
<span id="cb21-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setnames</span>(wide_temp_ave_pos, </span>
<span id="cb21-8">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">old =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setdiff</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(wide_temp_ave_pos), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cherry_year"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"location"</span>)), </span>
<span id="cb21-9">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">new =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"temp_ave_pos_rollsum_"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_along</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setdiff</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(wide_temp_ave_pos), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cherry_year"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"location"</span>)))))</span>
<span id="cb21-10"></span>
<span id="cb21-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Impute missing values using random forest</span></span>
<span id="cb21-12">numeric_cols <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setdiff</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(wide_temp_ave_pos), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cherry_year"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"location"</span>))</span>
<span id="cb21-13">numeric_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(wide_temp_ave_pos[, ..numeric_cols])</span>
<span id="cb21-14">imputed_result <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">missForest</span>(numeric_matrix, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">maxiter =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">verbose =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb21-15">imputed_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> imputed_result<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ximp</span>
<span id="cb21-16">wide_temp_ave_pos_imputed <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(wide_temp_ave_pos[, .(cherry_year, location)], imputed_matrix)</span></code></pre></div>
</div>
<p>We repeat this process for all eight rolling sum predictors. Missing values (~2.4% per predictor) occur in three scenarios: - Initial period from April 10, 1981 to January 31, 1982 - Dates after February 20, 2025 (extent of available weather data) - Day 366 in non-leap years</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-5-contents" aria-controls="callout-5" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Full reshaping code for all predictors
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-5" class="callout-5-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Process negative temperature average anomalies</span></span>
<span id="cb22-2">wide_temp_ave_neg <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dcast</span>(small_anomaly_df[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(temp_ave_neg_rollsum)], </span>
<span id="cb22-3">                           cherry_year <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> location <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> day_number, </span>
<span id="cb22-4">                           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value.var =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"temp_ave_neg_rollsum"</span>)</span>
<span id="cb22-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setnames</span>(wide_temp_ave_neg, </span>
<span id="cb22-6">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">old =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setdiff</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(wide_temp_ave_neg), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cherry_year"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"location"</span>)), </span>
<span id="cb22-7">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">new =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"temp_ave_neg_rollsum_"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_along</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setdiff</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(wide_temp_ave_neg), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cherry_year"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"location"</span>)))))</span>
<span id="cb22-8">numeric_cols <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setdiff</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(wide_temp_ave_neg), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cherry_year"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"location"</span>))</span>
<span id="cb22-9">numeric_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(wide_temp_ave_neg[, ..numeric_cols])</span>
<span id="cb22-10">imputed_result <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">missForest</span>(numeric_matrix, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">maxiter =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">verbose =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb22-11">imputed_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> imputed_result<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ximp</span>
<span id="cb22-12">wide_temp_ave_neg_imputed <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(wide_temp_ave_neg[, .(cherry_year, location)], imputed_matrix)</span>
<span id="cb22-13"></span>
<span id="cb22-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Process positive temperature maximum anomalies</span></span>
<span id="cb22-15">wide_temp_max_pos <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dcast</span>(small_anomaly_df[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(temp_max_pos_rollsum)], </span>
<span id="cb22-16">                           cherry_year <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> location <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> day_number, </span>
<span id="cb22-17">                           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value.var =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"temp_max_pos_rollsum"</span>)</span>
<span id="cb22-18"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setnames</span>(wide_temp_max_pos, </span>
<span id="cb22-19">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">old =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setdiff</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(wide_temp_max_pos), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cherry_year"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"location"</span>)), </span>
<span id="cb22-20">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">new =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"temp_max_pos_rollsum_"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_along</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setdiff</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(wide_temp_max_pos), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cherry_year"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"location"</span>)))))</span>
<span id="cb22-21">numeric_cols <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setdiff</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(wide_temp_max_pos), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cherry_year"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"location"</span>))</span>
<span id="cb22-22">numeric_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(wide_temp_max_pos[, ..numeric_cols])</span>
<span id="cb22-23">imputed_result <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">missForest</span>(numeric_matrix, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">maxiter =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">verbose =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb22-24">imputed_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> imputed_result<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ximp</span>
<span id="cb22-25">wide_temp_max_pos_imputed <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(wide_temp_max_pos[, .(cherry_year, location)], imputed_matrix)</span>
<span id="cb22-26"></span>
<span id="cb22-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Process negative temperature maximum anomalies</span></span>
<span id="cb22-28">wide_temp_max_neg <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dcast</span>(small_anomaly_df[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(temp_max_neg_rollsum)], </span>
<span id="cb22-29">                           cherry_year <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> location <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> day_number, </span>
<span id="cb22-30">                           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value.var =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"temp_max_neg_rollsum"</span>)</span>
<span id="cb22-31"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setnames</span>(wide_temp_max_neg, </span>
<span id="cb22-32">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">old =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setdiff</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(wide_temp_max_neg), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cherry_year"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"location"</span>)), </span>
<span id="cb22-33">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">new =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"temp_max_neg_rollsum_"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_along</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setdiff</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(wide_temp_max_neg), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cherry_year"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"location"</span>)))))</span>
<span id="cb22-34">numeric_cols <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setdiff</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(wide_temp_max_neg), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cherry_year"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"location"</span>))</span>
<span id="cb22-35">numeric_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(wide_temp_max_neg[, ..numeric_cols])</span>
<span id="cb22-36">imputed_result <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">missForest</span>(numeric_matrix, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">maxiter =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">verbose =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb22-37">imputed_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> imputed_result<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ximp</span>
<span id="cb22-38">wide_temp_max_neg_imputed <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(wide_temp_max_neg[, .(cherry_year, location)], imputed_matrix)</span>
<span id="cb22-39"></span>
<span id="cb22-40"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Process positive temperature minimum anomalies</span></span>
<span id="cb22-41">wide_temp_min_pos <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dcast</span>(small_anomaly_df[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(temp_min_pos_rollsum)], </span>
<span id="cb22-42">                           cherry_year <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> location <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> day_number, </span>
<span id="cb22-43">                           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value.var =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"temp_min_pos_rollsum"</span>)</span>
<span id="cb22-44"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setnames</span>(wide_temp_min_pos, </span>
<span id="cb22-45">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">old =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setdiff</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(wide_temp_min_pos), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cherry_year"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"location"</span>)), </span>
<span id="cb22-46">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">new =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"temp_min_pos_rollsum_"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_along</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setdiff</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(wide_temp_min_pos), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cherry_year"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"location"</span>)))))</span>
<span id="cb22-47">numeric_cols <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setdiff</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(wide_temp_min_pos), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cherry_year"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"location"</span>))</span>
<span id="cb22-48">numeric_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(wide_temp_min_pos[, ..numeric_cols])</span>
<span id="cb22-49">imputed_result <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">missForest</span>(numeric_matrix, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">maxiter =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">verbose =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb22-50">imputed_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> imputed_result<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ximp</span>
<span id="cb22-51">wide_temp_min_pos_imputed <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(wide_temp_min_pos[, .(cherry_year, location)], imputed_matrix)</span>
<span id="cb22-52"></span>
<span id="cb22-53"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Process negative temperature minimum anomalies</span></span>
<span id="cb22-54">wide_temp_min_neg <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dcast</span>(small_anomaly_df[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(temp_min_neg_rollsum)], </span>
<span id="cb22-55">                           cherry_year <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> location <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> day_number, </span>
<span id="cb22-56">                           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value.var =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"temp_min_neg_rollsum"</span>)</span>
<span id="cb22-57"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setnames</span>(wide_temp_min_neg, </span>
<span id="cb22-58">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">old =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setdiff</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(wide_temp_min_neg), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cherry_year"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"location"</span>)), </span>
<span id="cb22-59">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">new =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"temp_min_neg_rollsum_"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_along</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setdiff</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(wide_temp_min_neg), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cherry_year"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"location"</span>)))))</span>
<span id="cb22-60">numeric_cols <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setdiff</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(wide_temp_min_neg), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cherry_year"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"location"</span>))</span>
<span id="cb22-61">numeric_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(wide_temp_min_neg[, ..numeric_cols])</span>
<span id="cb22-62">imputed_result <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">missForest</span>(numeric_matrix, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">maxiter =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">verbose =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb22-63">imputed_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> imputed_result<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ximp</span>
<span id="cb22-64">wide_temp_min_neg_imputed <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(wide_temp_min_neg[, .(cherry_year, location)], imputed_matrix)</span>
<span id="cb22-65"></span>
<span id="cb22-66"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Process positive precipitation anomalies</span></span>
<span id="cb22-67">wide_prcp_pos <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dcast</span>(small_anomaly_df[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(prcp_pos_rollsum)], </span>
<span id="cb22-68">                       cherry_year <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> location <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> day_number, </span>
<span id="cb22-69">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value.var =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"prcp_pos_rollsum"</span>)</span>
<span id="cb22-70"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setnames</span>(wide_prcp_pos, </span>
<span id="cb22-71">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">old =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setdiff</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(wide_prcp_pos), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cherry_year"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"location"</span>)), </span>
<span id="cb22-72">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">new =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"prcp_pos_rollsum_"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_along</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setdiff</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(wide_prcp_pos), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cherry_year"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"location"</span>)))))</span>
<span id="cb22-73">numeric_cols <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setdiff</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(wide_prcp_pos), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cherry_year"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"location"</span>))</span>
<span id="cb22-74">numeric_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(wide_prcp_pos[, ..numeric_cols])</span>
<span id="cb22-75">imputed_result <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">missForest</span>(numeric_matrix, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">maxiter =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">verbose =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb22-76">imputed_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> imputed_result<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ximp</span>
<span id="cb22-77">wide_prcp_pos_imputed <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(wide_prcp_pos[, .(cherry_year, location)], imputed_matrix)</span>
<span id="cb22-78"></span>
<span id="cb22-79"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Process negative precipitation anomalies</span></span>
<span id="cb22-80">wide_prcp_neg <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dcast</span>(small_anomaly_df[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(prcp_neg_rollsum)], </span>
<span id="cb22-81">                       cherry_year <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> location <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> day_number, </span>
<span id="cb22-82">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value.var =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"prcp_neg_rollsum"</span>)</span>
<span id="cb22-83"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setnames</span>(wide_prcp_neg, </span>
<span id="cb22-84">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">old =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setdiff</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(wide_prcp_neg), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cherry_year"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"location"</span>)), </span>
<span id="cb22-85">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">new =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"prcp_neg_rollsum_"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_along</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setdiff</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(wide_prcp_neg), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cherry_year"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"location"</span>)))))</span>
<span id="cb22-86">numeric_cols <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setdiff</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(wide_prcp_neg), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cherry_year"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"location"</span>))</span>
<span id="cb22-87">numeric_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(wide_prcp_neg[, ..numeric_cols])</span>
<span id="cb22-88">imputed_result <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">missForest</span>(numeric_matrix, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">maxiter =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">verbose =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb22-89">imputed_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> imputed_result<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ximp</span>
<span id="cb22-90">wide_prcp_neg_imputed <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(wide_prcp_neg[, .(cherry_year, location)], imputed_matrix)</span></code></pre></div>
</div>
</div>
</div>
</div>
<p>After processing all eight predictor sets, we merge them into a comprehensive dataset:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Merge all wide-format datasets by cherry_year and location</span></span>
<span id="cb23-2">final_wide <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Reduce</span>(<span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(x, y) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">merge</span>(x, y, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cherry_year"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"location"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">all =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>),</span>
<span id="cb23-3">                     <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(wide_temp_ave_pos_imputed, wide_temp_ave_neg_imputed, </span>
<span id="cb23-4">                          wide_temp_max_pos_imputed, wide_temp_max_neg_imputed,</span>
<span id="cb23-5">                          wide_temp_min_pos_imputed, wide_temp_min_neg_imputed,</span>
<span id="cb23-6">                          wide_prcp_pos_imputed, wide_prcp_neg_imputed))</span></code></pre></div>
</div>
<p>This gives us 8 rolling sum variables × 366 days = 2,928 predictors per location per year. Due to the computational intensity of the imputation process, you can download the pre-imputed file from <a href="data/final_wide.csv">final_wide.csv</a>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write.csv</span>(final_wide, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/final_wide.csv"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">row.names =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span></code></pre></div>
</div>
</section>
<section id="merging-rolling-sums-with-blossom-data" class="level3">
<h3 class="anchored" data-anchor-id="merging-rolling-sums-with-blossom-data">8. Merging Rolling Sums with Blossom Data</h3>
<p>Now we merge our wide-format predictors with the actual bloom dates:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1">final_wide <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>(final_wide)</span>
<span id="cb25-2"></span>
<span id="cb25-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Map location names to match blossom data format</span></span>
<span id="cb25-4">location_mapping <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(</span>
<span id="cb25-5">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Kyoto, Japan"</span>                <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"kyoto"</span>,</span>
<span id="cb25-6">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Liestal-Weideli, Switzerland"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"liestal"</span>,</span>
<span id="cb25-7">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"New York, USA"</span>               <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"newyorkcity"</span>,</span>
<span id="cb25-8">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Vancouver, Canada"</span>           <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"vancouver"</span>,</span>
<span id="cb25-9">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Washington DC, USA"</span>          <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"washingtondc"</span></span>
<span id="cb25-10">)</span>
<span id="cb25-11">final_wide<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>location_mapped <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> location_mapping[final_wide<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>location]</span>
<span id="cb25-12"></span>
<span id="cb25-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Merge with bloom dates</span></span>
<span id="cb25-14">final_wide <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">merge</span>(</span>
<span id="cb25-15">  final_wide,</span>
<span id="cb25-16">  combined_blossom_dates[, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"location"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"year"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bloom_doy"</span>)],</span>
<span id="cb25-17">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by.x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"location_mapped"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cherry_year"</span>),</span>
<span id="cb25-18">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"location"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"year"</span>),</span>
<span id="cb25-19">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">all.x =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span></span>
<span id="cb25-20">)</span>
<span id="cb25-21"></span>
<span id="cb25-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Reorder columns to put key variables first</span></span>
<span id="cb25-23">keep_vars <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cherry_year"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"location"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bloom_doy"</span>)</span>
<span id="cb25-24">existing_keep_vars <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> keep_vars[keep_vars <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(final_wide)]</span>
<span id="cb25-25">other_vars <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setdiff</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(final_wide), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(existing_keep_vars, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"location_mapped"</span>))</span>
<span id="cb25-26">final_wide <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> final_wide[, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(existing_keep_vars, other_vars)]</span></code></pre></div>
</div>
</section>
<section id="selecting-and-engineering-features-for-blossom-date-prediction-using-sparse-partial-least-squares" class="level3">
<h3 class="anchored" data-anchor-id="selecting-and-engineering-features-for-blossom-date-prediction-using-sparse-partial-least-squares">9. Selecting and Engineering features for blossom date prediction using sparse Partial Least Squares</h3>
<p>In this section, we use Sparse Partial Least Squares (SPLS) to identify key predictors and extract latent factors that summarize the high-dimensional weather data. We first convert our wide-format dataset into a matrix form and define our predictors and response (bloom day). Next, we perform 10-fold cross-validation to determine the optimal number of latent factors (K) and the sparsity level (eta). With these parameters, we fit the SPLS model to the training data, which selects a subset of predictors and computes a projection matrix. Finally, we use this projection to calculate latent factor scores (e.g., latent1, latent2, etc.) for all observations. These latent factors encapsulate the main variability in the predictors and are then used for further analysis and prediction of the bloom day. Currently we will ignore that this dataset comes from 5 different locations.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Prepare data for SPLS</span></span>
<span id="cb26-2">my_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(final_wide)</span>
<span id="cb26-3">id_cols <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cherry_year"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"location"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bloom_doy"</span>)</span>
<span id="cb26-4"></span>
<span id="cb26-5">predictor_cols <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setdiff</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(my_data), id_cols)</span>
<span id="cb26-6">train_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">subset</span>(my_data, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(bloom_doy))</span>
<span id="cb26-7"></span>
<span id="cb26-8">X_train <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(train_data[, predictor_cols])</span>
<span id="cb26-9">Y_train <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> train_data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>bloom_doy</span>
<span id="cb26-10"></span>
<span id="cb26-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Cross-validation for optimal parameters</span></span>
<span id="cb26-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">123</span>)</span>
<span id="cb26-13">cv.out <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cv.spls</span>(</span>
<span id="cb26-14">  X_train, </span>
<span id="cb26-15">  Y_train,</span>
<span id="cb26-16">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">K   =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,</span>
<span id="cb26-17">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">eta =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>),</span>
<span id="cb26-18">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fold =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span></span>
<span id="cb26-19">)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>eta = 0.1 
eta = 0.2 
eta = 0.3 
eta = 0.4 
eta = 0.5 
eta = 0.6 
eta = 0.7 
eta = 0.8 
eta = 0.9 

Optimal parameters: eta = 0.3, K = 3</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://jbogomolovas2.github.io/Julius-s-Blog/posts/cherry_post/index_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1">optimal_K   <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> cv.out<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>K.opt</span>
<span id="cb28-2">optimal_eta <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> cv.out<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>eta.opt</span>
<span id="cb28-3"></span>
<span id="cb28-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Fit final SPLS model and extract latent factors</span></span>
<span id="cb28-5">final_model <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">spls</span>(X_train, Y_train, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">K =</span> optimal_K, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">eta =</span> optimal_eta)</span>
<span id="cb28-6">X_all <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(my_data[, predictor_cols])</span>
<span id="cb28-7">X_all_std <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sweep</span>(X_all, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, final_model<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>meanx, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">FUN =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"-"</span>)</span>
<span id="cb28-8">X_all_std <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sweep</span>(X_all_std, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, final_model<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>normx, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">FUN =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/"</span>)</span>
<span id="cb28-9">X_all_sub <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> X_all_std[, final_model<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>A, drop <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>]</span>
<span id="cb28-10">latent_all <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> X_all_sub <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span> final_model<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>projection</span>
<span id="cb28-11"></span>
<span id="cb28-12">num_latent <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ncol</span>(latent_all)</span>
<span id="cb28-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(latent_all) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"latent"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_len</span>(num_latent))</span>
<span id="cb28-14"></span>
<span id="cb28-15">latent_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb28-16">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cherry_year =</span> my_data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cherry_year,</span>
<span id="cb28-17">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">location    =</span> my_data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>location,</span>
<span id="cb28-18">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bloom_doy   =</span> my_data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>bloom_doy,</span>
<span id="cb28-19">  latent_all</span>
<span id="cb28-20">)</span></code></pre></div>
</div>
</section>
<section id="model-diagnostics-and-latent-factor-interpretation" class="level3">
<h3 class="anchored" data-anchor-id="model-diagnostics-and-latent-factor-interpretation">10. Model Diagnostics and Latent Factor Interpretation</h3>
<p>In this section, we first assess the performance of our Sparse PLS model using training data. We compute key statistics—such as R², RMSE, and MAE—to gauge how well the model explains the variance in the bloom day (with a higher R² indicating a better fit).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Predict on training data</span></span>
<span id="cb29-2">y_pred_train <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(final_model, X_train)</span>
<span id="cb29-3">SST <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>((Y_train <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(Y_train))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb29-4">SSE <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>((Y_train <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> y_pred_train)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb29-5">R2_train <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> SSE<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>SST</span>
<span id="cb29-6"></span>
<span id="cb29-7">MAE_train <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abs</span>(Y_train <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> y_pred_train))</span>
<span id="cb29-8">RMSE_train <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>((Y_train <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> y_pred_train)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span>
<span id="cb29-9">n_selected_vars <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(final_model<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>A)</span>
<span id="cb29-10">percent_vars_selected <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> (n_selected_vars <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(predictor_cols)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span></span>
<span id="cb29-11"></span>
<span id="cb29-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create diagnostic plot with statistics</span></span>
<span id="cb29-13">stats_text <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(</span>
<span id="cb29-14">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"R² = "</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(R2_train, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>,</span>
<span id="cb29-15">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RMSE = "</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(RMSE_train, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" days</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>,</span>
<span id="cb29-16">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"MAE = "</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(MAE_train, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" days</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>,</span>
<span id="cb29-17">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Variables: "</span>, n_selected_vars, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(predictor_cols), </span>
<span id="cb29-18">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" ("</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(percent_vars_selected, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"%)"</span></span>
<span id="cb29-19">)</span>
<span id="cb29-20"></span>
<span id="cb29-21"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Actual =</span> Y_train, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Predicted =</span> y_pred_train), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> Actual, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> Predicted)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb29-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb29-23">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_abline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">intercept =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">slope =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dashed"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb29-24">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">annotate</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(Y_train) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(y_pred_train) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, </span>
<span id="cb29-25">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> stats_text, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">vjust =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,</span>
<span id="cb29-26">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb29-27">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb29-28">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Predicted vs Actual Bloom Day"</span>,</span>
<span id="cb29-29">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Actual Bloom DOY"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Predicted Bloom DOY"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://jbogomolovas2.github.io/Julius-s-Blog/posts/cherry_post/index_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Not so shabby! Now lets examine the latent factors:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Latent Factor Interpretation</span></span>
<span id="cb30-2"></span>
<span id="cb30-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Parse the projection matrix from the SPLS model</span></span>
<span id="cb30-4">proj_mat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> final_model<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>projection</span>
<span id="cb30-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Each row name is in the form "temp_ave_pos_rollsum_123"</span></span>
<span id="cb30-6">parsed <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_match</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(proj_mat), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"^(.*)_(</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">d+)$"</span>)</span>
<span id="cb30-7">group_names <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> parsed[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]           <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># e.g., "temp_ave_pos_rollsum"</span></span>
<span id="cb30-8">day_indices <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(parsed[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>])  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># day number</span></span>
<span id="cb30-9"></span>
<span id="cb30-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a data frame of loadings with associated group and day</span></span>
<span id="cb30-11">df_proj <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(proj_mat)</span>
<span id="cb30-12">df_proj<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>group <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> group_names</span>
<span id="cb30-13">df_proj<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>day   <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> day_indices</span>
<span id="cb30-14"></span>
<span id="cb30-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Rename factor columns for clarity</span></span>
<span id="cb30-16">n_fac <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ncol</span>(proj_mat)</span>
<span id="cb30-17"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(df_proj)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>n_fac] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Factor"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_len</span>(n_fac))</span>
<span id="cb30-18"></span>
<span id="cb30-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Pivot the data to long format: each row becomes (group, day, factor, loading)</span></span>
<span id="cb30-20">df_long <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(df_proj, </span>
<span id="cb30-21">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cols =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">starts_with</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Factor"</span>),</span>
<span id="cb30-22">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"factor"</span>,</span>
<span id="cb30-23">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"loading"</span>)</span>
<span id="cb30-24"></span>
<span id="cb30-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Build a complete grid for all groups, days (1:366), and factors</span></span>
<span id="cb30-26">all_groups <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"temp_ave_pos_rollsum"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"temp_ave_neg_rollsum"</span>, </span>
<span id="cb30-27">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"temp_max_pos_rollsum"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"temp_max_neg_rollsum"</span>, </span>
<span id="cb30-28">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"temp_min_pos_rollsum"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"temp_min_neg_rollsum"</span>, </span>
<span id="cb30-29">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"prcp_pos_rollsum"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"prcp_neg_rollsum"</span>)</span>
<span id="cb30-30">all_factors <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(df_long<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>factor)</span>
<span id="cb30-31">grid_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">expand.grid</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">group =</span> all_groups, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">day =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">366</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">factor =</span> all_factors, </span>
<span id="cb30-32">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">stringsAsFactors =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)</span>
<span id="cb30-33"></span>
<span id="cb30-34"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Merge grid with loadings to include missing combinations as NA</span></span>
<span id="cb30-35">df_plot <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(grid_df, df_long, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"group"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"day"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"factor"</span>))</span>
<span id="cb30-36"></span>
<span id="cb30-37"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert day index to a date for plotting; day 1 corresponds to April 10</span></span>
<span id="cb30-38">base_date <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.Date</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2020-04-10"</span>)</span>
<span id="cb30-39">df_plot<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>date <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> base_date <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (df_plot<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>day <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb30-40"></span>
<span id="cb30-41"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Extract variable type and anomaly direction from group name</span></span>
<span id="cb30-42">df_plot <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df_plot <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb30-43">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb30-44">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gsub</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_pos_rollsum.*|_neg_rollsum.*"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, group),</span>
<span id="cb30-45">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">anomaly =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grepl</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_pos_"</span>, group), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pos"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"neg"</span>)</span>
<span id="cb30-46">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb30-47">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(type, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"temp_min"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"temp_ave"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"temp_max"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"prcp"</span>)),</span>
<span id="cb30-48">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">anomaly =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(anomaly, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pos"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"neg"</span>)))</span>
<span id="cb30-49"></span>
<span id="cb30-50"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Heatmap of latent factor loadings</span></span>
<span id="cb30-51">p_heatmap <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(df_plot, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> date, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> anomaly, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> loading)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb30-52">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_tile</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb30-53">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_grid</span>(type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> factor) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb30-54">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_date</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">date_breaks =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2 months"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">date_labels =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"%b"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Show every 2nd month</span></span>
<span id="cb30-55">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_gradient2</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">low =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"blue"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mid =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">high =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midpoint =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, </span>
<span id="cb30-56">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.value =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey90"</span>,</span>
<span id="cb30-57">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> scales<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_number</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">accuracy =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0001</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb30-58">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Heatmap of SPLS Loadings by Factor and Variable Type"</span>,</span>
<span id="cb30-59">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Months"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Anomaly (pos vs neg)"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Loading"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb30-60">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>()</span></code></pre></div>
</div>
<p>These factors summarize the original rolling sum predictors, showing clear patterns. Negative temperature anomalies accumulated before the median bloom date load negatively; since these sums are negative, a larger accumulation of cold days actually delays blooming. In contrast, higher rolling sums of positive temperature anomalies—indicating warmer days—load negatively, which means that more warm days speed up the bloom. Additionally, the model captures a dormancy effect: a buildup of cold days in October and November tends to lead to an earlier bloom the following year. Similarly, lower-than-average precipitation starting in December is associated with earlier blooming. This interpretation confirms that the latent factors meaningfully reflect the influence of weather on cherry blossom timing.</p>
<p>Now let’s examine how these latent factors cluster by location. Although our SPLS model was built on the combined dataset—ignoring that measurements come from five different sites with potentially different responses—we can still see some separation. For instance, the third latent factor reveals that different sites tend to occupy distinct regions in the factor space. This variability indicates that site-specific responses exist, which is why we ultimately use a generalized additive model (GAM) to flexibly capture these differences in our final analysis.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1) Reshape data so each latent factor is in its own row</span></span>
<span id="cb31-2">latent_long <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> latent_df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb31-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(</span>
<span id="cb31-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cols =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">starts_with</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"latent"</span>),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># or c("latent1", "latent2", "latent3")</span></span>
<span id="cb31-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"factor"</span>,</span>
<span id="cb31-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"score"</span></span>
<span id="cb31-7">  )</span>
<span id="cb31-8"></span>
<span id="cb31-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 2) Create the scatter plot, facet by factor</span></span>
<span id="cb31-10">p <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(latent_long, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> bloom_doy, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> score, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> location)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb31-11">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Use na.rm=TRUE so rows with NA in bloom_doy or score are simply not plotted</span></span>
<span id="cb31-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.rm =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb31-13">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Optional: add a smoothing trend line for each location</span></span>
<span id="cb31-14">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># geom_smooth(method = "lm", se = FALSE, na.rm = TRUE)</span></span>
<span id="cb31-15"></span>
<span id="cb31-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> factor, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scales =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free_y"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb31-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(</span>
<span id="cb31-18">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Bloom Day vs. Latent Factor Scores"</span>,</span>
<span id="cb31-19">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Bloom Day of Year"</span>,</span>
<span id="cb31-20">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Latent Factor Score"</span>,</span>
<span id="cb31-21">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Location"</span></span>
<span id="cb31-22">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb31-23">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>()</span>
<span id="cb31-24"></span>
<span id="cb31-25"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(p)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://jbogomolovas2.github.io/Julius-s-Blog/posts/cherry_post/index_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Although our SPLS model was built on the combined dataset—ignoring that measurements come from five different sites with potentially different responses—we can still see some separation. For instance, the third latent factor reveals that different sites tend to occupy distinct regions in the factor space. This variability indicates that site-specific responses exist, which is why we ultimately use a generalized additive model (GAM) to flexibly capture these differences in our final analysis.</p>
</section>
<section id="dynamic-gam-modeling-for-forecasting" class="level3">
<h3 class="anchored" data-anchor-id="dynamic-gam-modeling-for-forecasting">11. Dynamic GAM Modeling for Forecasting</h3>
<p><strong>Dynamic GAM Modeling for Location-Specific Latent Factor Adaptation</strong></p>
<p>We now have three powerful latent factors from our SPLS analysis that capture the main weather patterns driving cherry blossom variability. However, these factors were derived as linear predictors from data pooled across all five locations, assuming each site responds identically to the same weather patterns.</p>
<p><strong>The problem:</strong>&nbsp;Real cherry trees don’t follow universal rules. Each location likely has its own unique sensitivity to weather - Kyoto’s cherry blossoms might respond differently to warming than Vancouver’s, and some locations have frustratingly sparse observations that make traditional modeling challenging.</p>
<p><strong>The approach:</strong>&nbsp;So I decided to go with <code>mvgam</code> <span class="citation" data-cites="mvgam">(Clark and Wells 2023)</span>. <code>mvgam</code> stands for MultiVariate (Dynamic) Generalized Additive Models and is specifically designed for time series analysis like ours:</p>
<ol type="1">
<li><p><strong>Time series focus</strong>: Specifically designed for time series prediction with built-in capabilities to model autocorrelation if needed.</p></li>
<li><p><strong>GAM flexibility</strong>: At its core, it’s still a GAM, making it ideal for bending our otherwise linear latent factors to each location individually.</p></li>
<li><p><strong>State-space robustness</strong>: The state-space modeling framework is perfect for time series with missing observations. It models the underlying bloom process separately from the observations, so our sparse New York and Vancouver data doesn’t break the model—missing data areas handled by modeling the latent bloom process as it evolves through time.</p></li>
<li><p><strong>Bayesian uncertainty</strong>: The Bayesian framework provides natural uncertainty quantification for both parameters and predictions.</p></li>
</ol>
<p><strong>Data preparation and model setup</strong></p>
<p>First, I split my data into training and testing sets at 2024 to ensure at least one bloom date for each location in our forecast evaluation. For state-space modeling, I need both&nbsp;<code>series</code>&nbsp;(to identify different time series) and&nbsp;<code>trend</code>&nbsp;(for the process formula) variables.</p>
<p>My model structure uses shrinkage smooths (<code>bs="sz"</code>) to handle the location-specific responses. For example,&nbsp;<code>s(latent1, k=3)</code>&nbsp;creates the main smooth effect of latent1, while&nbsp;<code>s(trend, latent1, bs="sz", k=3)</code>&nbsp;adds location-specific deviations. The “sz” basis applies shrinkage - locations with sparse data have their specific effects shrunk toward zero, essentially borrowing the response pattern from data-rich locations. Meanwhile, Kyoto and others with complete records can maintain their unique response curves.</p>
<p>Let’s prepare the data and fit the model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> latent_df</span>
<span id="cb32-2">df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>location <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.factor</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>location)</span>
<span id="cb32-3">df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>series <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>location  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Keep series for identifying time series</span></span>
<span id="cb32-4">df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>trend <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>location   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add trend for trend_formula</span></span>
<span id="cb32-5">df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>time <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cherry_year <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1981</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#For numerical stability</span></span>
<span id="cb32-6"></span>
<span id="cb32-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Split data into training (&lt;2024) and testing (&gt;=2024)</span></span>
<span id="cb32-8">train_mvgam <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df[df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cherry_year <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2024</span>, ]</span>
<span id="cb32-9">test_mvgam  <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df[df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cherry_year <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2024</span>, ]</span>
<span id="cb32-10"></span>
<span id="cb32-11"></span>
<span id="cb32-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Now fit with tweaked priors</span></span>
<span id="cb32-13">model_gaussian <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mvgam</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">formula =</span> bloom_doy <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> series,</span>
<span id="cb32-14">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">trend_formula =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">s</span>(latent1, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">k=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">s</span>(trend, latent1, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bs=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sz"</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">k=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb32-15">                           <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">s</span>(latent2, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">k=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">s</span>(trend, latent2, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bs=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sz"</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">k=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb32-16">                           <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">s</span>(latent3, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">k=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">s</span>(trend, latent3, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bs=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sz"</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">k=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>),</span>
<span id="cb32-17">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> train_mvgam,</span>
<span id="cb32-18">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> test_mvgam,</span>
<span id="cb32-19">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">noncentred =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,</span>
<span id="cb32-20">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gaussian</span>(),<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">silent =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span></code></pre></div>
</div>
<p>Let’s examine the model diagnostics:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(model_gaussian, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">include_betas =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>GAM observation formula:
bloom_doy ~ series

GAM process formula:
~s(latent1, k = 3) + s(trend, latent1, bs = "sz", k = 3) + s(latent2, 
    k = 3) + s(trend, latent2, bs = "sz", k = 3) + s(latent3, 
    k = 3) + s(trend, latent3, bs = "sz", k = 3)

Family:
gaussian

Link function:
identity

Trend model:
None

N process models:
5 

N series:
5 

N timepoints:
45 

Status:
Fitted using Stan 
4 chains, each with iter = 1000; warmup = 500; thin = 1 
Total post-warmup draws = 2000


Observation error parameter estimates:
             2.5%  50% 97.5% Rhat n_eff
sigma_obs[1] 0.91 2.30   3.0 1.05    61
sigma_obs[2] 2.30 3.50   4.7 1.01   350
sigma_obs[3] 5.70 8.30  14.0 1.00  1538
sigma_obs[4] 0.15 0.95   5.7 1.01   591
sigma_obs[5] 1.10 3.40   4.4 1.09    45

GAM observation model coefficient (beta) estimates:
                                   2.5%   50% 97.5% Rhat n_eff
(Intercept)                        88.0 94.00  99.0    1  1148
seriesLiestal-Weideli, Switzerland -4.8 -1.70   1.1    1   956
seriesNew York, USA                -2.6  0.81   4.9    1  1569
seriesVancouver, Canada            -4.4 -1.40   1.7    1   844
seriesWashington DC, USA           -5.5 -1.70   2.0    1  1339

Process error parameter estimates:
           2.5%  50% 97.5% Rhat n_eff
sigma[1] 0.0160 0.38   2.1 1.05    71
sigma[2] 0.0180 0.41   2.4 1.01   292
sigma[3] 0.0092 0.34   2.0 1.00  2775
sigma[4] 0.0160 0.48   2.1 1.00  1250
sigma[5] 0.0140 0.43   3.2 1.11    40

GAM process model coefficient (beta) estimates:
                  2.5%   50% 97.5% Rhat n_eff
(Intercept)_trend -5.1 0.076   5.5    1  1396

Approximate significance of GAM process smooths:
                   edf Ref.df  Chi.sq p-value    
s(latent1)        1.01      2 4706.30 &lt; 2e-16 ***
s(series,latent1) 7.61     12  128.89    0.36    
s(latent2)        1.02      2  638.76 &lt; 2e-16 ***
s(series,latent2) 3.31     12    1.97    1.00    
s(latent3)        1.01      2  291.30 1.7e-05 ***
s(series,latent3) 1.59     12    1.37    1.00    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Stan MCMC diagnostics:
✔ No issues with effective samples per iteration
✖ Rhats above 1.05 found for some parameters
    Use pairs() and mcmc_plot() to investigate
✖ 105 of 2000 iterations ended with a divergence (5.25%)
    Try a larger adapt_delta to remove divergences
✔ No issues with maximum tree depth

Samples were drawn using sampling(hmc). For each parameter, n_eff is a
  crude measure of effective sample size, and Rhat is the potential scale
  reduction factor on split MCMC chains (at convergence, Rhat = 1)

Use how_to_cite() to get started describing this model</code></pre>
</div>
</div>
<p>The model shows severe convergence issues. Several variance parameters (sigmas) from both the observation and process models are poorly identified, with terrible effective sample sizes and Rhat values. Let me unpack what’s happening here. In our state-space formulation:</p>
<p>The baseline: Without weather effects, each location would bloom on roughly the same day every year (captured by the location intercepts) The process model: Our SPLS-derived latent factors predict deviations from this baseline. The process error represents additional year-to-year variation not captured by weather - perhaps soil conditions, tree age, or other unmeasured factors The observation model: This is where bloom dates actually get recorded. The observation error represents how much our weather-based predictions miss the true bloom dates</p>
<p>The identifiability crisis occurs because the model can explain the same bloom variability in multiple ways. High process error + low observation error? Low process error + high observation error? Without constraints, the model can’t decide. Here’s the key insight: Our SPLS model achieved good R² and MAE when fitted on pooled data from all locations. This means it captures the “average” weather-bloom relationship well, but likely misses location-specific nuances by roughly the same amount everywhere. The observation error is essentially quantifying “how wrong is our one-size-fits-all weather model?” By setting share_obs_params = TRUE, I enforce this logic: all locations share the same observation variance because they all use the same pooled SPLS model. This constraint breaks the identifiability problem while still allowing location-specific process errors to capture unique temporal patterns. Additionally, with 19% of iterations ending in divergences, I’ll increase adapt_delta to 0.99, max_treedepth to 12, and number of iterations for more careful exploration of the posterior:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1">model_shared_sz <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mvgam</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">formula =</span> bloom_doy <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> series,</span>
<span id="cb35-2">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">trend_formula =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">s</span>(latent1, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">k=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">s</span>(trend, latent1, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bs=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sz"</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">k=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb35-3">                           <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">s</span>(latent2, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">k=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">s</span>(trend, latent2, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bs=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sz"</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">k=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb35-4">                           <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">s</span>(latent3, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">k=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">s</span>(trend, latent3, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bs=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sz"</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">k=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>),</span>
<span id="cb35-5">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> train_mvgam,</span>
<span id="cb35-6">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> test_mvgam,</span>
<span id="cb35-7">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">share_obs_params =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,</span>
<span id="cb35-8">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">noncentred =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,</span>
<span id="cb35-9">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">control =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">adapt_delta =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.99</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">max_treedepth =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>),</span>
<span id="cb35-10">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">burnin =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span>,</span>
<span id="cb35-11">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">samples =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2000</span>,</span>
<span id="cb35-12">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gaussian</span>(),<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">silent =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb35-13"></span>
<span id="cb35-14"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(model_shared_sz, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">include_betas =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>GAM observation formula:
bloom_doy ~ series

GAM process formula:
~s(latent1, k = 3) + s(trend, latent1, bs = "sz", k = 3) + s(latent2, 
    k = 3) + s(trend, latent2, bs = "sz", k = 3) + s(latent3, 
    k = 3) + s(trend, latent3, bs = "sz", k = 3)

Family:
gaussian

Link function:
identity

Trend model:
None

N process models:
5 

N series:
5 

N timepoints:
45 

Status:
Fitted using Stan 
4 chains, each with iter = 2500; warmup = 500; thin = 1 
Total post-warmup draws = 8000


Observation error parameter estimates:
          2.5% 50% 97.5% Rhat n_eff
sigma_obs  2.7 3.2   3.8    1   846

GAM observation model coefficient (beta) estimates:
                                   2.5%   50% 97.5% Rhat n_eff
(Intercept)                        88.0 94.00  99.0    1  2749
seriesLiestal-Weideli, Switzerland -5.1 -1.60   1.5    1  3642
seriesNew York, USA                -2.5  0.74   4.3    1  3997
seriesVancouver, Canada            -4.8 -0.90   2.5    1  6999
seriesWashington DC, USA           -5.8 -1.30   2.7    1  3233

Process error parameter estimates:
           2.5%  50% 97.5% Rhat n_eff
sigma[1] 0.0098 0.25   1.1    1  7133
sigma[2] 0.0170 0.43   2.1    1  1938
sigma[3] 0.5900 4.40   6.7    1   424
sigma[4] 0.0120 0.34   1.8    1 12251
sigma[5] 0.0130 0.41   2.0    1  2242

GAM process model coefficient (beta) estimates:
                  2.5%   50% 97.5% Rhat n_eff
(Intercept)_trend -5.4 0.045   5.2    1  3020

Approximate significance of GAM process smooths:
                    edf Ref.df  Chi.sq p-value    
s(latent1)        1.009      2 4027.93 &lt; 2e-16 ***
s(series,latent1) 7.792     12  233.66    0.12    
s(latent2)        1.082      2  635.27 &lt; 2e-16 ***
s(series,latent2) 3.099     12    2.42    1.00    
s(latent3)        0.999      2  296.04 3.4e-05 ***
s(series,latent3) 2.233     12    1.09    1.00    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Stan MCMC diagnostics:
✔ No issues with effective samples per iteration
✔ Rhat looks good for all parameters
✔ No issues with divergences
✔ No issues with maximum tree depth

Samples were drawn using sampling(hmc). For each parameter, n_eff is a
  crude measure of effective sample size, and Rhat is the potential scale
  reduction factor on split MCMC chains (at convergence, Rhat = 1)

Use how_to_cite() to get started describing this model</code></pre>
</div>
<div class="sourceCode cell-code" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1">gratia<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">draw</span>(model_shared_sz, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">trend_effects=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://jbogomolovas2.github.io/Julius-s-Blog/posts/cherry_post/index_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
<p>The enhanced sampling and shared observation parameters completely fixed our convergence issues. All parameters now have excellent effective sample sizes and Rhat values of 1.00. The shared observation error settled at about 3.2 days (pretty much as MAE of joint SPLS model) - this represents how much our weather-based predictions typically miss the actual bloom dates. Looking at the smooth effects, the main patterns are beautifully linear, exactly as expected from our SPLS-derived factors. Each latent factor shows a strong linear relationship with bloom timing (all p &lt; 0.001). The location-specific deviations (s(series,latent) terms) aren’t statistically significant, which isn’t surprising given our limited data. However, they still capture subtle location-specific responses that contribute to more accurate predictions.</p>
<p>So lets now run predictions for 2025 and compare with real data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Forecast</span></span>
<span id="cb38-2">fc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">forecast</span>(model_shared_sz, test_mvgam)</span>
<span id="cb38-3"></span>
<span id="cb38-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Map full location names to short names for predictions</span></span>
<span id="cb38-5">location_mapping <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(</span>
<span id="cb38-6">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Kyoto, Japan"</span>                <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"kyoto"</span>,</span>
<span id="cb38-7">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Liestal-Weideli, Switzerland"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"liestal"</span>,</span>
<span id="cb38-8">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"New York, USA"</span>               <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"newyorkcity"</span>,</span>
<span id="cb38-9">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Vancouver, Canada"</span>           <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"vancouver"</span>,</span>
<span id="cb38-10">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Washington DC, USA"</span>          <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"washingtondc"</span></span>
<span id="cb38-11">)</span>
<span id="cb38-12"></span>
<span id="cb38-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create dataframe with actual 2025 bloom dates</span></span>
<span id="cb38-14">actual_2025 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb38-15">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">location =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"liestal"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"vancouver"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"kyoto"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"washingtondc"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"newyorkcity"</span>),</span>
<span id="cb38-16">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">actual_date =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.Date</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2025-03-27"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2025-04-03"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2025-04-04"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2025-03-28"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2025-04-04"</span>)),</span>
<span id="cb38-17">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">actual_doy =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">86</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">93</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">94</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">87</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">94</span>),</span>
<span id="cb38-18">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">stringsAsFactors =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span></span>
<span id="cb38-19">)</span>
<span id="cb38-20"></span>
<span id="cb38-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Extract posterior draws for all locations</span></span>
<span id="cb38-22">posterior_draws <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>()</span>
<span id="cb38-23"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> (i <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_along</span>(fc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>series_names)) {</span>
<span id="cb38-24">  full_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.character</span>(fc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>series_names[i])</span>
<span id="cb38-25">  short_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> location_mapping[full_name]</span>
<span id="cb38-26">  posterior_draws[[short_name]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> fc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>forecasts[[i]][, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 2025 predictions</span></span>
<span id="cb38-27">}</span>
<span id="cb38-28"></span>
<span id="cb38-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert to long format for plotting</span></span>
<span id="cb38-30">draws_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb38-31">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unlist</span>(posterior_draws),</span>
<span id="cb38-32">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">location =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(posterior_draws), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">each =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(posterior_draws[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]]))</span>
<span id="cb38-33">)</span>
<span id="cb38-34"></span>
<span id="cb38-35"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add actual values</span></span>
<span id="cb38-36">draws_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">merge</span>(draws_df, actual_2025[, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"location"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"actual_doy"</span>)], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"location"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">all.x =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb38-37"></span>
<span id="cb38-38"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add proper location names</span></span>
<span id="cb38-39">draws_df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>location_full <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(draws_df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>location, </span>
<span id="cb38-40">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"kyoto"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"liestal"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"newyorkcity"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"vancouver"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"washingtondc"</span>),</span>
<span id="cb38-41">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Kyoto, Japan"</span>, </span>
<span id="cb38-42">             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Liestal, Switzerland"</span>, </span>
<span id="cb38-43">             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"New York City, USA"</span>, </span>
<span id="cb38-44">             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Vancouver, Canada"</span>, </span>
<span id="cb38-45">             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Washington DC, USA"</span>))</span>
<span id="cb38-46"></span>
<span id="cb38-47"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate summary statistics with rounded differences</span></span>
<span id="cb38-48">summary_stats <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> draws_df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb38-49">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(location_full, actual_doy) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb38-50">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise</span>(</span>
<span id="cb38-51">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">median_pred =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median</span>(value),</span>
<span id="cb38-52">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mean_pred =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(value),</span>
<span id="cb38-53">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.groups =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'drop'</span></span>
<span id="cb38-54">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb38-55">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb38-56">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">diff =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(median_pred <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> actual_doy, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>),</span>
<span id="cb38-57">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">diff_text =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(</span>
<span id="cb38-58">      diff <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"+"</span>, diff, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" days"</span>),</span>
<span id="cb38-59">      diff <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(diff, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" days"</span>),</span>
<span id="cb38-60">      <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Perfect!"</span></span>
<span id="cb38-61">    )</span>
<span id="cb38-62">  )</span>
<span id="cb38-63"></span>
<span id="cb38-64"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create the plot</span></span>
<span id="cb38-65">p_presentation <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb38-66">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Density plots</span></span>
<span id="cb38-67">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_density</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> draws_df, </span>
<span id="cb38-68">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> value, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> location_full), </span>
<span id="cb38-69">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>,</span>
<span id="cb38-70">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>,</span>
<span id="cb38-71">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb38-72">  </span>
<span id="cb38-73">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Actual date lines</span></span>
<span id="cb38-74">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_segment</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> summary_stats,</span>
<span id="cb38-75">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> actual_doy, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xend =</span> actual_doy, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yend =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">Inf</span>),</span>
<span id="cb38-76">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>, </span>
<span id="cb38-77">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>,</span>
<span id="cb38-78">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"solid"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb38-79">  </span>
<span id="cb38-80">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Error labels</span></span>
<span id="cb38-81">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_label</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> summary_stats,</span>
<span id="cb38-82">             <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> actual_doy <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">Inf</span>, </span>
<span id="cb38-83">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(diff <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Spot on!"</span>, diff_text)),</span>
<span id="cb38-84">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">vjust =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>,</span>
<span id="cb38-85">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,</span>
<span id="cb38-86">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fontface =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>,</span>
<span id="cb38-87">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>,</span>
<span id="cb38-88">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>,</span>
<span id="cb38-89">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label.padding =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lines"</span>),</span>
<span id="cb38-90">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label.size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb38-91">  </span>
<span id="cb38-92">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> location_full, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scales =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free_y"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb38-93">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#2E7D32"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#1976D2"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#D32F2F"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#7B1FA2"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#F57C00"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb38-94">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_cartesian</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlim =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">78</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">112</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># This prevents cutting off distributions</span></span>
<span id="cb38-95">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">breaks =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">80</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">110</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb38-96">  </span>
<span id="cb38-97">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2025 Cherry Blossom Predictions vs Reality"</span>,</span>
<span id="cb38-98">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Day of Year (vertical line = actual bloom date)"</span>,</span>
<span id="cb38-99">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb38-100">  </span>
<span id="cb38-101">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb38-102">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(</span>
<span id="cb38-103">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>,</span>
<span id="cb38-104">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>),</span>
<span id="cb38-105">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">strip.text =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>),</span>
<span id="cb38-106">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(),</span>
<span id="cb38-107">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text.x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>),</span>
<span id="cb38-108">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.grid =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(),</span>
<span id="cb38-109">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.spacing =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lines"</span>),</span>
<span id="cb38-110">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.margin =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">margin</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>)</span>
<span id="cb38-111">  )</span>
<span id="cb38-112"></span>
<span id="cb38-113"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Display the plot</span></span>
<span id="cb38-114"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(p_presentation)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://jbogomolovas2.github.io/Julius-s-Blog/posts/cherry_post/index_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
<p>Two perfect predictions (Kyoto and Vancouver), and the rest within a week - not bad for a model predicting a complex biological phenomenon months in advance. What started as a challenge to predict cherry blossoms using weather anomalies has demonstrated the power of combining dimensional reduction (SPLS) with flexible modeling (mvgam). The approach successfully handled the twin challenges of high-dimensional weather data and sparse observations, delivering predictions with well-calibrated uncertainty. Most satisfying is that the locations with the least data (New York and Vancouver) performed just as well as data-rich sites - proof that our shrinkage approach effectively borrowed strength across locations. Cherry trees may not follow universal rules, but with the right modeling framework, we can still capture their unique responses to weather patterns</p>
<div class="cell">
<div class="cell-output-display">
<p>We used R version 4.5.1 <span class="citation" data-cites="base">(R Core Team 2025)</span> and the following R packages: data.table v. 1.17.6 <span class="citation" data-cites="datatable">(Barrett et al. 2025)</span>, gratia v. 0.10.0 <span class="citation" data-cites="gratia">(Simpson 2024)</span>, missForest v. 1.5 <span class="citation" data-cites="missForest2012 missForest2022">(Stekhoven and Buehlmann 2012; Stekhoven 2022)</span>, mvgam v. 1.1.51 <span class="citation" data-cites="mvgam">(Clark and Wells 2023)</span>, nasapower v. 4.2.5 <span class="citation" data-cites="nasapower">(Sparks 2018)</span>, rmarkdown v. 2.29 <span class="citation" data-cites="rmarkdown2018 rmarkdown2020 rmarkdown2024">(Xie, Allaire, and Grolemund 2018; Xie, Dervieux, and Riederer 2020; Allaire et al. 2024)</span>, scales v. 1.4.0 <span class="citation" data-cites="scales">(Wickham, Pedersen, and Seidel 2025)</span>, spls v. 2.2.3 <span class="citation" data-cites="spls">(Chung, Chun, and Keles 2019)</span>, tidyverse v. 2.0.0 <span class="citation" data-cites="tidyverse">(Wickham et al. 2019)</span>.</p>
</div>
</div>



</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0">
<div id="ref-rmarkdown2024" class="csl-entry">
Allaire, JJ, Yihui Xie, Christophe Dervieux, Jonathan McPherson, Javier Luraschi, Kevin Ushey, Aron Atkins, et al. 2024. <em><span class="nocase">rmarkdown</span>: Dynamic Documents for r</em>. <a href="https://github.com/rstudio/rmarkdown">https://github.com/rstudio/rmarkdown</a>.
</div>
<div id="ref-datatable" class="csl-entry">
Barrett, Tyson, Matt Dowle, Arun Srinivasan, Jan Gorecki, Michael Chirico, Toby Hocking, Benjamin Schwendinger, and Ivan Krylov. 2025. <em><span class="nocase">data.table</span>: Extension of <span>“<span class="nocase">data.frame</span>”</span></em>. <a href="https://doi.org/10.32614/CRAN.package.data.table">https://doi.org/10.32614/CRAN.package.data.table</a>.
</div>
<div id="ref-spls" class="csl-entry">
Chung, Dongjun, Hyonho Chun, and Sunduz Keles. 2019. <em><span class="nocase">spls</span>: Sparse Partial Least Squares (SPLS) Regression and Classification</em>. <a href="https://doi.org/10.32614/CRAN.package.spls">https://doi.org/10.32614/CRAN.package.spls</a>.
</div>
<div id="ref-mvgam" class="csl-entry">
Clark, Nicholas J, and Konstans Wells. 2023. <span>“Dynamic Generalized Additive Models (DGAMs) for Forecasting Discrete Ecological Time Series.”</span> <em>Methods in Ecology and Evolution</em> 14: 771–84. <a href="https://doi.org/10.18637/jss.v100.i05">https://doi.org/10.18637/jss.v100.i05</a>.
</div>
<div id="ref-base" class="csl-entry">
R Core Team. 2025. <em><span>R</span>: A Language and Environment for Statistical Computing</em>. Vienna, Austria: R Foundation for Statistical Computing. <a href="https://www.R-project.org/">https://www.R-project.org/</a>.
</div>
<div id="ref-gratia" class="csl-entry">
Simpson, Gavin L. 2024. <em><span class="nocase">gratia</span>: Graceful <span class="nocase">ggplot</span>-Based Graphics and Other Functions for <span>GAM</span>s Fitted Using <span class="nocase">mgcv</span></em>. <a href="https://gavinsimpson.github.io/gratia/">https://gavinsimpson.github.io/gratia/</a>.
</div>
<div id="ref-nasapower" class="csl-entry">
Sparks, Adam H. 2018. <span>“<span class="nocase">nasapower</span>: A NASA POWER Global Meteorology, Surface Solar Energy and Climatology Data Client for r.”</span> <em>The Journal of Open Source Software</em> 3 (30): 1035. <a href="https://doi.org/10.21105/joss.01035">https://doi.org/10.21105/joss.01035</a>.
</div>
<div id="ref-missForest2022" class="csl-entry">
Stekhoven, Daniel J. 2022. <em><span class="nocase">missForest</span>: Nonparametric Missing Value Imputation Using Random Forest</em>.
</div>
<div id="ref-missForest2012" class="csl-entry">
Stekhoven, Daniel J., and Peter Buehlmann. 2012. <span>“MissForest - Non-Parametric Missing Value Imputation for Mixed-Type Data.”</span> <em>Bioinformatics</em> 28 (1): 112–18.
</div>
<div id="ref-tidyverse" class="csl-entry">
Wickham, Hadley, Mara Averick, Jennifer Bryan, Winston Chang, Lucy D’Agostino McGowan, Romain François, Garrett Grolemund, et al. 2019. <span>“Welcome to the <span class="nocase">tidyverse</span>.”</span> <em>Journal of Open Source Software</em> 4 (43): 1686. <a href="https://doi.org/10.21105/joss.01686">https://doi.org/10.21105/joss.01686</a>.
</div>
<div id="ref-scales" class="csl-entry">
Wickham, Hadley, Thomas Lin Pedersen, and Dana Seidel. 2025. <em><span class="nocase">scales</span>: Scale Functions for Visualization</em>. <a href="https://doi.org/10.32614/CRAN.package.scales">https://doi.org/10.32614/CRAN.package.scales</a>.
</div>
<div id="ref-rmarkdown2018" class="csl-entry">
Xie, Yihui, J. J. Allaire, and Garrett Grolemund. 2018. <em>R Markdown: The Definitive Guide</em>. Boca Raton, Florida: Chapman; Hall/CRC. <a href="https://bookdown.org/yihui/rmarkdown">https://bookdown.org/yihui/rmarkdown</a>.
</div>
<div id="ref-rmarkdown2020" class="csl-entry">
Xie, Yihui, Christophe Dervieux, and Emily Riederer. 2020. <em>R Markdown Cookbook</em>. Boca Raton, Florida: Chapman; Hall/CRC. <a href="https://bookdown.org/yihui/rmarkdown-cookbook">https://bookdown.org/yihui/rmarkdown-cookbook</a>.
</div>
</div></section></div> ]]></description>
  <guid>https://jbogomolovas2.github.io/Julius-s-Blog/posts/cherry_post/</guid>
  <pubDate>Tue, 25 Feb 2025 08:00:00 GMT</pubDate>
  <media:content url="https://jbogomolovas2.github.io/Julius-s-Blog/posts/cherry_post/blossom.png" medium="image" type="image/png" height="96" width="144"/>
</item>
</channel>
</rss>
