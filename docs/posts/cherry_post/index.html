<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Julijus Bogomolovas">
<meta name="dcterms.date" content="2025-07-07">

<title>Cherry Bloom Prediction – Julius’s Blog</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-c1fac2584b48ed01fb6e278e36375074.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="Cherry Bloom Prediction – Julius’s Blog">
<meta property="og:description" content="Data Science, Swimming Analytics, and R Programming">
<meta property="og:image" content="https://jbogomolovas2.github.io/Julius-s-Blog/posts/cherry_post/blossom.png">
<meta property="og:site_name" content="Julius's Blog">
<meta property="og:image:height" content="1024">
<meta property="og:image:width" content="1536">
<meta name="twitter:title" content="Cherry Bloom Prediction – Julius’s Blog">
<meta name="twitter:description" content="Data Science, Swimming Analytics, and R Programming">
<meta name="twitter:image" content="https://jbogomolovas2.github.io/Julius-s-Blog/posts/cherry_post/blossom.png">
<meta name="twitter:image-height" content="1024">
<meta name="twitter:image-width" content="1536">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed fullcontent quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Julius’s Blog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/jbogomolovas2"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/JuliusBogo1"> <i class="bi bi-twitter" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/julius-bogomolovas-93222a19/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Cherry Bloom Prediction</h1>
                      </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Julijus Bogomolovas </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">July 7, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<section id="cherry-blossom-day-prediction" class="level2">
<h2 class="anchored" data-anchor-id="cherry-blossom-day-prediction">Cherry Blossom day prediction</h2>
<p>So earlier this year I participated in <a href="https://competition.statistics.gmu.edu/"><strong>International Cherry Blossom Prediction Competition</strong></a><strong>,</strong> which invites you to predict this years bloom date of cherry trees in 5 different locations based on provided historical bloom dates provided and any data you dig out. Now that cherry trees bloomed long time ago, I am sharing my entry. As good ideas come after, I enhanced last modelling step by introducing State-space framework into GAM model, allowing to deal with observation poor</p>
<p>Lets load all required packages.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load all required packages</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(nasapower)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(grateful)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(missForest)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(spls)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mvgam)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tibble)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="weather-data-import" class="level3">
<h3 class="anchored" data-anchor-id="weather-data-import">1. Weather Data Import</h3>
<p>Let’s start by uploading historical weather data for studied locations. I found that NASA POWER project provides best continuous weather records using <code>nasapower</code> <span class="citation" data-cites="nasapower">(<a href="#ref-nasapower" role="doc-biblioref">Sparks 2018</a>)</span> package. Original records from nearby stations are riddled with missing data. So I download: Tmax, Tmin, Tmean and Precipitation from 1981-01-01 (earliest date available) until the most recent.</p>
<p>Here’s how I fetch the data for Kyoto as an example:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Retrieve weather data using nasapower for Kyoto</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>Kyoto_temp <span class="ot">&lt;-</span> <span class="fu">get_power</span>(</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>       <span class="at">community =</span> <span class="st">"ag"</span>,</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>       <span class="at">lonlat =</span> <span class="fu">c</span>(<span class="fl">135.6761</span>, <span class="fl">35.0120</span>),</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>       <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"T2M"</span>, <span class="st">"T2M_MAX"</span>,<span class="st">"T2M_MIN"</span>, <span class="st">"PRECTOTCORR"</span>),</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">dates =</span> <span class="fu">c</span>(<span class="st">"1981-01-01"</span>, <span class="st">"2025-02-15"</span>),</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">temporal_api =</span> <span class="st">"daily"</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I repeat this process for all five cherry blossom locations: Kyoto (Japan), Liestal-Weideli (Switzerland), Washington DC (USA), Vancouver (Canada), and New York City (USA).</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Full code for all locations
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Retrieve weather data for remaining locations</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>Swiss_temp <span class="ot">&lt;-</span> <span class="fu">get_power</span>(</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">community =</span> <span class="st">"ag"</span>,</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">lonlat =</span> <span class="fu">c</span>(<span class="fl">7.730519</span>, <span class="fl">47.4814</span>),</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"T2M"</span>, <span class="st">"T2M_MAX"</span>,<span class="st">"T2M_MIN"</span>, <span class="st">"PRECTOTCORR"</span>),</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">dates =</span> <span class="fu">c</span>(<span class="st">"1981-01-01"</span>, <span class="st">"2025-02-15"</span>),</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">temporal_api =</span> <span class="st">"daily"</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>Washington_temp <span class="ot">&lt;-</span> <span class="fu">get_power</span>(</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">community =</span> <span class="st">"ag"</span>,</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">lonlat =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">77.0386</span>, <span class="fl">38.8853</span>),</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"T2M"</span>, <span class="st">"T2M_MAX"</span>,<span class="st">"T2M_MIN"</span>, <span class="st">"PRECTOTCORR"</span>),</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">dates =</span> <span class="fu">c</span>(<span class="st">"1981-01-01"</span>, <span class="st">"2025-02-15"</span>),</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">temporal_api =</span> <span class="st">"daily"</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>Vancouver_temp <span class="ot">&lt;-</span> <span class="fu">get_power</span>(</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">community =</span> <span class="st">"ag"</span>,</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">lonlat =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">123.1636</span>, <span class="fl">49.2237</span>),</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>   <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"T2M"</span>, <span class="st">"T2M_MAX"</span>,<span class="st">"T2M_MIN"</span>, <span class="st">"PRECTOTCORR"</span>),</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">dates =</span> <span class="fu">c</span>(<span class="st">"1981-01-01"</span>, <span class="st">"2025-02-15"</span>),</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">temporal_api =</span> <span class="st">"daily"</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>NY_temp <span class="ot">&lt;-</span> <span class="fu">get_power</span>(</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">community =</span> <span class="st">"ag"</span>,</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">lonlat =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">73.99809</span>, <span class="fl">40.73040</span>),</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"T2M"</span>, <span class="st">"T2M_MAX"</span>,<span class="st">"T2M_MIN"</span>, <span class="st">"PRECTOTCORR"</span>),</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">dates =</span> <span class="fu">c</span>(<span class="st">"1981-01-01"</span>, <span class="st">"2025-02-15"</span>),</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">temporal_api =</span> <span class="st">"daily"</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
</section>
<section id="calculating-daily-weather-anomalies" class="level3">
<h3 class="anchored" data-anchor-id="calculating-daily-weather-anomalies">2. Calculating Daily Weather Anomalies</h3>
<p>Now let’s create daily anomalies. I assume that if weather conditions were identical, cherry blossoms would occur on the same day every year. By computing daily anomalies, I partially normalize our variables across different locations.</p>
<p>First, I define a function to calculate these anomalies:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to calculate daily climate anomalies</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>calculate_climate_anomalies <span class="ot">&lt;-</span> <span class="cf">function</span>(data, </span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">baseline_start =</span> <span class="dv">1981</span>, </span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">baseline_end =</span> <span class="dv">2024</span>, </span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">vars =</span> <span class="fu">c</span>(<span class="st">"T2M"</span>, <span class="st">"T2M_MAX"</span>, <span class="st">"T2M_MIN"</span>, <span class="st">"PRECTOTCORR"</span>)) {</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Validate input variables</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(vars <span class="sc">%in%</span> <span class="fu">names</span>(data))) {</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Not all specified variables are present in the dataset."</span>)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(<span class="fu">c</span>(<span class="st">"YEAR"</span>, <span class="st">"DOY"</span>) <span class="sc">%in%</span> <span class="fu">names</span>(data))) {</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Dataset must include 'YEAR' and 'DOY' columns."</span>)</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create baseline subset</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>  baseline_data <span class="ot">&lt;-</span> data[data<span class="sc">$</span>YEAR <span class="sc">&gt;=</span> baseline_start <span class="sc">&amp;</span> data<span class="sc">$</span>YEAR <span class="sc">&lt;=</span> baseline_end, ]</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate daily climatology (mean for each day-of-year)</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>  climatology <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(baseline_data[vars], </span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>                           <span class="at">by =</span> <span class="fu">list</span>(<span class="at">DOY =</span> baseline_data<span class="sc">$</span>DOY), </span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>                           <span class="at">FUN =</span> mean, </span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>                           <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Merge climatology with original data and compute anomalies</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">merge</span>(data, climatology, <span class="at">by =</span> <span class="st">"DOY"</span>, <span class="at">suffixes =</span> <span class="fu">c</span>(<span class="st">""</span>, <span class="st">"_mean"</span>))</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (var <span class="cf">in</span> vars) {</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>    mean_col <span class="ot">&lt;-</span> <span class="fu">paste0</span>(var, <span class="st">"_mean"</span>)</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>    anom_col <span class="ot">&lt;-</span> <span class="fu">paste0</span>(var, <span class="st">"_anomaly"</span>)</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>    result[[anom_col]] <span class="ot">&lt;-</span> result[[var]] <span class="sc">-</span> result[[mean_col]]</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Attach attributes and sort by date</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">attr</span>(result, <span class="st">"baseline_period"</span>) <span class="ot">&lt;-</span> <span class="fu">paste</span>(baseline_start, <span class="st">"-"</span>, baseline_end)</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">attr</span>(result, <span class="st">"variables"</span>) <span class="ot">&lt;-</span> vars</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> result[<span class="fu">order</span>(result<span class="sc">$</span>YYYYMMDD), ]</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(result)</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I then apply this function to each location’s weather data. Here’s an example for New York:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate anomalies for New York</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>NY_temp_anomalies <span class="ot">&lt;-</span> <span class="fu">calculate_climate_anomalies</span>(NY_temp)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>NY_temp_anomalies<span class="sc">$</span>location <span class="ot">&lt;-</span> <span class="st">"New York, USA"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Processing all locations
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate anomalies for remaining locations</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>Vancouver_temp_anomalies <span class="ot">&lt;-</span> <span class="fu">calculate_climate_anomalies</span>(Vancouver_temp)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>Swiss_temp_anomalies <span class="ot">&lt;-</span> <span class="fu">calculate_climate_anomalies</span>(Swiss_temp)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>Washington_temp_anomalies <span class="ot">&lt;-</span> <span class="fu">calculate_climate_anomalies</span>(Washington_temp)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>Kyoto_temp_anomalies <span class="ot">&lt;-</span> <span class="fu">calculate_climate_anomalies</span>(Kyoto_temp)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Append location identifiers</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>Vancouver_temp_anomalies<span class="sc">$</span>location <span class="ot">&lt;-</span> <span class="st">"Vancouver, Canada"</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>Swiss_temp_anomalies<span class="sc">$</span>location <span class="ot">&lt;-</span> <span class="st">"Liestal-Weideli, Switzerland"</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>Washington_temp_anomalies<span class="sc">$</span>location <span class="ot">&lt;-</span> <span class="st">"Washington DC, USA"</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>Kyoto_temp_anomalies<span class="sc">$</span>location <span class="ot">&lt;-</span> <span class="st">"Kyoto, Japan"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<p>Finally, I combine all the anomaly data into a single dataset:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine all anomaly data</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>combined_anomalies <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  NY_temp_anomalies,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  Vancouver_temp_anomalies,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  Swiss_temp_anomalies,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  Washington_temp_anomalies,</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  Kyoto_temp_anomalies</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>combined_anomalies <span class="ot">&lt;-</span> combined_anomalies[<span class="fu">order</span>(combined_anomalies<span class="sc">$</span>location, combined_anomalies<span class="sc">$</span>YYYYMMDD), ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="importing-and-processing-cherry-blossom-data" class="level3">
<h3 class="anchored" data-anchor-id="importing-and-processing-cherry-blossom-data">3. Importing and Processing Cherry Blossom Data</h3>
<p>Next, I import and combine the cherry blossom data. I filter for records from 1981 onward to ensure the dates match our weather data range:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Import cherry blossom data and filter for records from 1981 onward</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>Vancouver <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/vancouver.csv"</span>,<span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>Washington <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/washingtondc.csv"</span>,<span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>Kyoto <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/kyoto.csv"</span>,<span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>Swiss <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/liestal.csv"</span>,<span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>Nyc <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/nyc.csv"</span>,<span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>combined_blossom_dates <span class="ot">&lt;-</span> <span class="fu">rbind</span>(Vancouver, Washington, Kyoto, Swiss, Nyc)</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>combined_blossom_dates <span class="ot">&lt;-</span> combined_blossom_dates[<span class="fu">order</span>(combined_blossom_dates<span class="sc">$</span>location, combined_blossom_dates<span class="sc">$</span>year), ]</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>combined_blossom_dates <span class="ot">&lt;-</span> combined_blossom_dates[combined_blossom_dates<span class="sc">$</span>year <span class="sc">&gt;=</span> <span class="dv">1981</span>, ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="augmenting-new-york-blossom-data" class="level3">
<h3 class="anchored" data-anchor-id="augmenting-new-york-blossom-data">4. Augmenting New York Blossom Data</h3>
<p>The primary dataset contains only one record for New York. To augment it, I retrieve data from the USA National Phenology Network. Based on recommendations, I filter for the specific location and species, then select records with more than 74% blossom (excluding the 50–74% category, which does not match our original data). For each year, I select the earliest record:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Read USA-NPN individual phenometrics data</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>USA_NPN_status_intensity <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">'data/USA-NPN_status_intensity_observations_data.csv'</span>, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to data frame and prepare Intensity_Value as factor</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>USA_status <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(USA_NPN_status_intensity)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>USA_status<span class="sc">$</span>Intensity_Value <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(USA_status<span class="sc">$</span>Intensity_Value)</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter out records with intensity values that do not match our criteria</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>USA_status_filtered <span class="ot">&lt;-</span> USA_status[<span class="sc">!</span>(USA_status<span class="sc">$</span>Intensity_Value <span class="sc">%in%</span> </span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">"-9999"</span>, <span class="st">"Little"</span>, <span class="st">"25-49%"</span>, <span class="st">"5-24%"</span>, <span class="st">"Less than 5%"</span>, <span class="st">"More than 10"</span>, <span class="st">"50-74%"</span>)), ]</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert dates and extract Year and Day of Year</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>USA_status_filtered<span class="sc">$</span>Date <span class="ot">&lt;-</span> <span class="fu">mdy</span>(USA_status_filtered<span class="sc">$</span>Observation_Date)</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>USA_status_filtered<span class="sc">$</span>Year <span class="ot">&lt;-</span> <span class="fu">year</span>(USA_status_filtered<span class="sc">$</span>Date)</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>USA_status_filtered<span class="sc">$</span>Day_of_Year <span class="ot">&lt;-</span> <span class="fu">yday</span>(USA_status_filtered<span class="sc">$</span>Date)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Visualization and detailed summary
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a scatter plot to visualize Day of Year vs. Year, colored by Intensity_Value</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(USA_status_filtered, <span class="fu">aes</span>(<span class="at">x =</span> Year, <span class="at">y =</span> Day_of_Year, <span class="at">color =</span> Intensity_Value)) <span class="sc">+</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_brewer</span>(<span class="at">palette =</span> <span class="st">"Set1"</span>) <span class="sc">+</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Day of Year vs Year for USA-NPN Data"</span>,</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Year"</span>,</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Day of Year"</span>,</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">color =</span> <span class="st">"Intensity Value"</span>) <span class="sc">+</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Summarize the filtered data by year</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>year_summary_NY_individual <span class="ot">&lt;-</span> USA_status_filtered <span class="sc">%&gt;%</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Year) <span class="sc">%&gt;%</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">Min =</span> <span class="fu">min</span>(Day_of_Year, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">Q1 =</span> <span class="fu">quantile</span>(Day_of_Year, <span class="fl">0.25</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">Median =</span> <span class="fu">median</span>(Day_of_Year, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">Mean =</span> <span class="fu">mean</span>(Day_of_Year, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">Q3 =</span> <span class="fu">quantile</span>(Day_of_Year, <span class="fl">0.75</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">Max =</span> <span class="fu">max</span>(Day_of_Year, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">Count =</span> <span class="fu">n</span>()</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(year_summary_NY_individual)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 13 × 8
    Year   Min    Q1 Median  Mean    Q3   Max Count
   &lt;int&gt; &lt;int&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; &lt;int&gt;
 1  2012    89  89      89    89    89     89     2
 2  2013   104 110     142   137.  150    170     9
 3  2014    98 108.    141   132.  156    160    11
 4  2015   101 138     148   141.  153    156    24
 5  2016   110 128.    135   134   143.   153     6
 6  2017    87 110     138   128.  143    146     9
 7  2018    79  99     101   103.  107    140    66
 8  2019    96 101     106.  115.  124.   151    24
 9  2020    78  90.5   100   107.  117.   243    32
10  2021    86  99     106   111.  116    148    41
11  2022    97 110.    122.  122.  136.   154    10
12  2023    92 104     130.  130.  139.   255    18
13  2024    88  94     106   110.  124    147    11</code></pre>
</div>
</div>
</div>
</div>
</div>
<p>Now I create augmented New York data using the earliest bloom date for each year:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create new NY data frame from the yearly summary (excluding 2024)</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>ny_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">location =</span> <span class="st">"newyorkcity"</span>,</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">lat =</span> <span class="fl">40.73040</span>,</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">long =</span> <span class="sc">-</span><span class="fl">73.99809</span>,</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">alt =</span> <span class="fl">8.5</span>,</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">year =</span> year_summary_NY_individual<span class="sc">$</span>Year[year_summary_NY_individual<span class="sc">$</span>Year <span class="sc">!=</span> <span class="dv">2024</span>],</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">bloom_date =</span> <span class="cn">NA</span>,</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">bloom_doy =</span> year_summary_NY_individual<span class="sc">$</span>Min[year_summary_NY_individual<span class="sc">$</span>Year <span class="sc">!=</span> <span class="dv">2024</span>]</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert day-of-year to actual dates</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>ny_data<span class="sc">$</span>bloom_date <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(ny_data<span class="sc">$</span>bloom_doy <span class="sc">-</span> <span class="dv">1</span>, <span class="at">origin =</span> <span class="fu">paste0</span>(ny_data<span class="sc">$</span>year, <span class="st">"-01-01"</span>))</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge with existing combined blossom dates</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>combined_blossom_dates <span class="ot">&lt;-</span> <span class="fu">rbind</span>(combined_blossom_dates, ny_data)</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>combined_blossom_dates <span class="ot">&lt;-</span> combined_blossom_dates[<span class="fu">order</span>(combined_blossom_dates<span class="sc">$</span>location, combined_blossom_dates<span class="sc">$</span>year), ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="analyzing-blossom-data" class="level3">
<h3 class="anchored" data-anchor-id="analyzing-blossom-data">5. Analyzing Blossom Data</h3>
<p>For effective modeling, I need a timeframe that aligns with the natural cherry blossom cycle rather than arbitrary calendar years. Let’s analyze our blossom date distribution to identify the optimal starting point for our “cherry year.”</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Summarize blossom dates by location</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>blossom_summary <span class="ot">&lt;-</span> combined_blossom_dates <span class="sc">%&gt;%</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(location) <span class="sc">%&gt;%</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">Min =</span> <span class="fu">min</span>(bloom_doy),</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">Q1 =</span> <span class="fu">quantile</span>(bloom_doy, <span class="fl">0.25</span>),</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">Median =</span> <span class="fu">median</span>(bloom_doy),</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">Q3 =</span> <span class="fu">quantile</span>(bloom_doy, <span class="fl">0.75</span>),</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">Max =</span> <span class="fu">max</span>(bloom_doy),</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">Range =</span> <span class="fu">max</span>(bloom_doy) <span class="sc">-</span> <span class="fu">min</span>(bloom_doy)</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(blossom_summary)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 7
  location       Min    Q1 Median    Q3   Max Range
  &lt;chr&gt;        &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1 kyoto           84  93       95    99   109    25
2 liestal         75  87       93   101   121    46
3 newyorkcity     78  87       92    98   110    32
4 vancouver       83  84.5     86    91    96    13
5 washingtondc    74  86       91    95   101    27</code></pre>
</div>
</div>
<p>The maximum third quartile (Q3) at day 100 represents when 75% of historical blooms have occurred in late–bloomer location—effectively marking the end of the bloom season across locations. While I could theoretically calculate predictors from one recorded bloom date to the next, this creates a circular dependency: to predict next year’s bloom date, we’d need to know it already to determine when to stop accumulating our weather predictors. By using day 100 as our universal cutoff, I establish a “cherry year” that runs from April 10 to April 9, nicely matching historical bloom cycles.</p>
</section>
<section id="building-rolling-sum-predictors" class="level3">
<h3 class="anchored" data-anchor-id="building-rolling-sum-predictors">6. Building Rolling Sum Predictors</h3>
<p>In this section, I create predictors that capture the cumulative effect of weather anomalies over a 30-day period, which Ihypothesize will influence the timing of cherry blossom.</p>
<p>First, Iconvert to data.table and compute 30-day rolling sums for each anomaly type. Here’s an example for temperature anomalies:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to data.table for efficient rolling calculations</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>combined_anomalies <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(combined_anomalies)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Example: Calculate 30-day rolling sums for average temperature anomalies</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>combined_anomalies[, temp_ave_pos_rollsum <span class="sc">:</span><span class="er">=</span> <span class="fu">frollsum</span>(<span class="fu">ifelse</span>(T2M_anomaly <span class="sc">&gt;</span> <span class="dv">0</span>, T2M_anomaly, <span class="dv">0</span>), </span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>                                                      <span class="at">n =</span> <span class="dv">30</span>, <span class="at">align =</span> <span class="st">"right"</span>), by <span class="ot">=</span> location]</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>combined_anomalies[, temp_ave_neg_rollsum <span class="sc">:</span><span class="er">=</span> <span class="fu">frollsum</span>(<span class="fu">ifelse</span>(T2M_anomaly <span class="sc">&lt;</span> <span class="dv">0</span>, T2M_anomaly, <span class="dv">0</span>), </span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>                                                      <span class="at">n =</span> <span class="dv">30</span>, <span class="at">align =</span> <span class="st">"right"</span>), by <span class="ot">=</span> location]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Complete rolling sum calculations for all variables
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Maximum temperature rolling sums</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>combined_anomalies[, temp_max_pos_rollsum <span class="sc">:</span><span class="er">=</span> <span class="fu">frollsum</span>(<span class="fu">ifelse</span>(T2M_MAX_anomaly <span class="sc">&gt;</span> <span class="dv">0</span>, T2M_MAX_anomaly, <span class="dv">0</span>), </span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>                                                      <span class="at">n =</span> <span class="dv">30</span>, <span class="at">align =</span> <span class="st">"right"</span>), by <span class="ot">=</span> location]</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>combined_anomalies[, temp_max_neg_rollsum <span class="sc">:</span><span class="er">=</span> <span class="fu">frollsum</span>(<span class="fu">ifelse</span>(T2M_MAX_anomaly <span class="sc">&lt;</span> <span class="dv">0</span>, T2M_MAX_anomaly, <span class="dv">0</span>), </span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>                                                      <span class="at">n =</span> <span class="dv">30</span>, <span class="at">align =</span> <span class="st">"right"</span>), by <span class="ot">=</span> location]</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Minimum temperature rolling sums</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>combined_anomalies[, temp_min_pos_rollsum <span class="sc">:</span><span class="er">=</span> <span class="fu">frollsum</span>(<span class="fu">ifelse</span>(T2M_MIN_anomaly <span class="sc">&gt;</span> <span class="dv">0</span>, T2M_MIN_anomaly, <span class="dv">0</span>), </span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>                                                      <span class="at">n =</span> <span class="dv">30</span>, <span class="at">align =</span> <span class="st">"right"</span>), by <span class="ot">=</span> location]</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>combined_anomalies[, temp_min_neg_rollsum <span class="sc">:</span><span class="er">=</span> <span class="fu">frollsum</span>(<span class="fu">ifelse</span>(T2M_MIN_anomaly <span class="sc">&lt;</span> <span class="dv">0</span>, T2M_MIN_anomaly, <span class="dv">0</span>), </span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>                                                      <span class="at">n =</span> <span class="dv">30</span>, <span class="at">align =</span> <span class="st">"right"</span>), by <span class="ot">=</span> location]</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Precipitation rolling sums</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>combined_anomalies[, prcp_pos_rollsum <span class="sc">:</span><span class="er">=</span> <span class="fu">frollsum</span>(<span class="fu">ifelse</span>(PRECTOTCORR_anomaly <span class="sc">&gt;</span> <span class="dv">0</span>, PRECTOTCORR_anomaly, <span class="dv">0</span>), </span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">n =</span> <span class="dv">30</span>, <span class="at">align =</span> <span class="st">"right"</span>), by <span class="ot">=</span> location]</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>combined_anomalies[, prcp_neg_rollsum <span class="sc">:</span><span class="er">=</span> <span class="fu">frollsum</span>(<span class="fu">ifelse</span>(PRECTOTCORR_anomaly <span class="sc">&lt;</span> <span class="dv">0</span>, PRECTOTCORR_anomaly, <span class="dv">0</span>), </span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">n =</span> <span class="dv">30</span>, <span class="at">align =</span> <span class="st">"right"</span>), by <span class="ot">=</span> location]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<p>Next, I create a “cherry year” that aligns with the bloom cycle. Based on our analysis, I start each cherry year on April 10 (day 100):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a numeric day-of-year and adjust to form a 'cherry_year'</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>combined_anomalies[, doy <span class="sc">:</span><span class="er">=</span> <span class="fu">as.numeric</span>(<span class="fu">format</span>(YYYYMMDD, <span class="st">"%j"</span>))]</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>combined_anomalies[, cherry_year <span class="sc">:</span><span class="er">=</span> <span class="fu">ifelse</span>(doy <span class="sc">&gt;=</span> <span class="dv">100</span>, <span class="fu">year</span>(YYYYMMDD) <span class="sc">+</span> <span class="dv">1</span>, <span class="fu">year</span>(YYYYMMDD))]</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>combined_anomalies[, day_number <span class="sc">:</span><span class="er">=</span> <span class="fu">ifelse</span>(doy <span class="sc">&gt;=</span> <span class="dv">100</span>, doy <span class="sc">-</span> <span class="dv">99</span>, doy <span class="sc">+</span> (<span class="dv">366</span> <span class="sc">-</span> <span class="dv">99</span>))]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, I create a streamlined dataset containing only the rolling sum predictors:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>small_anomaly_df <span class="ot">&lt;-</span> combined_anomalies <span class="sc">%&gt;%</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(DOY, LON, LAT, YEAR, MM, DD, T2M, T2M_MAX, T2M_MIN, PRECTOTCORR,</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>            T2M_mean, T2M_MAX_mean, T2M_MIN_mean, PRECTOTCORR_mean,</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>            T2M_anomaly, T2M_MAX_anomaly, T2M_MIN_anomaly, PRECTOTCORR_anomaly))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This process creates eight rolling sum predictors (positive and negative anomalies for average/max/min temperature and precipitation) that capture the cumulative weather effects leading up to each potential bloom date.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the pre-processed data since I skipped the processing steps</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>final_wide <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/final_wide.csv"</span>, <span class="at">row.names =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="reshaping-imputation-and-merging-wide-format-data" class="level3">
<h3 class="anchored" data-anchor-id="reshaping-imputation-and-merging-wide-format-data">7. Reshaping, Imputation, and Merging Wide-Format Data</h3>
<p>I now convert our rolling sum predictors into a wide-format structure for modeling. This creates a matrix where each row represents a cherry year and location, with columns for each day’s rolling sum values.</p>
<p>Here’s the process for one predictor (positive temperature anomaly rolling sum):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Reshape data to wide format</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>wide_temp_ave_pos <span class="ot">&lt;-</span> <span class="fu">dcast</span>(small_anomaly_df[<span class="sc">!</span><span class="fu">is.na</span>(temp_ave_pos_rollsum)], </span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>                           cherry_year <span class="sc">+</span> location <span class="sc">~</span> day_number, </span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>                           <span class="at">value.var =</span> <span class="st">"temp_ave_pos_rollsum"</span>)</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Rename columns to be more descriptive</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="fu">setnames</span>(wide_temp_ave_pos, </span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">old =</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(wide_temp_ave_pos), <span class="fu">c</span>(<span class="st">"cherry_year"</span>, <span class="st">"location"</span>)), </span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">new =</span> <span class="fu">paste0</span>(<span class="st">"temp_ave_pos_rollsum_"</span>, <span class="fu">seq_along</span>(<span class="fu">setdiff</span>(<span class="fu">names</span>(wide_temp_ave_pos), <span class="fu">c</span>(<span class="st">"cherry_year"</span>, <span class="st">"location"</span>)))))</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Impute missing values using random forest</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>numeric_cols <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(wide_temp_ave_pos), <span class="fu">c</span>(<span class="st">"cherry_year"</span>, <span class="st">"location"</span>))</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>numeric_matrix <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(wide_temp_ave_pos[, ..numeric_cols])</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>imputed_result <span class="ot">&lt;-</span> <span class="fu">missForest</span>(numeric_matrix, <span class="at">maxiter =</span> <span class="dv">5</span>, <span class="at">verbose =</span> <span class="cn">TRUE</span>)</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>imputed_matrix <span class="ot">&lt;-</span> imputed_result<span class="sc">$</span>ximp</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>wide_temp_ave_pos_imputed <span class="ot">&lt;-</span> <span class="fu">cbind</span>(wide_temp_ave_pos[, .(cherry_year, location)], imputed_matrix)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I repeat this process for all eight rolling sum predictors. Missing values (~2.4% per predictor) occur in three scenarios: - Initial period from April 10, 1981 to January 31, 1982 - Dates after February 20, 2025 (extent of available weather data) - Day 366 in non-leap years</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-5-contents" aria-controls="callout-5" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Full reshaping code for all predictors
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-5" class="callout-5-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Process negative temperature average anomalies</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>wide_temp_ave_neg <span class="ot">&lt;-</span> <span class="fu">dcast</span>(small_anomaly_df[<span class="sc">!</span><span class="fu">is.na</span>(temp_ave_neg_rollsum)], </span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>                           cherry_year <span class="sc">+</span> location <span class="sc">~</span> day_number, </span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>                           <span class="at">value.var =</span> <span class="st">"temp_ave_neg_rollsum"</span>)</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="fu">setnames</span>(wide_temp_ave_neg, </span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">old =</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(wide_temp_ave_neg), <span class="fu">c</span>(<span class="st">"cherry_year"</span>, <span class="st">"location"</span>)), </span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">new =</span> <span class="fu">paste0</span>(<span class="st">"temp_ave_neg_rollsum_"</span>, <span class="fu">seq_along</span>(<span class="fu">setdiff</span>(<span class="fu">names</span>(wide_temp_ave_neg), <span class="fu">c</span>(<span class="st">"cherry_year"</span>, <span class="st">"location"</span>)))))</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>numeric_cols <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(wide_temp_ave_neg), <span class="fu">c</span>(<span class="st">"cherry_year"</span>, <span class="st">"location"</span>))</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>numeric_matrix <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(wide_temp_ave_neg[, ..numeric_cols])</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>imputed_result <span class="ot">&lt;-</span> <span class="fu">missForest</span>(numeric_matrix, <span class="at">maxiter =</span> <span class="dv">5</span>, <span class="at">verbose =</span> <span class="cn">TRUE</span>)</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>imputed_matrix <span class="ot">&lt;-</span> imputed_result<span class="sc">$</span>ximp</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>wide_temp_ave_neg_imputed <span class="ot">&lt;-</span> <span class="fu">cbind</span>(wide_temp_ave_neg[, .(cherry_year, location)], imputed_matrix)</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Process positive temperature maximum anomalies</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>wide_temp_max_pos <span class="ot">&lt;-</span> <span class="fu">dcast</span>(small_anomaly_df[<span class="sc">!</span><span class="fu">is.na</span>(temp_max_pos_rollsum)], </span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>                           cherry_year <span class="sc">+</span> location <span class="sc">~</span> day_number, </span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>                           <span class="at">value.var =</span> <span class="st">"temp_max_pos_rollsum"</span>)</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a><span class="fu">setnames</span>(wide_temp_max_pos, </span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>         <span class="at">old =</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(wide_temp_max_pos), <span class="fu">c</span>(<span class="st">"cherry_year"</span>, <span class="st">"location"</span>)), </span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>         <span class="at">new =</span> <span class="fu">paste0</span>(<span class="st">"temp_max_pos_rollsum_"</span>, <span class="fu">seq_along</span>(<span class="fu">setdiff</span>(<span class="fu">names</span>(wide_temp_max_pos), <span class="fu">c</span>(<span class="st">"cherry_year"</span>, <span class="st">"location"</span>)))))</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>numeric_cols <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(wide_temp_max_pos), <span class="fu">c</span>(<span class="st">"cherry_year"</span>, <span class="st">"location"</span>))</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>numeric_matrix <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(wide_temp_max_pos[, ..numeric_cols])</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>imputed_result <span class="ot">&lt;-</span> <span class="fu">missForest</span>(numeric_matrix, <span class="at">maxiter =</span> <span class="dv">5</span>, <span class="at">verbose =</span> <span class="cn">TRUE</span>)</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>imputed_matrix <span class="ot">&lt;-</span> imputed_result<span class="sc">$</span>ximp</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>wide_temp_max_pos_imputed <span class="ot">&lt;-</span> <span class="fu">cbind</span>(wide_temp_max_pos[, .(cherry_year, location)], imputed_matrix)</span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Process negative temperature maximum anomalies</span></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>wide_temp_max_neg <span class="ot">&lt;-</span> <span class="fu">dcast</span>(small_anomaly_df[<span class="sc">!</span><span class="fu">is.na</span>(temp_max_neg_rollsum)], </span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>                           cherry_year <span class="sc">+</span> location <span class="sc">~</span> day_number, </span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>                           <span class="at">value.var =</span> <span class="st">"temp_max_neg_rollsum"</span>)</span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a><span class="fu">setnames</span>(wide_temp_max_neg, </span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>         <span class="at">old =</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(wide_temp_max_neg), <span class="fu">c</span>(<span class="st">"cherry_year"</span>, <span class="st">"location"</span>)), </span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>         <span class="at">new =</span> <span class="fu">paste0</span>(<span class="st">"temp_max_neg_rollsum_"</span>, <span class="fu">seq_along</span>(<span class="fu">setdiff</span>(<span class="fu">names</span>(wide_temp_max_neg), <span class="fu">c</span>(<span class="st">"cherry_year"</span>, <span class="st">"location"</span>)))))</span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>numeric_cols <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(wide_temp_max_neg), <span class="fu">c</span>(<span class="st">"cherry_year"</span>, <span class="st">"location"</span>))</span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>numeric_matrix <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(wide_temp_max_neg[, ..numeric_cols])</span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>imputed_result <span class="ot">&lt;-</span> <span class="fu">missForest</span>(numeric_matrix, <span class="at">maxiter =</span> <span class="dv">5</span>, <span class="at">verbose =</span> <span class="cn">TRUE</span>)</span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>imputed_matrix <span class="ot">&lt;-</span> imputed_result<span class="sc">$</span>ximp</span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>wide_temp_max_neg_imputed <span class="ot">&lt;-</span> <span class="fu">cbind</span>(wide_temp_max_neg[, .(cherry_year, location)], imputed_matrix)</span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Process positive temperature minimum anomalies</span></span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>wide_temp_min_pos <span class="ot">&lt;-</span> <span class="fu">dcast</span>(small_anomaly_df[<span class="sc">!</span><span class="fu">is.na</span>(temp_min_pos_rollsum)], </span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>                           cherry_year <span class="sc">+</span> location <span class="sc">~</span> day_number, </span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a>                           <span class="at">value.var =</span> <span class="st">"temp_min_pos_rollsum"</span>)</span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a><span class="fu">setnames</span>(wide_temp_min_pos, </span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a>         <span class="at">old =</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(wide_temp_min_pos), <span class="fu">c</span>(<span class="st">"cherry_year"</span>, <span class="st">"location"</span>)), </span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a>         <span class="at">new =</span> <span class="fu">paste0</span>(<span class="st">"temp_min_pos_rollsum_"</span>, <span class="fu">seq_along</span>(<span class="fu">setdiff</span>(<span class="fu">names</span>(wide_temp_min_pos), <span class="fu">c</span>(<span class="st">"cherry_year"</span>, <span class="st">"location"</span>)))))</span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a>numeric_cols <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(wide_temp_min_pos), <span class="fu">c</span>(<span class="st">"cherry_year"</span>, <span class="st">"location"</span>))</span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a>numeric_matrix <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(wide_temp_min_pos[, ..numeric_cols])</span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a>imputed_result <span class="ot">&lt;-</span> <span class="fu">missForest</span>(numeric_matrix, <span class="at">maxiter =</span> <span class="dv">5</span>, <span class="at">verbose =</span> <span class="cn">TRUE</span>)</span>
<span id="cb22-50"><a href="#cb22-50" aria-hidden="true" tabindex="-1"></a>imputed_matrix <span class="ot">&lt;-</span> imputed_result<span class="sc">$</span>ximp</span>
<span id="cb22-51"><a href="#cb22-51" aria-hidden="true" tabindex="-1"></a>wide_temp_min_pos_imputed <span class="ot">&lt;-</span> <span class="fu">cbind</span>(wide_temp_min_pos[, .(cherry_year, location)], imputed_matrix)</span>
<span id="cb22-52"><a href="#cb22-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-53"><a href="#cb22-53" aria-hidden="true" tabindex="-1"></a><span class="co"># Process negative temperature minimum anomalies</span></span>
<span id="cb22-54"><a href="#cb22-54" aria-hidden="true" tabindex="-1"></a>wide_temp_min_neg <span class="ot">&lt;-</span> <span class="fu">dcast</span>(small_anomaly_df[<span class="sc">!</span><span class="fu">is.na</span>(temp_min_neg_rollsum)], </span>
<span id="cb22-55"><a href="#cb22-55" aria-hidden="true" tabindex="-1"></a>                           cherry_year <span class="sc">+</span> location <span class="sc">~</span> day_number, </span>
<span id="cb22-56"><a href="#cb22-56" aria-hidden="true" tabindex="-1"></a>                           <span class="at">value.var =</span> <span class="st">"temp_min_neg_rollsum"</span>)</span>
<span id="cb22-57"><a href="#cb22-57" aria-hidden="true" tabindex="-1"></a><span class="fu">setnames</span>(wide_temp_min_neg, </span>
<span id="cb22-58"><a href="#cb22-58" aria-hidden="true" tabindex="-1"></a>         <span class="at">old =</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(wide_temp_min_neg), <span class="fu">c</span>(<span class="st">"cherry_year"</span>, <span class="st">"location"</span>)), </span>
<span id="cb22-59"><a href="#cb22-59" aria-hidden="true" tabindex="-1"></a>         <span class="at">new =</span> <span class="fu">paste0</span>(<span class="st">"temp_min_neg_rollsum_"</span>, <span class="fu">seq_along</span>(<span class="fu">setdiff</span>(<span class="fu">names</span>(wide_temp_min_neg), <span class="fu">c</span>(<span class="st">"cherry_year"</span>, <span class="st">"location"</span>)))))</span>
<span id="cb22-60"><a href="#cb22-60" aria-hidden="true" tabindex="-1"></a>numeric_cols <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(wide_temp_min_neg), <span class="fu">c</span>(<span class="st">"cherry_year"</span>, <span class="st">"location"</span>))</span>
<span id="cb22-61"><a href="#cb22-61" aria-hidden="true" tabindex="-1"></a>numeric_matrix <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(wide_temp_min_neg[, ..numeric_cols])</span>
<span id="cb22-62"><a href="#cb22-62" aria-hidden="true" tabindex="-1"></a>imputed_result <span class="ot">&lt;-</span> <span class="fu">missForest</span>(numeric_matrix, <span class="at">maxiter =</span> <span class="dv">5</span>, <span class="at">verbose =</span> <span class="cn">TRUE</span>)</span>
<span id="cb22-63"><a href="#cb22-63" aria-hidden="true" tabindex="-1"></a>imputed_matrix <span class="ot">&lt;-</span> imputed_result<span class="sc">$</span>ximp</span>
<span id="cb22-64"><a href="#cb22-64" aria-hidden="true" tabindex="-1"></a>wide_temp_min_neg_imputed <span class="ot">&lt;-</span> <span class="fu">cbind</span>(wide_temp_min_neg[, .(cherry_year, location)], imputed_matrix)</span>
<span id="cb22-65"><a href="#cb22-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-66"><a href="#cb22-66" aria-hidden="true" tabindex="-1"></a><span class="co"># Process positive precipitation anomalies</span></span>
<span id="cb22-67"><a href="#cb22-67" aria-hidden="true" tabindex="-1"></a>wide_prcp_pos <span class="ot">&lt;-</span> <span class="fu">dcast</span>(small_anomaly_df[<span class="sc">!</span><span class="fu">is.na</span>(prcp_pos_rollsum)], </span>
<span id="cb22-68"><a href="#cb22-68" aria-hidden="true" tabindex="-1"></a>                       cherry_year <span class="sc">+</span> location <span class="sc">~</span> day_number, </span>
<span id="cb22-69"><a href="#cb22-69" aria-hidden="true" tabindex="-1"></a>                       <span class="at">value.var =</span> <span class="st">"prcp_pos_rollsum"</span>)</span>
<span id="cb22-70"><a href="#cb22-70" aria-hidden="true" tabindex="-1"></a><span class="fu">setnames</span>(wide_prcp_pos, </span>
<span id="cb22-71"><a href="#cb22-71" aria-hidden="true" tabindex="-1"></a>         <span class="at">old =</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(wide_prcp_pos), <span class="fu">c</span>(<span class="st">"cherry_year"</span>, <span class="st">"location"</span>)), </span>
<span id="cb22-72"><a href="#cb22-72" aria-hidden="true" tabindex="-1"></a>         <span class="at">new =</span> <span class="fu">paste0</span>(<span class="st">"prcp_pos_rollsum_"</span>, <span class="fu">seq_along</span>(<span class="fu">setdiff</span>(<span class="fu">names</span>(wide_prcp_pos), <span class="fu">c</span>(<span class="st">"cherry_year"</span>, <span class="st">"location"</span>)))))</span>
<span id="cb22-73"><a href="#cb22-73" aria-hidden="true" tabindex="-1"></a>numeric_cols <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(wide_prcp_pos), <span class="fu">c</span>(<span class="st">"cherry_year"</span>, <span class="st">"location"</span>))</span>
<span id="cb22-74"><a href="#cb22-74" aria-hidden="true" tabindex="-1"></a>numeric_matrix <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(wide_prcp_pos[, ..numeric_cols])</span>
<span id="cb22-75"><a href="#cb22-75" aria-hidden="true" tabindex="-1"></a>imputed_result <span class="ot">&lt;-</span> <span class="fu">missForest</span>(numeric_matrix, <span class="at">maxiter =</span> <span class="dv">5</span>, <span class="at">verbose =</span> <span class="cn">TRUE</span>)</span>
<span id="cb22-76"><a href="#cb22-76" aria-hidden="true" tabindex="-1"></a>imputed_matrix <span class="ot">&lt;-</span> imputed_result<span class="sc">$</span>ximp</span>
<span id="cb22-77"><a href="#cb22-77" aria-hidden="true" tabindex="-1"></a>wide_prcp_pos_imputed <span class="ot">&lt;-</span> <span class="fu">cbind</span>(wide_prcp_pos[, .(cherry_year, location)], imputed_matrix)</span>
<span id="cb22-78"><a href="#cb22-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-79"><a href="#cb22-79" aria-hidden="true" tabindex="-1"></a><span class="co"># Process negative precipitation anomalies</span></span>
<span id="cb22-80"><a href="#cb22-80" aria-hidden="true" tabindex="-1"></a>wide_prcp_neg <span class="ot">&lt;-</span> <span class="fu">dcast</span>(small_anomaly_df[<span class="sc">!</span><span class="fu">is.na</span>(prcp_neg_rollsum)], </span>
<span id="cb22-81"><a href="#cb22-81" aria-hidden="true" tabindex="-1"></a>                       cherry_year <span class="sc">+</span> location <span class="sc">~</span> day_number, </span>
<span id="cb22-82"><a href="#cb22-82" aria-hidden="true" tabindex="-1"></a>                       <span class="at">value.var =</span> <span class="st">"prcp_neg_rollsum"</span>)</span>
<span id="cb22-83"><a href="#cb22-83" aria-hidden="true" tabindex="-1"></a><span class="fu">setnames</span>(wide_prcp_neg, </span>
<span id="cb22-84"><a href="#cb22-84" aria-hidden="true" tabindex="-1"></a>         <span class="at">old =</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(wide_prcp_neg), <span class="fu">c</span>(<span class="st">"cherry_year"</span>, <span class="st">"location"</span>)), </span>
<span id="cb22-85"><a href="#cb22-85" aria-hidden="true" tabindex="-1"></a>         <span class="at">new =</span> <span class="fu">paste0</span>(<span class="st">"prcp_neg_rollsum_"</span>, <span class="fu">seq_along</span>(<span class="fu">setdiff</span>(<span class="fu">names</span>(wide_prcp_neg), <span class="fu">c</span>(<span class="st">"cherry_year"</span>, <span class="st">"location"</span>)))))</span>
<span id="cb22-86"><a href="#cb22-86" aria-hidden="true" tabindex="-1"></a>numeric_cols <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(wide_prcp_neg), <span class="fu">c</span>(<span class="st">"cherry_year"</span>, <span class="st">"location"</span>))</span>
<span id="cb22-87"><a href="#cb22-87" aria-hidden="true" tabindex="-1"></a>numeric_matrix <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(wide_prcp_neg[, ..numeric_cols])</span>
<span id="cb22-88"><a href="#cb22-88" aria-hidden="true" tabindex="-1"></a>imputed_result <span class="ot">&lt;-</span> <span class="fu">missForest</span>(numeric_matrix, <span class="at">maxiter =</span> <span class="dv">5</span>, <span class="at">verbose =</span> <span class="cn">TRUE</span>)</span>
<span id="cb22-89"><a href="#cb22-89" aria-hidden="true" tabindex="-1"></a>imputed_matrix <span class="ot">&lt;-</span> imputed_result<span class="sc">$</span>ximp</span>
<span id="cb22-90"><a href="#cb22-90" aria-hidden="true" tabindex="-1"></a>wide_prcp_neg_imputed <span class="ot">&lt;-</span> <span class="fu">cbind</span>(wide_prcp_neg[, .(cherry_year, location)], imputed_matrix)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<p>After processing all eight predictor sets, I merge them into a comprehensive dataset:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge all wide-format datasets by cherry_year and location</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>final_wide <span class="ot">&lt;-</span> <span class="fu">Reduce</span>(<span class="cf">function</span>(x, y) <span class="fu">merge</span>(x, y, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"cherry_year"</span>, <span class="st">"location"</span>), <span class="at">all =</span> <span class="cn">TRUE</span>),</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">list</span>(wide_temp_ave_pos_imputed, wide_temp_ave_neg_imputed, </span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>                          wide_temp_max_pos_imputed, wide_temp_max_neg_imputed,</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>                          wide_temp_min_pos_imputed, wide_temp_min_neg_imputed,</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>                          wide_prcp_pos_imputed, wide_prcp_neg_imputed))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This gives us 8 rolling sum variables × 366 days = 2,928 predictors per location per year. Due to the computational intensity of the imputation process, you can download the pre-imputed file from <a href="data/final_wide.csv">final_wide.csv</a>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(final_wide, <span class="st">"data/final_wide.csv"</span>, <span class="at">row.names =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="merging-rolling-sums-with-blossom-data" class="level3">
<h3 class="anchored" data-anchor-id="merging-rolling-sums-with-blossom-data">8. Merging Rolling Sums with Blossom Data</h3>
<p>Now I merge our wide-format predictors with the actual bloom dates:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>final_wide <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(final_wide)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Map location names to match blossom data format</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>location_mapping <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Kyoto, Japan"</span>                <span class="ot">=</span> <span class="st">"kyoto"</span>,</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Liestal-Weideli, Switzerland"</span> <span class="ot">=</span> <span class="st">"liestal"</span>,</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"New York, USA"</span>               <span class="ot">=</span> <span class="st">"newyorkcity"</span>,</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Vancouver, Canada"</span>           <span class="ot">=</span> <span class="st">"vancouver"</span>,</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Washington DC, USA"</span>          <span class="ot">=</span> <span class="st">"washingtondc"</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>final_wide<span class="sc">$</span>location_mapped <span class="ot">&lt;-</span> location_mapping[final_wide<span class="sc">$</span>location]</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge with bloom dates</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>final_wide <span class="ot">&lt;-</span> <span class="fu">merge</span>(</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>  final_wide,</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>  combined_blossom_dates[, <span class="fu">c</span>(<span class="st">"location"</span>, <span class="st">"year"</span>, <span class="st">"bloom_doy"</span>)],</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">by.x =</span> <span class="fu">c</span>(<span class="st">"location_mapped"</span>, <span class="st">"cherry_year"</span>),</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">by.y =</span> <span class="fu">c</span>(<span class="st">"location"</span>, <span class="st">"year"</span>),</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">all.x =</span> <span class="cn">TRUE</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Reorder columns to put key variables first</span></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>keep_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"cherry_year"</span>, <span class="st">"location"</span>, <span class="st">"bloom_doy"</span>)</span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>existing_keep_vars <span class="ot">&lt;-</span> keep_vars[keep_vars <span class="sc">%in%</span> <span class="fu">colnames</span>(final_wide)]</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>other_vars <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(final_wide), <span class="fu">c</span>(existing_keep_vars, <span class="st">"location_mapped"</span>))</span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>final_wide <span class="ot">&lt;-</span> final_wide[, <span class="fu">c</span>(existing_keep_vars, other_vars)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="selecting-and-engineering-features-for-blossom-date-prediction-using-sparse-partial-least-squares" class="level3">
<h3 class="anchored" data-anchor-id="selecting-and-engineering-features-for-blossom-date-prediction-using-sparse-partial-least-squares">9. Selecting and Engineering features for blossom date prediction using sparse Partial Least Squares</h3>
<p>In this section, I use Sparse Partial Least Squares (SPLS) to identify key predictors and extract latent factors that summarize the high-dimensional weather data. I first convert our wide-format dataset into a matrix form and define our predictors and response (bloom day). Next, I perform 10-fold cross-validation to determine the optimal number of latent factors (K) and the sparsity level (eta). With these parameters, I fit the SPLS model to the training data, which selects a subset of predictors and computes a projection matrix. Finally, I use this projection to calculate latent factor scores (e.g., latent1, latent2, etc.) for all observations. These latent factors encapsulate the main variability in the predictors and are then used for further analysis and prediction of the bloom day. Currently I will ignore that this dataset comes from 5 different locations.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare data for SPLS</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>my_data <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(final_wide)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>id_cols <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"cherry_year"</span>, <span class="st">"location"</span>, <span class="st">"bloom_doy"</span>)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>predictor_cols <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(my_data), id_cols)</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>train_data <span class="ot">&lt;-</span> <span class="fu">subset</span>(my_data, <span class="sc">!</span><span class="fu">is.na</span>(bloom_doy))</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>X_train <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(train_data[, predictor_cols])</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>Y_train <span class="ot">&lt;-</span> train_data<span class="sc">$</span>bloom_doy</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Cross-validation for optimal parameters</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>cv.out <span class="ot">&lt;-</span> <span class="fu">cv.spls</span>(</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>  X_train, </span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>  Y_train,</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">K   =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>,</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">eta =</span> <span class="fu">seq</span>(<span class="fl">0.1</span>, <span class="fl">0.9</span>, <span class="fl">0.1</span>),</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">fold =</span> <span class="dv">10</span></span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>eta = 0.1 
eta = 0.2 
eta = 0.3 
eta = 0.4 
eta = 0.5 
eta = 0.6 
eta = 0.7 
eta = 0.8 
eta = 0.9 

Optimal parameters: eta = 0.3, K = 3</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>optimal_K   <span class="ot">&lt;-</span> cv.out<span class="sc">$</span>K.opt</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>optimal_eta <span class="ot">&lt;-</span> cv.out<span class="sc">$</span>eta.opt</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit final SPLS model and extract latent factors</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>final_model <span class="ot">&lt;-</span> <span class="fu">spls</span>(X_train, Y_train, <span class="at">K =</span> optimal_K, <span class="at">eta =</span> optimal_eta)</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>X_all <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(my_data[, predictor_cols])</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>X_all_std <span class="ot">&lt;-</span> <span class="fu">sweep</span>(X_all, <span class="dv">2</span>, final_model<span class="sc">$</span>meanx, <span class="at">FUN =</span> <span class="st">"-"</span>)</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>X_all_std <span class="ot">&lt;-</span> <span class="fu">sweep</span>(X_all_std, <span class="dv">2</span>, final_model<span class="sc">$</span>normx, <span class="at">FUN =</span> <span class="st">"/"</span>)</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>X_all_sub <span class="ot">&lt;-</span> X_all_std[, final_model<span class="sc">$</span>A, drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>latent_all <span class="ot">&lt;-</span> X_all_sub <span class="sc">%*%</span> final_model<span class="sc">$</span>projection</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>num_latent <span class="ot">&lt;-</span> <span class="fu">ncol</span>(latent_all)</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(latent_all) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"latent"</span>, <span class="fu">seq_len</span>(num_latent))</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>latent_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">cherry_year =</span> my_data<span class="sc">$</span>cherry_year,</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">location    =</span> my_data<span class="sc">$</span>location,</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">bloom_doy   =</span> my_data<span class="sc">$</span>bloom_doy,</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>  latent_all</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="model-diagnostics-and-latent-factor-interpretation" class="level3">
<h3 class="anchored" data-anchor-id="model-diagnostics-and-latent-factor-interpretation">10. Model Diagnostics and Latent Factor Interpretation</h3>
<p>In this section, I first assess the performance of our Sparse PLS model using training data. I compute key statistics—such as R², RMSE, and MAE—to gauge how well the model explains the variance in the bloom day (with a higher R² indicating a better fit).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Predict on training data</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>y_pred_train <span class="ot">&lt;-</span> <span class="fu">predict</span>(final_model, X_train)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>SST <span class="ot">&lt;-</span> <span class="fu">sum</span>((Y_train <span class="sc">-</span> <span class="fu">mean</span>(Y_train))<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>SSE <span class="ot">&lt;-</span> <span class="fu">sum</span>((Y_train <span class="sc">-</span> y_pred_train)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>R2_train <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> SSE<span class="sc">/</span>SST</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>MAE_train <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">abs</span>(Y_train <span class="sc">-</span> y_pred_train))</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>RMSE_train <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">mean</span>((Y_train <span class="sc">-</span> y_pred_train)<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>n_selected_vars <span class="ot">&lt;-</span> <span class="fu">length</span>(final_model<span class="sc">$</span>A)</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>percent_vars_selected <span class="ot">&lt;-</span> (n_selected_vars <span class="sc">/</span> <span class="fu">length</span>(predictor_cols)) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Create diagnostic plot with statistics</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>stats_text <span class="ot">&lt;-</span> <span class="fu">paste0</span>(</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">"R² = "</span>, <span class="fu">round</span>(R2_train, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>  <span class="st">"RMSE = "</span>, <span class="fu">round</span>(RMSE_train, <span class="dv">1</span>), <span class="st">" days</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>  <span class="st">"MAE = "</span>, <span class="fu">round</span>(MAE_train, <span class="dv">1</span>), <span class="st">" days</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Variables: "</span>, n_selected_vars, <span class="st">"/"</span>, <span class="fu">length</span>(predictor_cols), </span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>  <span class="st">" ("</span>, <span class="fu">round</span>(percent_vars_selected, <span class="dv">0</span>), <span class="st">"%)"</span></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">data.frame</span>(<span class="at">Actual =</span> Y_train, <span class="at">Predicted =</span> y_pred_train), <span class="fu">aes</span>(<span class="at">x =</span> Actual, <span class="at">y =</span> Predicted)) <span class="sc">+</span></span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="fu">max</span>(Y_train) <span class="sc">-</span> <span class="dv">5</span>, <span class="at">y =</span> <span class="fu">min</span>(y_pred_train) <span class="sc">+</span> <span class="dv">10</span>, </span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>           <span class="at">label =</span> stats_text, <span class="at">hjust =</span> <span class="dv">1</span>, <span class="at">vjust =</span> <span class="dv">0</span>, <span class="at">size =</span> <span class="dv">4</span>,</span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>           <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Predicted vs Actual Bloom Day"</span>,</span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Actual Bloom DOY"</span>, <span class="at">y =</span> <span class="st">"Predicted Bloom DOY"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Not so shabby! Now lets examine the latent factors:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Latent Factor Interpretation</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Parse the projection matrix from the SPLS model</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>proj_mat <span class="ot">&lt;-</span> final_model<span class="sc">$</span>projection</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Each row name is in the form "temp_ave_pos_rollsum_123"</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>parsed <span class="ot">&lt;-</span> <span class="fu">str_match</span>(<span class="fu">rownames</span>(proj_mat), <span class="st">"^(.*)_(</span><span class="sc">\\</span><span class="st">d+)$"</span>)</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>group_names <span class="ot">&lt;-</span> parsed[, <span class="dv">2</span>]           <span class="co"># e.g., "temp_ave_pos_rollsum"</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>day_indices <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(parsed[, <span class="dv">3</span>])  <span class="co"># day number</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a data frame of loadings with associated group and day</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>df_proj <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(proj_mat)</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>df_proj<span class="sc">$</span>group <span class="ot">&lt;-</span> group_names</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>df_proj<span class="sc">$</span>day   <span class="ot">&lt;-</span> day_indices</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Rename factor columns for clarity</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>n_fac <span class="ot">&lt;-</span> <span class="fu">ncol</span>(proj_mat)</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(df_proj)[<span class="dv">1</span><span class="sc">:</span>n_fac] <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"Factor"</span>, <span class="fu">seq_len</span>(n_fac))</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Pivot the data to long format: each row becomes (group, day, factor, loading)</span></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>df_long <span class="ot">&lt;-</span> <span class="fu">pivot_longer</span>(df_proj, </span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>                        <span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">"Factor"</span>),</span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>                        <span class="at">names_to =</span> <span class="st">"factor"</span>,</span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>                        <span class="at">values_to =</span> <span class="st">"loading"</span>)</span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Build a complete grid for all groups, days (1:366), and factors</span></span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>all_groups <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"temp_ave_pos_rollsum"</span>, <span class="st">"temp_ave_neg_rollsum"</span>, </span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>                <span class="st">"temp_max_pos_rollsum"</span>, <span class="st">"temp_max_neg_rollsum"</span>, </span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>                <span class="st">"temp_min_pos_rollsum"</span>, <span class="st">"temp_min_neg_rollsum"</span>, </span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>                <span class="st">"prcp_pos_rollsum"</span>, <span class="st">"prcp_neg_rollsum"</span>)</span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>all_factors <span class="ot">&lt;-</span> <span class="fu">unique</span>(df_long<span class="sc">$</span>factor)</span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a>grid_df <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">group =</span> all_groups, <span class="at">day =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">366</span>, <span class="at">factor =</span> all_factors, </span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a>                       <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge grid with loadings to include missing combinations as NA</span></span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a>df_plot <span class="ot">&lt;-</span> <span class="fu">left_join</span>(grid_df, df_long, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"group"</span>, <span class="st">"day"</span>, <span class="st">"factor"</span>))</span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert day index to a date for plotting; day 1 corresponds to April 10</span></span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a>base_date <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(<span class="st">"2020-04-10"</span>)</span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a>df_plot<span class="sc">$</span>date <span class="ot">&lt;-</span> base_date <span class="sc">+</span> (df_plot<span class="sc">$</span>day <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract variable type and anomaly direction from group name</span></span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a>df_plot <span class="ot">&lt;-</span> df_plot <span class="sc">%&gt;%</span></span>
<span id="cb30-43"><a href="#cb30-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb30-44"><a href="#cb30-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="fu">gsub</span>(<span class="st">"_pos_rollsum.*|_neg_rollsum.*"</span>, <span class="st">""</span>, group),</span>
<span id="cb30-45"><a href="#cb30-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">anomaly =</span> <span class="fu">ifelse</span>(<span class="fu">grepl</span>(<span class="st">"_pos_"</span>, group), <span class="st">"pos"</span>, <span class="st">"neg"</span>)</span>
<span id="cb30-46"><a href="#cb30-46" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb30-47"><a href="#cb30-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">type =</span> <span class="fu">factor</span>(type, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"temp_min"</span>, <span class="st">"temp_ave"</span>, <span class="st">"temp_max"</span>, <span class="st">"prcp"</span>)),</span>
<span id="cb30-48"><a href="#cb30-48" aria-hidden="true" tabindex="-1"></a>         <span class="at">anomaly =</span> <span class="fu">factor</span>(anomaly, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"pos"</span>, <span class="st">"neg"</span>)))</span>
<span id="cb30-49"><a href="#cb30-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-50"><a href="#cb30-50" aria-hidden="true" tabindex="-1"></a><span class="co"># Heatmap of latent factor loadings</span></span>
<span id="cb30-51"><a href="#cb30-51" aria-hidden="true" tabindex="-1"></a>p_heatmap <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df_plot, <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> anomaly, <span class="at">fill =</span> loading)) <span class="sc">+</span></span>
<span id="cb30-52"><a href="#cb30-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_tile</span>() <span class="sc">+</span></span>
<span id="cb30-53"><a href="#cb30-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(type <span class="sc">~</span> factor) <span class="sc">+</span></span>
<span id="cb30-54"><a href="#cb30-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_date</span>(<span class="at">date_breaks =</span> <span class="st">"2 months"</span>, <span class="at">date_labels =</span> <span class="st">"%b"</span>) <span class="sc">+</span>  <span class="co"># Show every 2nd month</span></span>
<span id="cb30-55"><a href="#cb30-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_gradient2</span>(<span class="at">low =</span> <span class="st">"blue"</span>, <span class="at">mid =</span> <span class="st">"white"</span>, <span class="at">high =</span> <span class="st">"red"</span>, <span class="at">midpoint =</span> <span class="dv">0</span>, </span>
<span id="cb30-56"><a href="#cb30-56" aria-hidden="true" tabindex="-1"></a>                       <span class="at">na.value =</span> <span class="st">"grey90"</span>,</span>
<span id="cb30-57"><a href="#cb30-57" aria-hidden="true" tabindex="-1"></a>                       <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">label_number</span>(<span class="at">accuracy =</span> <span class="fl">0.0001</span>)) <span class="sc">+</span></span>
<span id="cb30-58"><a href="#cb30-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Heatmap of SPLS Loadings by Factor and Variable Type"</span>,</span>
<span id="cb30-59"><a href="#cb30-59" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Months"</span>, <span class="at">y =</span> <span class="st">"Anomaly (pos vs neg)"</span>, <span class="at">fill =</span> <span class="st">"Loading"</span>) <span class="sc">+</span></span>
<span id="cb30-60"><a href="#cb30-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>These factors summarize the original rolling sum predictors, showing clear patterns. Negative temperature anomalies accumulated before the median bloom date load negatively; since these sums are negative, a larger accumulation of cold days actually delays blooming. In contrast, higher rolling sums of positive temperature anomalies—indicating warmer days—load negatively, which means that more warm days speed up the bloom. Additionally, the model captures a dormancy effect: a buildup of cold days in October and November tends to lead to an earlier bloom the following year. Similarly, lower-than-average precipitation starting in December is associated with earlier blooming. This interpretation confirms that the latent factors meaningfully reflect the influence of weather on cherry blossom timing.</p>
<p>Now let’s examine how these latent factors cluster by location. Although our SPLS model was built on the combined dataset—ignoring that measurements come from five different sites with potentially different responses—I can still see some separation. For instance, the third latent factor reveals that different sites tend to occupy distinct regions in the factor space. This variability indicates that site-specific responses exist, which is why I ultimately use a generalized additive model (GAM) to flexibly capture these differences in our final analysis.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) Reshape data so each latent factor is in its own row</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>latent_long <span class="ot">&lt;-</span> latent_df <span class="sc">%&gt;%</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">"latent"</span>),  <span class="co"># or c("latent1", "latent2", "latent3")</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"factor"</span>,</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"score"</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) Create the scatter plot, facet by factor</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(latent_long, <span class="fu">aes</span>(<span class="at">x =</span> bloom_doy, <span class="at">y =</span> score, <span class="at">color =</span> location)) <span class="sc">+</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Use na.rm=TRUE so rows with NA in bloom_doy or score are simply not plotted</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Optional: add a smoothing trend line for each location</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># geom_smooth(method = "lm", se = FALSE, na.rm = TRUE)</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> factor, <span class="at">scales =</span> <span class="st">"free_y"</span>) <span class="sc">+</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Bloom Day vs. Latent Factor Scores"</span>,</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Bloom Day of Year"</span>,</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Latent Factor Score"</span>,</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Location"</span></span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(p)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Although our SPLS model was built on the combined dataset—ignoring that measurements come from five different sites with potentially different responses—I can still see some separation. For instance, the third latent factor reveals that different sites tend to occupy distinct regions in the factor space. This variability indicates that site-specific responses exist, which is why I ultimately use a generalized additive model (GAM) to flexibly capture these differences in our final analysis.</p>
</section>
<section id="dynamic-gam-modeling-for-forecasting" class="level3">
<h3 class="anchored" data-anchor-id="dynamic-gam-modeling-for-forecasting">11. Dynamic GAM Modeling for Forecasting</h3>
<p><strong>Dynamic GAM Modeling for Location-Specific Latent Factor Adaptation</strong></p>
<p>I now have three powerful latent factors from our SPLS analysis that capture the main weather patterns driving cherry blossom variability. However, these factors were derived as linear predictors from data pooled across all five locations, assuming each site responds identically to the same weather patterns.</p>
<p><strong>The problem:</strong>&nbsp;Real cherry trees don’t follow universal rules. Each location likely has its own unique sensitivity to weather - Kyoto’s cherry blossoms might respond differently to warming than Vancouver’s, and some locations have frustratingly sparse observations that make traditional modeling challenging.</p>
<p><strong>The approach:</strong>&nbsp;So I decided to go with <code>mvgam</code> <span class="citation" data-cites="mvgam">(<a href="#ref-mvgam" role="doc-biblioref">Clark and Wells 2023</a>)</span>. <code>mvgam</code> stands for MultiVariate (Dynamic) Generalized Additive Models and is specifically designed for time series analysis like ours:</p>
<ol type="1">
<li><p><strong>Time series focus</strong>: Specifically designed for time series prediction with built-in capabilities to model autocorrelation if needed.</p></li>
<li><p><strong>GAM flexibility</strong>: At its core, it’s still a GAM, making it ideal for bending our otherwise linear latent factors to each location individually.</p></li>
<li><p><strong>State-space robustness</strong>: The state-space modeling framework is perfect for time series with missing observations. It models the underlying bloom process separately from the observations, so our sparse New York and Vancouver data doesn’t break the model—missing data areas handled by modeling the latent bloom process as it evolves through time.</p></li>
<li><p><strong>Bayesian uncertainty</strong>: The Bayesian framework provides natural uncertainty quantification for both parameters and predictions.</p></li>
</ol>
<p><strong>Data preparation and model setup</strong></p>
<p>First, I split my data into training and testing sets at 2024 to ensure at least one bloom date for each location in our forecast evaluation. For state-space modeling, I need both&nbsp;<code>series</code>&nbsp;(to identify different time series) and&nbsp;<code>trend</code>&nbsp;(for the process formula) variables.</p>
<p>My model structure uses shrinkage smooths (<code>bs="sz"</code>) to handle the location-specific responses. For example,&nbsp;<code>s(latent1, k=3)</code>&nbsp;creates the main smooth effect of latent1, while&nbsp;<code>s(trend, latent1, bs="sz", k=3)</code>&nbsp;adds location-specific deviations. The “sz” basis applies shrinkage - locations with sparse data have their specific effects shrunk toward zero, essentially borrowing the response pattern from data-rich locations. Meanwhile, Kyoto and others with complete records can maintain their unique response curves.</p>
<p>Let’s prepare the data and fit the model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> latent_df</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>location <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df<span class="sc">$</span>location)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>series <span class="ot">&lt;-</span> df<span class="sc">$</span>location  <span class="co"># Keep series for identifying time series</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>trend <span class="ot">&lt;-</span> df<span class="sc">$</span>location   <span class="co"># Add trend for trend_formula</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>time <span class="ot">&lt;-</span> df<span class="sc">$</span>cherry_year <span class="sc">-</span> <span class="dv">1981</span> <span class="co">#For numerical stability</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Split data into training (&lt;2024) and testing (&gt;=2024)</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>train_mvgam <span class="ot">&lt;-</span> df[df<span class="sc">$</span>cherry_year <span class="sc">&lt;</span> <span class="dv">2024</span>, ]</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>test_mvgam  <span class="ot">&lt;-</span> df[df<span class="sc">$</span>cherry_year <span class="sc">&gt;=</span> <span class="dv">2024</span>, ]</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Now fit with tweaked priors</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>model_gaussian <span class="ot">&lt;-</span> <span class="fu">mvgam</span>(<span class="at">formula =</span> bloom_doy <span class="sc">~</span> series,</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>                     <span class="at">trend_formula =</span> <span class="sc">~</span> <span class="fu">s</span>(latent1, <span class="at">k=</span><span class="dv">3</span>) <span class="sc">+</span> <span class="fu">s</span>(trend, latent1, <span class="at">bs=</span><span class="st">"sz"</span>,<span class="at">k=</span><span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">s</span>(latent2, <span class="at">k=</span><span class="dv">3</span>) <span class="sc">+</span> <span class="fu">s</span>(trend, latent2, <span class="at">bs=</span><span class="st">"sz"</span>,<span class="at">k=</span><span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">s</span>(latent3, <span class="at">k=</span><span class="dv">3</span>) <span class="sc">+</span> <span class="fu">s</span>(trend, latent3, <span class="at">bs=</span><span class="st">"sz"</span>,<span class="at">k=</span><span class="dv">3</span>),</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>                     <span class="at">data =</span> train_mvgam,</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>                     <span class="at">newdata =</span> test_mvgam,</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>                     <span class="at">noncentred =</span> <span class="cn">TRUE</span>,</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>                     <span class="at">family =</span> <span class="fu">gaussian</span>(),<span class="at">silent =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s examine the model diagnostics:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_gaussian, <span class="at">include_betas =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>GAM observation formula:
bloom_doy ~ series

GAM process formula:
~s(latent1, k = 3) + s(trend, latent1, bs = "sz", k = 3) + s(latent2, 
    k = 3) + s(trend, latent2, bs = "sz", k = 3) + s(latent3, 
    k = 3) + s(trend, latent3, bs = "sz", k = 3)

Family:
gaussian

Link function:
identity

Trend model:
None

N process models:
5 

N series:
5 

N timepoints:
45 

Status:
Fitted using Stan 
4 chains, each with iter = 1000; warmup = 500; thin = 1 
Total post-warmup draws = 2000


Observation error parameter estimates:
             2.5%  50% 97.5% Rhat n_eff
sigma_obs[1] 0.91 2.30   3.0 1.05    61
sigma_obs[2] 2.30 3.50   4.7 1.01   350
sigma_obs[3] 5.70 8.30  14.0 1.00  1538
sigma_obs[4] 0.15 0.95   5.7 1.01   591
sigma_obs[5] 1.10 3.40   4.4 1.09    45

GAM observation model coefficient (beta) estimates:
                                   2.5%   50% 97.5% Rhat n_eff
(Intercept)                        88.0 94.00  99.0    1  1148
seriesLiestal-Weideli, Switzerland -4.8 -1.70   1.1    1   956
seriesNew York, USA                -2.6  0.81   4.9    1  1569
seriesVancouver, Canada            -4.4 -1.40   1.7    1   844
seriesWashington DC, USA           -5.5 -1.70   2.0    1  1339

Process error parameter estimates:
           2.5%  50% 97.5% Rhat n_eff
sigma[1] 0.0160 0.38   2.1 1.05    71
sigma[2] 0.0180 0.41   2.4 1.01   292
sigma[3] 0.0092 0.34   2.0 1.00  2775
sigma[4] 0.0160 0.48   2.1 1.00  1250
sigma[5] 0.0140 0.43   3.2 1.11    40

GAM process model coefficient (beta) estimates:
                  2.5%   50% 97.5% Rhat n_eff
(Intercept)_trend -5.1 0.076   5.5    1  1396

Approximate significance of GAM process smooths:
                   edf Ref.df  Chi.sq p-value    
s(latent1)        1.01      2 4706.30 &lt; 2e-16 ***
s(series,latent1) 7.61     12  128.89    0.36    
s(latent2)        1.02      2  638.76 &lt; 2e-16 ***
s(series,latent2) 3.31     12    1.97    1.00    
s(latent3)        1.01      2  291.30 1.7e-05 ***
s(series,latent3) 1.59     12    1.37    1.00    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Stan MCMC diagnostics:
✔ No issues with effective samples per iteration
✖ Rhats above 1.05 found for some parameters
    Use pairs() and mcmc_plot() to investigate
✖ 105 of 2000 iterations ended with a divergence (5.25%)
    Try a larger adapt_delta to remove divergences
✔ No issues with maximum tree depth

Samples were drawn using sampling(hmc). For each parameter, n_eff is a
  crude measure of effective sample size, and Rhat is the potential scale
  reduction factor on split MCMC chains (at convergence, Rhat = 1)

Use how_to_cite() to get started describing this model</code></pre>
</div>
</div>
<p>The model shows severe convergence issues. Several variance parameters (sigmas) from both the observation and process models are poorly identified, with terrible effective sample sizes and Rhat values. Let me unpack what’s happening here. In our state-space formulation:</p>
<p>The baseline: Without weather effects, each location would bloom on roughly the same day every year (captured by the location intercepts) The process model: Our SPLS-derived latent factors predict deviations from this baseline. The process error represents additional year-to-year variation not captured by weather - perhaps soil conditions, tree age, or other unmeasured factors The observation model: This is where bloom dates actually get recorded. The observation error represents how much our weather-based predictions miss the true bloom dates</p>
<p>The identifiability crisis occurs because the model can explain the same bloom variability in multiple ways. High process error + low observation error? Low process error + high observation error? Without constraints, the model can’t decide. Here’s the key insight: Our SPLS model achieved good R² and MAE when fitted on pooled data from all locations. This means it captures the “average” weather-bloom relationship well, but likely misses location-specific nuances by roughly the same amount everywhere. The observation error is essentially quantifying “how wrong is our one-size-fits-all weather model?” By setting share_obs_params = TRUE, I enforce this logic: all locations share the same observation variance because they all use the same pooled SPLS model. This constraint breaks the identifiability problem while still allowing location-specific process errors to capture unique temporal patterns. Additionally, with 19% of iterations ending in divergences, I’ll increase adapt_delta to 0.99, max_treedepth to 12, and number of iterations for more careful exploration of the posterior:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>model_shared_sz <span class="ot">&lt;-</span> <span class="fu">mvgam</span>(<span class="at">formula =</span> bloom_doy <span class="sc">~</span> series,</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>                       <span class="at">trend_formula =</span> <span class="sc">~</span> <span class="fu">s</span>(latent1, <span class="at">k=</span><span class="dv">3</span>) <span class="sc">+</span> <span class="fu">s</span>(trend, latent1, <span class="at">bs=</span><span class="st">"sz"</span>,<span class="at">k=</span><span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">s</span>(latent2, <span class="at">k=</span><span class="dv">3</span>) <span class="sc">+</span> <span class="fu">s</span>(trend, latent2, <span class="at">bs=</span><span class="st">"sz"</span>,<span class="at">k=</span><span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">s</span>(latent3, <span class="at">k=</span><span class="dv">3</span>) <span class="sc">+</span> <span class="fu">s</span>(trend, latent3, <span class="at">bs=</span><span class="st">"sz"</span>,<span class="at">k=</span><span class="dv">3</span>),</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>                     <span class="at">data =</span> train_mvgam,</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>                     <span class="at">newdata =</span> test_mvgam,</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>                     <span class="at">share_obs_params =</span> <span class="cn">TRUE</span>,</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>                     <span class="at">noncentred =</span> <span class="cn">TRUE</span>,</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>                     <span class="at">control =</span> <span class="fu">list</span>(<span class="at">adapt_delta =</span> <span class="fl">0.99</span>, <span class="at">max_treedepth =</span> <span class="dv">12</span>),</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>                     <span class="at">burnin =</span> <span class="dv">500</span>,</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>                     <span class="at">samples =</span> <span class="dv">2000</span>,</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>                     <span class="at">family =</span> <span class="fu">gaussian</span>(),<span class="at">silent =</span> <span class="dv">2</span>)</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_shared_sz, <span class="at">include_betas =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>GAM observation formula:
bloom_doy ~ series

GAM process formula:
~s(latent1, k = 3) + s(trend, latent1, bs = "sz", k = 3) + s(latent2, 
    k = 3) + s(trend, latent2, bs = "sz", k = 3) + s(latent3, 
    k = 3) + s(trend, latent3, bs = "sz", k = 3)

Family:
gaussian

Link function:
identity

Trend model:
None

N process models:
5 

N series:
5 

N timepoints:
45 

Status:
Fitted using Stan 
4 chains, each with iter = 2500; warmup = 500; thin = 1 
Total post-warmup draws = 8000


Observation error parameter estimates:
          2.5% 50% 97.5% Rhat n_eff
sigma_obs  2.7 3.2   3.8    1   846

GAM observation model coefficient (beta) estimates:
                                   2.5%   50% 97.5% Rhat n_eff
(Intercept)                        88.0 94.00  99.0    1  2749
seriesLiestal-Weideli, Switzerland -5.1 -1.60   1.5    1  3642
seriesNew York, USA                -2.5  0.74   4.3    1  3997
seriesVancouver, Canada            -4.8 -0.90   2.5    1  6999
seriesWashington DC, USA           -5.8 -1.30   2.7    1  3233

Process error parameter estimates:
           2.5%  50% 97.5% Rhat n_eff
sigma[1] 0.0098 0.25   1.1    1  7133
sigma[2] 0.0170 0.43   2.1    1  1938
sigma[3] 0.5900 4.40   6.7    1   424
sigma[4] 0.0120 0.34   1.8    1 12251
sigma[5] 0.0130 0.41   2.0    1  2242

GAM process model coefficient (beta) estimates:
                  2.5%   50% 97.5% Rhat n_eff
(Intercept)_trend -5.4 0.045   5.2    1  3020

Approximate significance of GAM process smooths:
                    edf Ref.df  Chi.sq p-value    
s(latent1)        1.009      2 4027.93 &lt; 2e-16 ***
s(series,latent1) 7.792     12  233.66    0.12    
s(latent2)        1.082      2  635.27 &lt; 2e-16 ***
s(series,latent2) 3.099     12    2.42    1.00    
s(latent3)        0.999      2  296.04 3.4e-05 ***
s(series,latent3) 2.233     12    1.09    1.00    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Stan MCMC diagnostics:
✔ No issues with effective samples per iteration
✔ Rhat looks good for all parameters
✔ No issues with divergences
✔ No issues with maximum tree depth

Samples were drawn using sampling(hmc). For each parameter, n_eff is a
  crude measure of effective sample size, and Rhat is the potential scale
  reduction factor on split MCMC chains (at convergence, Rhat = 1)

Use how_to_cite() to get started describing this model</code></pre>
</div>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>gratia<span class="sc">::</span><span class="fu">draw</span>(model_shared_sz, <span class="at">trend_effects=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
<p>The enhanced sampling and shared observation parameters completely fixed our convergence issues. All parameters now have excellent effective sample sizes and Rhat values of 1.00. The shared observation error settled at about 3.2 days (pretty much as MAE of joint SPLS model) - this represents how much our weather-based predictions typically miss the actual bloom dates. Looking at the smooth effects, the main patterns are beautifully linear, exactly as expected from our SPLS-derived factors. Each latent factor shows a strong linear relationship with bloom timing (all p &lt; 0.001). The location-specific deviations (s(series,latent) terms) aren’t statistically significant, which isn’t surprising given our limited data. However, they still capture subtle location-specific responses that contribute to more accurate predictions.</p>
<p>So lets now run predictions for 2025 and compare with real data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Forecast</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>fc <span class="ot">&lt;-</span> <span class="fu">forecast</span>(model_shared_sz, test_mvgam)</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Map full location names to short names for predictions</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>location_mapping <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Kyoto, Japan"</span>                <span class="ot">=</span> <span class="st">"kyoto"</span>,</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Liestal-Weideli, Switzerland"</span> <span class="ot">=</span> <span class="st">"liestal"</span>,</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">"New York, USA"</span>               <span class="ot">=</span> <span class="st">"newyorkcity"</span>,</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Vancouver, Canada"</span>           <span class="ot">=</span> <span class="st">"vancouver"</span>,</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Washington DC, USA"</span>          <span class="ot">=</span> <span class="st">"washingtondc"</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Create dataframe with actual 2025 bloom dates</span></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>actual_2025 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">location =</span> <span class="fu">c</span>(<span class="st">"liestal"</span>, <span class="st">"vancouver"</span>, <span class="st">"kyoto"</span>, <span class="st">"washingtondc"</span>, <span class="st">"newyorkcity"</span>),</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">actual_date =</span> <span class="fu">as.Date</span>(<span class="fu">c</span>(<span class="st">"2025-03-27"</span>, <span class="st">"2025-04-03"</span>, <span class="st">"2025-04-04"</span>, <span class="st">"2025-03-28"</span>, <span class="st">"2025-04-04"</span>)),</span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">actual_doy =</span> <span class="fu">c</span>(<span class="dv">86</span>, <span class="dv">93</span>, <span class="dv">94</span>, <span class="dv">87</span>, <span class="dv">94</span>),</span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span></span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract posterior draws for all locations</span></span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a>posterior_draws <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(fc<span class="sc">$</span>series_names)) {</span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a>  full_name <span class="ot">&lt;-</span> <span class="fu">as.character</span>(fc<span class="sc">$</span>series_names[i])</span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a>  short_name <span class="ot">&lt;-</span> location_mapping[full_name]</span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a>  posterior_draws[[short_name]] <span class="ot">&lt;-</span> fc<span class="sc">$</span>forecasts[[i]][, <span class="dv">2</span>]  <span class="co"># 2025 predictions</span></span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to long format for plotting</span></span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a>draws_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">value =</span> <span class="fu">unlist</span>(posterior_draws),</span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a>  <span class="at">location =</span> <span class="fu">rep</span>(<span class="fu">names</span>(posterior_draws), <span class="at">each =</span> <span class="fu">length</span>(posterior_draws[[<span class="dv">1</span>]]))</span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-35"><a href="#cb38-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Add actual values</span></span>
<span id="cb38-36"><a href="#cb38-36" aria-hidden="true" tabindex="-1"></a>draws_df <span class="ot">&lt;-</span> <span class="fu">merge</span>(draws_df, actual_2025[, <span class="fu">c</span>(<span class="st">"location"</span>, <span class="st">"actual_doy"</span>)], <span class="at">by =</span> <span class="st">"location"</span>, <span class="at">all.x =</span> <span class="cn">TRUE</span>)</span>
<span id="cb38-37"><a href="#cb38-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-38"><a href="#cb38-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Add proper location names</span></span>
<span id="cb38-39"><a href="#cb38-39" aria-hidden="true" tabindex="-1"></a>draws_df<span class="sc">$</span>location_full <span class="ot">&lt;-</span> <span class="fu">factor</span>(draws_df<span class="sc">$</span>location, </span>
<span id="cb38-40"><a href="#cb38-40" aria-hidden="true" tabindex="-1"></a>  <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"kyoto"</span>, <span class="st">"liestal"</span>, <span class="st">"newyorkcity"</span>, <span class="st">"vancouver"</span>, <span class="st">"washingtondc"</span>),</span>
<span id="cb38-41"><a href="#cb38-41" aria-hidden="true" tabindex="-1"></a>  <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Kyoto, Japan"</span>, </span>
<span id="cb38-42"><a href="#cb38-42" aria-hidden="true" tabindex="-1"></a>             <span class="st">"Liestal, Switzerland"</span>, </span>
<span id="cb38-43"><a href="#cb38-43" aria-hidden="true" tabindex="-1"></a>             <span class="st">"New York City, USA"</span>, </span>
<span id="cb38-44"><a href="#cb38-44" aria-hidden="true" tabindex="-1"></a>             <span class="st">"Vancouver, Canada"</span>, </span>
<span id="cb38-45"><a href="#cb38-45" aria-hidden="true" tabindex="-1"></a>             <span class="st">"Washington DC, USA"</span>))</span>
<span id="cb38-46"><a href="#cb38-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-47"><a href="#cb38-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate summary statistics with rounded differences</span></span>
<span id="cb38-48"><a href="#cb38-48" aria-hidden="true" tabindex="-1"></a>summary_stats <span class="ot">&lt;-</span> draws_df <span class="sc">%&gt;%</span></span>
<span id="cb38-49"><a href="#cb38-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(location_full, actual_doy) <span class="sc">%&gt;%</span></span>
<span id="cb38-50"><a href="#cb38-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb38-51"><a href="#cb38-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">median_pred =</span> <span class="fu">median</span>(value),</span>
<span id="cb38-52"><a href="#cb38-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_pred =</span> <span class="fu">mean</span>(value),</span>
<span id="cb38-53"><a href="#cb38-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">'drop'</span></span>
<span id="cb38-54"><a href="#cb38-54" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb38-55"><a href="#cb38-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb38-56"><a href="#cb38-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">diff =</span> <span class="fu">round</span>(median_pred <span class="sc">-</span> actual_doy, <span class="dv">0</span>),</span>
<span id="cb38-57"><a href="#cb38-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">diff_text =</span> <span class="fu">case_when</span>(</span>
<span id="cb38-58"><a href="#cb38-58" aria-hidden="true" tabindex="-1"></a>      diff <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="fu">paste0</span>(<span class="st">"+"</span>, diff, <span class="st">" days"</span>),</span>
<span id="cb38-59"><a href="#cb38-59" aria-hidden="true" tabindex="-1"></a>      diff <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="fu">paste0</span>(diff, <span class="st">" days"</span>),</span>
<span id="cb38-60"><a href="#cb38-60" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Perfect!"</span></span>
<span id="cb38-61"><a href="#cb38-61" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb38-62"><a href="#cb38-62" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb38-63"><a href="#cb38-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-64"><a href="#cb38-64" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the plot</span></span>
<span id="cb38-65"><a href="#cb38-65" aria-hidden="true" tabindex="-1"></a>p_presentation <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb38-66"><a href="#cb38-66" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Density plots</span></span>
<span id="cb38-67"><a href="#cb38-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">data =</span> draws_df, </span>
<span id="cb38-68"><a href="#cb38-68" aria-hidden="true" tabindex="-1"></a>               <span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">fill =</span> location_full), </span>
<span id="cb38-69"><a href="#cb38-69" aria-hidden="true" tabindex="-1"></a>               <span class="at">alpha =</span> <span class="fl">0.8</span>,</span>
<span id="cb38-70"><a href="#cb38-70" aria-hidden="true" tabindex="-1"></a>               <span class="at">color =</span> <span class="st">"white"</span>,</span>
<span id="cb38-71"><a href="#cb38-71" aria-hidden="true" tabindex="-1"></a>               <span class="at">linewidth =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb38-72"><a href="#cb38-72" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-73"><a href="#cb38-73" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Actual date lines</span></span>
<span id="cb38-74"><a href="#cb38-74" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(<span class="at">data =</span> summary_stats,</span>
<span id="cb38-75"><a href="#cb38-75" aria-hidden="true" tabindex="-1"></a>               <span class="fu">aes</span>(<span class="at">x =</span> actual_doy, <span class="at">xend =</span> actual_doy, <span class="at">y =</span> <span class="dv">0</span>, <span class="at">yend =</span> <span class="cn">Inf</span>),</span>
<span id="cb38-76"><a href="#cb38-76" aria-hidden="true" tabindex="-1"></a>               <span class="at">color =</span> <span class="st">"black"</span>, </span>
<span id="cb38-77"><a href="#cb38-77" aria-hidden="true" tabindex="-1"></a>               <span class="at">linewidth =</span> <span class="fl">1.5</span>,</span>
<span id="cb38-78"><a href="#cb38-78" aria-hidden="true" tabindex="-1"></a>               <span class="at">linetype =</span> <span class="st">"solid"</span>) <span class="sc">+</span></span>
<span id="cb38-79"><a href="#cb38-79" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-80"><a href="#cb38-80" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Error labels</span></span>
<span id="cb38-81"><a href="#cb38-81" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_label</span>(<span class="at">data =</span> summary_stats,</span>
<span id="cb38-82"><a href="#cb38-82" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">x =</span> actual_doy <span class="sc">+</span> <span class="dv">2</span>, <span class="at">y =</span> <span class="cn">Inf</span>, </span>
<span id="cb38-83"><a href="#cb38-83" aria-hidden="true" tabindex="-1"></a>                 <span class="at">label =</span> <span class="fu">ifelse</span>(diff <span class="sc">==</span> <span class="dv">0</span>, <span class="st">"Spot on!"</span>, diff_text)),</span>
<span id="cb38-84"><a href="#cb38-84" aria-hidden="true" tabindex="-1"></a>             <span class="at">vjust =</span> <span class="fl">1.5</span>,</span>
<span id="cb38-85"><a href="#cb38-85" aria-hidden="true" tabindex="-1"></a>             <span class="at">size =</span> <span class="dv">3</span>,</span>
<span id="cb38-86"><a href="#cb38-86" aria-hidden="true" tabindex="-1"></a>             <span class="at">fontface =</span> <span class="st">"bold"</span>,</span>
<span id="cb38-87"><a href="#cb38-87" aria-hidden="true" tabindex="-1"></a>             <span class="at">fill =</span> <span class="st">"white"</span>,</span>
<span id="cb38-88"><a href="#cb38-88" aria-hidden="true" tabindex="-1"></a>             <span class="at">alpha =</span> <span class="fl">0.9</span>,</span>
<span id="cb38-89"><a href="#cb38-89" aria-hidden="true" tabindex="-1"></a>             <span class="at">label.padding =</span> <span class="fu">unit</span>(<span class="fl">0.25</span>, <span class="st">"lines"</span>),</span>
<span id="cb38-90"><a href="#cb38-90" aria-hidden="true" tabindex="-1"></a>             <span class="at">label.size =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb38-91"><a href="#cb38-91" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-92"><a href="#cb38-92" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> location_full, <span class="at">scales =</span> <span class="st">"free_y"</span>, <span class="at">nrow =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb38-93"><a href="#cb38-93" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#2E7D32"</span>, <span class="st">"#1976D2"</span>, <span class="st">"#D32F2F"</span>, <span class="st">"#7B1FA2"</span>, <span class="st">"#F57C00"</span>)) <span class="sc">+</span></span>
<span id="cb38-94"><a href="#cb38-94" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">78</span>, <span class="dv">112</span>)) <span class="sc">+</span>  <span class="co"># This prevents cutting off distributions</span></span>
<span id="cb38-95"><a href="#cb38-95" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">80</span>, <span class="dv">110</span>, <span class="at">by =</span> <span class="dv">10</span>)) <span class="sc">+</span></span>
<span id="cb38-96"><a href="#cb38-96" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-97"><a href="#cb38-97" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"2025 Cherry Blossom Predictions vs Reality"</span>,</span>
<span id="cb38-98"><a href="#cb38-98" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Day of Year (vertical line = actual bloom date)"</span>,</span>
<span id="cb38-99"><a href="#cb38-99" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb38-100"><a href="#cb38-100" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-101"><a href="#cb38-101" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb38-102"><a href="#cb38-102" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb38-103"><a href="#cb38-103" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"none"</span>,</span>
<span id="cb38-104"><a href="#cb38-104" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">16</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb38-105"><a href="#cb38-105" aria-hidden="true" tabindex="-1"></a>    <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb38-106"><a href="#cb38-106" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb38-107"><a href="#cb38-107" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>),</span>
<span id="cb38-108"><a href="#cb38-108" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb38-109"><a href="#cb38-109" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.spacing =</span> <span class="fu">unit</span>(<span class="fl">0.5</span>, <span class="st">"lines"</span>),</span>
<span id="cb38-110"><a href="#cb38-110" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.margin =</span> <span class="fu">margin</span>(<span class="dv">15</span>, <span class="dv">15</span>, <span class="dv">15</span>, <span class="dv">15</span>)</span>
<span id="cb38-111"><a href="#cb38-111" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb38-112"><a href="#cb38-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-113"><a href="#cb38-113" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the plot</span></span>
<span id="cb38-114"><a href="#cb38-114" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(p_presentation)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
<p>Two perfect predictions (Kyoto and Vancouver), and the rest within a week - not bad for a model predicting a complex biological phenomenon months in advance. What started as a challenge to predict cherry blossoms using weather anomalies has demonstrated the power of combining dimensional reduction (SPLS) with flexible modeling (mvgam). The approach successfully handled the twin challenges of high-dimensional weather data and sparse observations, delivering predictions with well-calibrated uncertainty. Most satisfying is that the locations with the least data (New York and Vancouver) performed just as well as data-rich sites - proof that our shrinkage approach effectively borrowed strength across locations. Cherry trees may not follow universal rules, but with the right modeling framework, I can still capture their unique responses to weather patterns</p>
<div class="cell">
<div class="cell-output-display">
<p>We used R version 4.5.1 <span class="citation" data-cites="base">(<a href="#ref-base" role="doc-biblioref">R Core Team 2025</a>)</span> and the following R packages: data.table v. 1.17.6 <span class="citation" data-cites="datatable">(<a href="#ref-datatable" role="doc-biblioref">Barrett et al. 2025</a>)</span>, gratia v. 0.10.0 <span class="citation" data-cites="gratia">(<a href="#ref-gratia" role="doc-biblioref">Simpson 2024</a>)</span>, missForest v. 1.5 <span class="citation" data-cites="missForest2012 missForest2022">(<a href="#ref-missForest2012" role="doc-biblioref">Stekhoven and Buehlmann 2012</a>; <a href="#ref-missForest2022" role="doc-biblioref">Stekhoven 2022</a>)</span>, mvgam v. 1.1.51 <span class="citation" data-cites="mvgam">(<a href="#ref-mvgam" role="doc-biblioref">Clark and Wells 2023</a>)</span>, nasapower v. 4.2.5 <span class="citation" data-cites="nasapower">(<a href="#ref-nasapower" role="doc-biblioref">Sparks 2018</a>)</span>, rmarkdown v. 2.29 <span class="citation" data-cites="rmarkdown2018 rmarkdown2020 rmarkdown2024">(<a href="#ref-rmarkdown2018" role="doc-biblioref">Xie, Allaire, and Grolemund 2018</a>; <a href="#ref-rmarkdown2020" role="doc-biblioref">Xie, Dervieux, and Riederer 2020</a>; <a href="#ref-rmarkdown2024" role="doc-biblioref">Allaire et al. 2024</a>)</span>, scales v. 1.4.0 <span class="citation" data-cites="scales">(<a href="#ref-scales" role="doc-biblioref">Wickham, Pedersen, and Seidel 2025</a>)</span>, spls v. 2.2.3 <span class="citation" data-cites="spls">(<a href="#ref-spls" role="doc-biblioref">Chung, Chun, and Keles 2019</a>)</span>, tidyverse v. 2.0.0 <span class="citation" data-cites="tidyverse">(<a href="#ref-tidyverse" role="doc-biblioref">Wickham et al. 2019</a>)</span>.</p>
</div>
</div>



</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-rmarkdown2024" class="csl-entry" role="listitem">
Allaire, JJ, Yihui Xie, Christophe Dervieux, Jonathan McPherson, Javier Luraschi, Kevin Ushey, Aron Atkins, et al. 2024. <em><span class="nocase">rmarkdown</span>: Dynamic Documents for r</em>. <a href="https://github.com/rstudio/rmarkdown">https://github.com/rstudio/rmarkdown</a>.
</div>
<div id="ref-datatable" class="csl-entry" role="listitem">
Barrett, Tyson, Matt Dowle, Arun Srinivasan, Jan Gorecki, Michael Chirico, Toby Hocking, Benjamin Schwendinger, and Ivan Krylov. 2025. <em><span class="nocase">data.table</span>: Extension of <span>“<span class="nocase">data.frame</span>”</span></em>. <a href="https://doi.org/10.32614/CRAN.package.data.table">https://doi.org/10.32614/CRAN.package.data.table</a>.
</div>
<div id="ref-spls" class="csl-entry" role="listitem">
Chung, Dongjun, Hyonho Chun, and Sunduz Keles. 2019. <em><span class="nocase">spls</span>: Sparse Partial Least Squares (SPLS) Regression and Classification</em>. <a href="https://doi.org/10.32614/CRAN.package.spls">https://doi.org/10.32614/CRAN.package.spls</a>.
</div>
<div id="ref-mvgam" class="csl-entry" role="listitem">
Clark, Nicholas J, and Konstans Wells. 2023. <span>“Dynamic Generalized Additive Models (DGAMs) for Forecasting Discrete Ecological Time Series.”</span> <em>Methods in Ecology and Evolution</em> 14: 771–84. <a href="https://doi.org/10.18637/jss.v100.i05">https://doi.org/10.18637/jss.v100.i05</a>.
</div>
<div id="ref-base" class="csl-entry" role="listitem">
R Core Team. 2025. <em><span>R</span>: A Language and Environment for Statistical Computing</em>. Vienna, Austria: R Foundation for Statistical Computing. <a href="https://www.R-project.org/">https://www.R-project.org/</a>.
</div>
<div id="ref-gratia" class="csl-entry" role="listitem">
Simpson, Gavin L. 2024. <em><span class="nocase">gratia</span>: Graceful <span class="nocase">ggplot</span>-Based Graphics and Other Functions for <span>GAM</span>s Fitted Using <span class="nocase">mgcv</span></em>. <a href="https://gavinsimpson.github.io/gratia/">https://gavinsimpson.github.io/gratia/</a>.
</div>
<div id="ref-nasapower" class="csl-entry" role="listitem">
Sparks, Adam H. 2018. <span>“<span class="nocase">nasapower</span>: A NASA POWER Global Meteorology, Surface Solar Energy and Climatology Data Client for r.”</span> <em>The Journal of Open Source Software</em> 3 (30): 1035. <a href="https://doi.org/10.21105/joss.01035">https://doi.org/10.21105/joss.01035</a>.
</div>
<div id="ref-missForest2022" class="csl-entry" role="listitem">
Stekhoven, Daniel J. 2022. <em><span class="nocase">missForest</span>: Nonparametric Missing Value Imputation Using Random Forest</em>.
</div>
<div id="ref-missForest2012" class="csl-entry" role="listitem">
Stekhoven, Daniel J., and Peter Buehlmann. 2012. <span>“MissForest - Non-Parametric Missing Value Imputation for Mixed-Type Data.”</span> <em>Bioinformatics</em> 28 (1): 112–18.
</div>
<div id="ref-tidyverse" class="csl-entry" role="listitem">
Wickham, Hadley, Mara Averick, Jennifer Bryan, Winston Chang, Lucy D’Agostino McGowan, Romain François, Garrett Grolemund, et al. 2019. <span>“Welcome to the <span class="nocase">tidyverse</span>.”</span> <em>Journal of Open Source Software</em> 4 (43): 1686. <a href="https://doi.org/10.21105/joss.01686">https://doi.org/10.21105/joss.01686</a>.
</div>
<div id="ref-scales" class="csl-entry" role="listitem">
Wickham, Hadley, Thomas Lin Pedersen, and Dana Seidel. 2025. <em><span class="nocase">scales</span>: Scale Functions for Visualization</em>. <a href="https://doi.org/10.32614/CRAN.package.scales">https://doi.org/10.32614/CRAN.package.scales</a>.
</div>
<div id="ref-rmarkdown2018" class="csl-entry" role="listitem">
Xie, Yihui, J. J. Allaire, and Garrett Grolemund. 2018. <em>R Markdown: The Definitive Guide</em>. Boca Raton, Florida: Chapman; Hall/CRC. <a href="https://bookdown.org/yihui/rmarkdown">https://bookdown.org/yihui/rmarkdown</a>.
</div>
<div id="ref-rmarkdown2020" class="csl-entry" role="listitem">
Xie, Yihui, Christophe Dervieux, and Emily Riederer. 2020. <em>R Markdown Cookbook</em>. Boca Raton, Florida: Chapman; Hall/CRC. <a href="https://bookdown.org/yihui/rmarkdown-cookbook">https://bookdown.org/yihui/rmarkdown-cookbook</a>.
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/jbogomolovas2\.github\.io\/Julius-s-Blog\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>